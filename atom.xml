<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>uiste</title>
  <icon>https://www.gravatar.com/avatar/56992660d6f2c687a02a62364e5b9baf</icon>
  <subtitle>uiste</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.uiste.com/"/>
  <updated>2018-11-02T07:58:06.000Z</updated>
  <id>http://blog.uiste.com/</id>
  
  <author>
    <name>uiste</name>
    <email>hi@uiste.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Mac 配置ssh 免密登录</title>
    <link href="http://blog.uiste.com/2018/20181102-3.html"/>
    <id>http://blog.uiste.com/2018/20181102-3.html</id>
    <published>2018-11-02T07:49:00.000Z</published>
    <updated>2018-11-02T07:58:06.000Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 配置ssh</span><br><span class="line">~ vim ~/.ssh/config</span><br><span class="line"></span><br><span class="line">Host *</span><br><span class="line">    ServerAliveInterval 10</span><br><span class="line"></span><br><span class="line">Host Mweb1</span><br><span class="line">    HostName        服务器IP地址</span><br><span class="line">    Port            端口</span><br><span class="line">    User            用户名</span><br><span class="line">    IdentityFile    私钥地址</span><br><span class="line"></span><br><span class="line">Host Mweb2</span><br><span class="line">    HostName        服务器IP地址</span><br><span class="line">    Port            22</span><br><span class="line">    User            uiste</span><br><span class="line">    IdentityFile    ~/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"># 登录方式</span><br><span class="line">➜  ~ ssh Mweb1</span><br><span class="line">Last login: Fri Nov  2 08:15:51 2018 from 180.173.83.33</span><br><span class="line">[root@VM_0_6_centos ~]#</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Mac配置远程服务器隧道代理</title>
    <link href="http://blog.uiste.com/2018/20181102-2.html"/>
    <id>http://blog.uiste.com/2018/20181102-2.html</id>
    <published>2018-11-02T07:44:54.000Z</published>
    <updated>2018-11-03T00:13:03.743Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>因为安全原因远程服务器的数据库不允许本地直接访问，又没有开启访问IP白名单时，可以通过隧道代理访问。Windows系统通过xsheel可以设置隧道代理。Mac只需要运行如下命令</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 22  -i ~/.ssh/id_rsa -fNL 代理端口:代理IP:转发原端口 用户名@远程服务器IP</span><br><span class="line"></span><br><span class="line">ssh -p 22  -i ~/.ssh/id_rsa -fNL 3308:127.0.0.1:3306 root@118.xx.xxx.xx</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh -p &#123;ssh_port&#125; -i &#123;rsa_file&#125; -fNL &#123;local_port&#125;:&#123;mysql_ip&#125;:&#123;mysql_port&#125; </span><br><span class="line">&#123;ssh_user&#125;@&#123;ssh_ip&#125;</span><br><span class="line">ssh -p 22  -i ./id_rsa_jump -fNL 33060:mysql_ip:3306 jump@jump_ip   # 实例</span><br></pre></td></tr></table></figure><blockquote><p>-p {ssh_port}: 指定跳板机器的ssh服务的端口<br>-i {rsa_file}:指定连接跳板机的ssh公钥，由跳板机的ssh服务端生成，如果不指定公钥或者公钥验证失败则会弹出密码进行登录。<br>-f:需进行ssh认证<br>-N:只进行端口转发，不执行命令<br>-L:指定连接服务的格式 [bind_address:]port:host:hostport<br>{local_port}：本地监听的端口<br>{mysql_ip}：转发到的mysql的ip或域名<br>{mysql_port}：转发到的mysql的端口<br>{ssh_port}：跳板机的<br>{ssh_user}：跳板机的ssh用户名(如果为rsa登录，则ras对应的用户名和ssh_user一致)<br>{ssh_ip}：跳板机的ip或域名<br>检查是否启动成功<br>netstat  -aon|findstr  “33060”  #存在对应的监听则启动成功 如果要关闭则kill<br>连接mysql<br>ip:127.0.0.1<br>port:33060</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;因为安全原因远程服务器的数据库不允许本地直接访问，又没有开启访问IP白名单时，可以通过隧道代理访问。Windows系统通过xsheel可以设置隧道代理。Mac只需要运行如下命令&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;hi
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>truffle geth 启动Ethereum测试节点</title>
    <link href="http://blog.uiste.com/2018/20181102-1.html"/>
    <id>http://blog.uiste.com/2018/20181102-1.html</id>
    <published>2018-11-02T07:42:14.000Z</published>
    <updated>2018-11-02T07:58:06.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="truffle-框架使用"><a href="#truffle-框架使用" class="headerlink" title="truffle 框架使用"></a>truffle 框架使用</h1><p><strong> uiste@uiste:~$     testrpc </strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uiste@uiste:~/www/blockchain/test_truffle_2$     truffle unbox webpack</span><br><span class="line">uiste@uiste:~/www/blockchain/test_truffle_2$     truffle develop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Last login: Mon Apr  2 20:07:27 on ttys008</span><br><span class="line">uiste@uiste:~$     cd www/blockchain/test_truffle_2/</span><br><span class="line">uiste@uiste:~/www/blockchain/test_truffle_2$     npm run dev</span><br></pre></td></tr></table></figure></p><h1 id="geth-方式"><a href="#geth-方式" class="headerlink" title="geth 方式"></a>geth 方式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">`geth --datadir &quot;./Mychains/dev&quot; --identity &quot;mydev&quot; --rpccorsdomain &quot;*&quot; --networkid 99 console`</span><br><span class="line"></span><br><span class="line">uiste@uiste:~$     cd www/blockchain/test-geth</span><br><span class="line">uiste@uiste:~/www/blockchain/test-geth$     geth --datadir &quot;./Mychains/dev&quot; --identity &quot;mydev&quot; --rpc --rpcapi &quot;db,eth,net,web3,personal,web3&quot; --nodiscover --rpccorsdomain &quot;*&quot; --networkid 100 console</span><br><span class="line"></span><br><span class="line">uiste@uiste:/Applications$      /Applications/Mist.app/Contents/MacOS/Mist --rpc &quot;/Users/uiste/www/blockchain/test-geth/Mychains/dev/geth.ipc&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">geth --datadir &quot;./chain&quot; --identity &quot;mydev&quot; --rpc --rpcapi &quot;db,eth,net,web3,personal,web3&quot; --nodiscover --rpccorsdomain &quot;*&quot; --networkid 100 console 2&gt;&gt;eth_output.log</span><br><span class="line"></span><br><span class="line">geth --dev --rpc --rpccorsdomain &quot;*&quot; --rpcaddr &quot;0.0.0.0&quot; --rpcport &quot;8545&quot; --mine --rpcapi &quot;eth,txpool,web3&quot;</span><br><span class="line"></span><br><span class="line">geth --testnet --rpc --rpccorsdomain &quot;*&quot; --rpcaddr &quot;0.0.0.0&quot; --rpcport &quot;8545&quot;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;truffle-框架使用&quot;&gt;&lt;a href=&quot;#truffle-框架使用&quot; class=&quot;headerlink&quot; title=&quot;truffle 框架使用&quot;&gt;&lt;/a&gt;truffle 框架使用&lt;/h1&gt;&lt;p&gt;&lt;strong&gt; uiste@uiste:~$     te
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2</title>
    <link href="http://blog.uiste.com/2018/20180402-2.html"/>
    <id>http://blog.uiste.com/2018/20180402-2.html</id>
    <published>2018-04-02T04:12:29.000Z</published>
    <updated>2019-04-02T04:19:04.374Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>NoSql</title>
    <link href="http://blog.uiste.com/2018/20180402-1.html"/>
    <id>http://blog.uiste.com/2018/20180402-1.html</id>
    <published>2018-04-02T01:43:44.000Z</published>
    <updated>2019-04-02T04:19:06.641Z</updated>
    
    <content type="html"><![CDATA[<h1 id="memcache"><a href="#memcache" class="headerlink" title="memcache"></a>memcache</h1><ul><li><p>Page为内存分配的最小单位。</p><blockquote><p>Memcached 的内存分配以page为单位，默认情况下一个page是1M，可以通过-I参数在启动时指定。如果需要申请内存 时，memcached会划分出一个新的page并分配给需要的slab区域。page一旦被分配在重启前不会被回收或者重新分配</p></blockquote></li><li><p>Slabs划分数据空间。</p><blockquote><p>Memcached 并不是将所有大小的数据都放在一起的，而是预先将数据空间划分为一系列slabs，每个slab只负责一定范围内的数据存储。每个slab只存储大于其上一个slab的size并小于或者等于自己最大size的数据。例如：slab 3只存储大小介于137 到 224 bytes的数据。如果一个数据大小为230byte将被分配到slab 4中。每个slab负责的空间其实是不等的，memcached默认情况下下一个slab的最大值为前一个的1.25倍，这个可以通过修 改-f参数来修改增长比例。</p></blockquote></li><li><p>Chunk才是存放缓存数据的单位。</p><blockquote><p>Chunk 是一系列固定的内存空间，这个大小就是管理它的slab的最大存放大小。例如：slab 1的所有chunk都是104byte，而slab 4的所有chunk都是280byte。chunk是memcached实际存放缓存数据的地方，因为chunk的大小固定为slab能够存放的最大值， 所以所有分配给当前slab的数据都可以被chunk存下。如果时间的数据大小小于chunk的大小，空余的空间将会被闲置，这个是为了防止内存碎片而设 计的。例如，chunk size是224byte，而存储的数据只有200byte，剩下的24byte将被闲置。 </p></blockquote></li><li><p>Slab的内存分配。</p><blockquote><p>Memcached在启动时通过-m指定最大使用内存，但是这个不会一启动就占用，是随着需要逐步分配给各slab的。<br>如果一个新的缓存数据要被存放，memcached首先选择一个合适的slab，然后查看该slab是否还有空闲的chunk，如果有则直接存放进去；如 果没有则要进行申请。slab申请内存时以page为单位，所以在放入第一个数据，无论大小为多少，都会有1M大小的page被分配给该slab。申请到 page后，slab会将这个page的内存按chunk的大小进行切分，这样就变成了一个chunk的数组，在从这个chunk数组中选择一个用于存储 数据。如下图，slab 1和slab 2都分配了一个page，并按各自的大小切分成chunk数组。 </p></blockquote></li><li><p>Memcached内存分配策略</p><blockquote><p>按slab需求分配page，各slab按需使用chunk存储。<br>Memcached分配出去的page不会被回收或者重新分配Memcached申请的内存不会被释放slab空闲的chunk不会借给任何其他slab使用，如果所有page都已经存满了。并且memcache已不能再分配新的内存空间。将根据LRU算法（最近最少使用）,清除某个item并将新项存储在该位置</p></blockquote></li><li><p>分布式解决方案</p></li></ul><ol><li><p>取模算法方式</p><blockquote><p>将key转换为32位的数字，并与memcached服务器的总数进行相除取得余数。而这个余数就是memcached服务器的节点node。有了这个node我们就可以确定memcached服务器，就可以发送命令给memcached执行了。 缺点是不方便扩展和机器宕机后不能自动调整集群<br><code>$node sprintf(&#39;%u&#39;, crc32($key)) % $total</code></p></blockquote></li><li><p>一致哈希算法方式</p><blockquote><p>通过虚拟节点的方式实现，可以使不可控的存储节点能够尽可能的均匀分布在圆环上，从而达到数据均匀缓存在各个主机里。其次增加与删除虚拟节点对于之前缓存的整体数据影响非常小。</p></blockquote></li></ol><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>高性能key-value 存储系统，它通常被称为数据结构服务器。因为值可以是：字符串、哈希、列表、集合、有序集合</p><ul><li><p>特点：单线程、快（每秒10万次SET操作）、拥有很多原子操作方法，保证数据一致性、将具有临时性和数据持久化</p></li><li><p>二进制安全、一个字符串类型的值最多能保存512M内容。</p></li><li><p>集合（set）</p><blockquote><p>集合是一个无需字符串集合。元素不能重复。一个集合最多可以包含2^32-1个元素。方便计算不同集合的交集、并集、差集。常用应用：关注列表、粉丝列表、共同关注或者粉丝等</p></blockquote></li><li><p>有序集合（zSet）</p><blockquote><p>每个有序集合成员都关联着一个评分，这个评分的用语把有序集合中的成员按最低分到最高分排列。（应用于各种有排序条件的列表：访问足迹最近访问的时间戳作为排序分）</p></blockquote></li><li><p>watch</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"content-type:text/html;charset=utf-8"</span>);  </span><br><span class="line">$redis = <span class="keyword">new</span> redis();  </span><br><span class="line">$result = $redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">$watchkey = $redis-&gt;get(<span class="string">"watchkey"</span>);  </span><br><span class="line">$rob_total = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">if</span>($watchkey&lt;$rob_total)&#123;  </span><br><span class="line">    $redis-&gt;watch(<span class="string">"watchkey"</span>);  <span class="comment">// 监视某个key</span></span><br><span class="line">    $redis-&gt;multi();   <span class="comment">// 开启事物</span></span><br><span class="line">    $redis-&gt;hSet(<span class="string">"watchlist"</span>,<span class="string">"user_id_"</span>.mt_rand(<span class="number">1</span>, <span class="number">9999</span>),time());   <span class="comment">// 业务操作</span></span><br><span class="line">    $redis-&gt;incr(<span class="string">"watchkey"</span>);</span><br><span class="line">    $rob_result = $redis-&gt;exec(); <span class="comment">// 如果执行操作期间，被监视的KEY被其它客户端修改了，则exec失败  </span></span><br><span class="line">    <span class="keyword">if</span>($rob_result)&#123;  </span><br><span class="line">        $watchlist = $redis-&gt;hGetAll(<span class="string">"watchlist"</span>);  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"抢购成功！&lt;br/&gt;"</span>;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"剩余数量："</span>.($rob_total-$watchkey<span class="number">-1</span>).<span class="string">"&lt;br/&gt;"</span>;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"用户列表：&lt;pre&gt;"</span>;  </span><br><span class="line">        var_dump($watchlist);  </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"手气不好，再抢购！"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"已被抢购完!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>数据持久化：RDB 和 AOF</p><blockquote><p>RDB：就是快照存储，是默认的持久化方式，按照一定的策略周期性的将数据保存到磁盘。对应产生的数据文件为dump.rdb,通过配置文件中的save参数来定义快照的周期.通过修改配置文件的dbfilename 来修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure></blockquote></li></ul><blockquote><p>AOF:修改配置appendonly yes 来开启，开启后写命令会依次记录到此文件。AOF 大！即使通过bgrewriteaof 命令移除冗余记录也大。恢复慢<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># appendfsync always每次命令都写，最安全，性能最差</span><br><span class="line">appendfsynceverysec每秒同步一次（默认）</span><br><span class="line"># appendfsyncno 不主动同步，由操作系统负责鞋服，约30秒一次</span><br></pre></td></tr></table></figure></p></blockquote><h1 id="mongoDB"><a href="#mongoDB" class="headerlink" title="mongoDB"></a>mongoDB</h1><p>介于关系数据库和非关系型数据之间的文档数据库，支持的数据结构非常松散，类似json的bson格式，因此可以存储比较复杂的数据类型。支持对数据字段奖励索引</p><ul><li>模式自由，通过数据分片实现高伸缩性</li><li>处理地理信息</li><li>高可用，内置故障迁移</li><li>高性能低延时实时数据（查询QPS接近MySQL的两倍左右， 插入QPS接近MySQL的五倍左右）</li><li>局部索引，TTL索引，固定集合</li><li>不适合高度事务性系统，不适合需要复杂SQL处理的查询</li><li>与关系型数据库结构对比：文档≈行，集合≈表，数据库≈数据库</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;memcache&quot;&gt;&lt;a href=&quot;#memcache&quot; class=&quot;headerlink&quot; title=&quot;memcache&quot;&gt;&lt;/a&gt;memcache&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Page为内存分配的最小单位。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;M
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Linux 基础</title>
    <link href="http://blog.uiste.com/2018/20180401-2.html"/>
    <id>http://blog.uiste.com/2018/20180401-2.html</id>
    <published>2018-04-01T11:16:33.000Z</published>
    <updated>2019-04-02T04:19:10.562Z</updated>
    
    <content type="html"><![CDATA[<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><ul><li><p>普通用户只能追加无法删除<br><code>chattr +a /var/log/access.log</code></p></li><li><p>r w x 4 2 1</p></li></ul><h2 id="磁盘文件统计"><a href="#磁盘文件统计" class="headerlink" title="磁盘文件统计"></a>磁盘文件统计</h2><ul><li>df 查看磁盘占用</li><li>du 统计文件占用</li><li>fdisk 分区管理</li><li>mount 磁盘挂载</li><li>umount 磁盘卸载</li><li>mkfs.ext4 磁盘格式化</li></ul><h2 id="查找find"><a href="#查找find" class="headerlink" title="查找find"></a>查找find</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">find . -mmin -60 修改时间为最近60分钟内的</span><br><span class="line">find . -mmin +5  修改时间为5分钟之前的</span><br><span class="line">find /tmp -atime -1 查找/tmp目录最近1天(24小时)内被访问过的文件</span><br><span class="line">find . -type f 查找本目录下的所有文件</span><br><span class="line">find . -type d 查找本目录下的所有目录</span><br><span class="line">find . -user root 查找本目录下所有root用户的文件</span><br><span class="line">find . -perm 600 查找本目录下所有权限为600的文件</span><br><span class="line">find . \( -name &quot;_*&quot; -or -user root \) -type f 查找本目录下（以_开头或root用户的） 文件</span><br><span class="line"></span><br><span class="line">逻辑运算符</span><br><span class="line">-not</span><br><span class="line">-or</span><br><span class="line">-and</span><br></pre></td></tr></table></figure><blockquote><p>分析文章访问日志文件，找出访问量最大的前10个IP地址，降序排序</p><ol><li>找出IP，每行一个 -f 表示需要取得哪个字段<br><code>cut -d &quot; &quot; -f1 /var/log/access.log</code></li><li>去重并计数<br><code>uniq -c</code></li><li>排序<br><code>sort -n -r</code></li><li>取前10行<br><code>head -10</code></li></ol></blockquote><p><code>$ cut -d &quot; &quot; -f1 /var/log/access.log | sort | uniq -c | sort -n -r | head -10</code></p><p>linux 中有三个系统文件描述符：0.标准输入，1.标准输出，2.标准错误输出</p><h2 id="系统管理"><a href="#系统管理" class="headerlink" title="系统管理"></a>系统管理</h2><ul><li><p>ps 命令，显示当前进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps -ef 显示带启动命令行的进程信息</span><br><span class="line">ps -u root 显示某用户的进程</span><br><span class="line">ps -A 显示全部进程</span><br><span class="line">ps -ejH 显示进程树</span><br></pre></td></tr></table></figure></li><li><p>kill 命令：终止进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kill -s PID</span><br><span class="line">-s 指定信号</span><br><span class="line">-l 所有信号标识列表</span><br><span class="line">kill -9 PID  强制结束</span><br><span class="line">killall 进程名称</span><br></pre></td></tr></table></figure></li><li><p>fg 命令 将后台任务调到前台</p><blockquote><p>命令后加 <code>&amp;</code> 或者 <code>ctrl + z</code> 可将任务转到后台执行<br>后台执行中的任务，可以通过 <code>fg &amp;任务序号</code> 调到前台执行<br>jobs -l 查看后台任务<br><code>fg %1 恢复后台进程中的1工作号到前台执行，不写1表示恢复最后一个工作号（+）到前台执行，也可以不写%，fg 1</code></p></blockquote></li></ul><ul><li>开放端口：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT 4 -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT</span><br><span class="line">service iptables save #保存iptables规则</span><br></pre></td></tr></table></figure></li></ul><h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><ul><li><p>变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">区分大小写</span><br><span class="line">等号两边无空格</span><br><span class="line">所有变量都是字符串</span><br></pre></td></tr></table></figure></li><li><p>流程控制</p></li><li>命令列表</li><li>函数</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;权限&quot;&gt;&lt;a href=&quot;#权限&quot; class=&quot;headerlink&quot; title=&quot;权限&quot;&gt;&lt;/a&gt;权限&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;普通用户只能追加无法删除&lt;br&gt;&lt;code&gt;chattr +a /var/log/access.log&lt;/code&gt;&lt;/p
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>PHP细节-03</title>
    <link href="http://blog.uiste.com/2018/20180401-1.html"/>
    <id>http://blog.uiste.com/2018/20180401-1.html</id>
    <published>2018-04-01T00:55:26.000Z</published>
    <updated>2019-04-02T04:19:13.414Z</updated>
    
    <content type="html"><![CDATA[<h1 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h1><blockquote><p>时间复杂度的算法具体步骤是：<br>⑴ 找出算法中的基本语句；<br>算法中执行次数最多的那条语句就是基本语句，通常是最内层循环的循环体。<br>⑵ 计算基本语句的执行次数的数量级；<br>只需计算基本语句执行次数的数量级，这就意味着只要保证基本语句执行次数的函数中的最高次幂正确即可，可以忽略所有低次幂和最高次幂的系数。这样能够简化算法分析，并且使注意力集中在最重要的一点上：增长率。<br>⑶ 用大Ο记号表示算法的时间性能。<br>将基本语句执行次数的数量级放入大Ο记号中。<br>如果算法中包含嵌套的循环，则基本语句通常是最内层的循环体，如果算法中包含并列的循环，则将并列循环的时间复杂度相加。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for (i=1; i&lt;=n; i++)  </span><br><span class="line">       x++;  </span><br><span class="line">for (i=1; i&lt;=n; i++)  </span><br><span class="line">    　for (j=1; j&lt;=n; j++)  </span><br><span class="line">          x++;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>第一个for循环的时间复杂度为Ο(n)，第二个for循环的时间复杂度为Ο(n2)，则整个算法的时间复杂度为Ο(n+n2)=Ο(n2)。<br>Ο(1)表示基本语句的执行次数是一个常数，一般来说，只要算法中不存在循环语句，其时间复杂度就是Ο(1)。其中Ο(log2n)、Ο(n)、 Ο(nlog2n)、Ο(n2)和Ο(n3)称为多项式时间，而Ο(2n)和Ο(n!)称为指数时间。计算机科学家普遍认为前者（即多项式时间复杂度的算法）是有效算法，把这类问题称为P（Polynomial,多项式）类问题，而把后者（即指数时间复杂度的算法）称为NP（Non-Deterministic Polynomial, 非确定多项式）问题。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;时间复杂度&quot;&gt;&lt;a href=&quot;#时间复杂度&quot; class=&quot;headerlink&quot; title=&quot;时间复杂度&quot;&gt;&lt;/a&gt;时间复杂度&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;时间复杂度的算法具体步骤是：&lt;br&gt;⑴ 找出算法中的基本语句；&lt;br&gt;算法中执行次数最多的
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>PHP细节-02</title>
    <link href="http://blog.uiste.com/2018/20180331-2.html"/>
    <id>http://blog.uiste.com/2018/20180331-2.html</id>
    <published>2018-03-31T14:44:26.000Z</published>
    <updated>2019-04-02T04:19:15.094Z</updated>
    
    <content type="html"><![CDATA[<h1 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h1><ul><li>二进制文件读写 pack() unpack()</li><li>系统函数判断图像类型：exif_imagetype()</li><li><p>文件指针</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fseek() 在文件指针中定位</span><br><span class="line">ftell() 返回文件指针读写的位置</span><br><span class="line">rewind() 倒回文件指针的位置</span><br><span class="line">feof() 测试文件指针是否到了文件结束的位置</span><br></pre></td></tr></table></figure></li><li><p>超大文件上传</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swfUpload、uploadify 等flash组件</span><br><span class="line">XMLHTTPRequest 大文件断点续传+分段上传 ajax2.0</span><br></pre></td></tr></table></figure></li></ul><h1 id="PHP运行原理"><a href="#PHP运行原理" class="headerlink" title="PHP运行原理"></a>PHP运行原理</h1><blockquote><p>UA -&gt; apache -&gt; SAPI -&gt; zend engine -&gt; php script</p></blockquote><h1 id="PHP运行模式"><a href="#PHP运行模式" class="headerlink" title="PHP运行模式"></a>PHP运行模式</h1><ul><li><p>CLI模式 命令行接口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">定时任务</span><br><span class="line">shell脚本中使用</span><br><span class="line">桌面应用程序</span><br><span class="line">PHP server 服务</span><br></pre></td></tr></table></figure></li><li><p>CGI 通用网关接口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">就像桥梁一样，把网页和web服务器中的执行程序连接起来，它把http服务器接收的指令传递给执行程序，再把执行程序的结果返回http服务器。CGI跨平台性及佳，几乎可以在任何操作系统实现</span><br><span class="line"></span><br><span class="line">提供http服务</span><br><span class="line">性能比较差，一个请求fork一个进程</span><br></pre></td></tr></table></figure></li><li><p>FastCGI 快速通用网关接口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">也是交互程序与web服务器通信协议。致力于介绍服务器与程序之前互动的开销</span><br><span class="line">web服务器启动时，载入FastCGI进程管理器 对于PHP来讲就是php-fpm</span><br><span class="line">FastCGI 会启动多个CGI进程等待web服务器的连接</span><br><span class="line">收到请求时由FastCGI子进程处理。子进程关闭连接时，请求处理完成。子进程接着等待并处理FastCGI进程管理器的下一个连接</span><br><span class="line"></span><br><span class="line">提供http服务</span><br><span class="line">支持大并发</span><br><span class="line">多进程消耗较多内存</span><br></pre></td></tr></table></figure></li><li><p>模块模式 apache 和 ISS</p></li></ul><h1 id="进程、线程、协程"><a href="#进程、线程、协程" class="headerlink" title="进程、线程、协程"></a>进程、线程、协程</h1><ul><li>单进程：单个CPU一次只能运行一个任务</li><li>一个进程可以包括多个线程（防止多个线程同时读写某一块区域加锁机制）</li><li>协程避免了无意义的调度，由此提高了性能。但因此要程序员自己承担调度的责任，同时也失去了标准线程使用多CPU的能力</li></ul><blockquote><p>多进程形式，允许多个任务同时运行<br>多线程形式，允许单个任务分成不同部分运行</p></blockquote><ul><li>ts Thread safe 线程安全，执行时会进程线程安全检查，防止有新要求就启动新线程的执行方式而耗尽系统资源</li><li>nts Non Thread Safe 非线程安全，在执行时不进行线程安全检查</li></ul><blockquote><p>由于ISAPI是线程执行的，所以选择PHP版本时要选择TS版本的。其它选择NTS版本就行了。</p></blockquote><ul><li><p>Apache 的 prefork 模块</p><blockquote><p>prefork 采用预派生子进程模式，用单独的子进程来处理不同的请求，进程之间彼此独立。httpd-mpm.conf 配置包括：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">StartServers 5 #  初始化进程数量</span><br><span class="line">MinSpareServers 5 # 空闲进程总数最小值</span><br><span class="line">MaxApareServers 10 # 空闲进程总数最大值</span><br><span class="line">MaxClients 150 # 最大客户端连接数量限制</span><br><span class="line">MaxRequestsPerChild 0 # 子进程减能处理的请求数量</span><br></pre></td></tr></table></figure></blockquote></li><li><p>Apache 的 worker 模块</p><blockquote><p>worker 全新的支持多线程和多进程混合模型的MPM，由于使用线程来处理，所以可以处理相对海量的数据请求。而系统资源的开销要小于基于进程的服务器</p></blockquote></li><li><p>Apache 的 event 模式</p></li></ul><p>为什么大访问量下NGINX性能更高？</p><blockquote><p>Apache 所采用的select 网络 I/O 模型非常低效<br>Nginx 使用了最新的epoll 和 kqueue(freebsd) 网络 I/O 模型<br>PHP是 Apache 的一个扩展模块，所以Apache 进程 干的事情也比较多，执行PHP、输出HTML 都得干，占用的资源也多（CPU，内存）</p></blockquote><h1 id="PHP运行机制与原理"><a href="#PHP运行机制与原理" class="headerlink" title="PHP运行机制与原理"></a>PHP运行机制与原理</h1><ul><li><p>PHP 底层原理</p><blockquote><p>PHP通过 SAPI 和 Apache相连<br>PHP总共有三个模块：内核、Zend引擎、以及扩展层<br>PHP内核用来处理请求、文件流、错误处理等相关操作<br>Zend引擎（ZE）用以将源文件转换成机器语言，然后在虚拟机上运行它；<br>扩展层是一株函数、类库和流，PHP使用它们来执行一些特定的操作，如：MySQL扩展来连接MySQL数据库<br>ZE引擎执行程序是可能需要连接若干扩展，这是ZE将控制权交给扩展，等待处理完任务和再返还<br>最后ZE将程序运行结果反回给PHP内核，它再将结果传送给SAPI传给Apache</p></blockquote></li><li><p>PHP运行机制</p><blockquote><ol><li>扫描</li></ol></blockquote></li></ul><ol start="2"><li>解析</li><li>编译</li><li>执行</li><li>输出</li></ol><h1 id="PHP垃圾回收机制"><a href="#PHP垃圾回收机制" class="headerlink" title="PHP垃圾回收机制"></a>PHP垃圾回收机制</h1><p>没有引用的内存变量就垃圾，PHP开启了很多内存空间，如果不销毁内存会一点点的被吃掉，最终导致内存溢出。</p><ol><li>找到所有已定义的变量：get_defined_vars</li><li>refcount_gc 是否为0 就知道是不是垃圾 无引用的变量 (清除为0的5.2版本以前   5.3以后 采用了引用计数系统中的同步周期回收算法来清除)</li><li>当我们存储的疑似垃圾区域满了的时候，就会被执行清除垃圾的操作。前提是开启了 php.ini 中的 zend.enable_gc 配置 也可以调用 gc_enable() 和 gc_disable() 打开和关闭垃圾回收机制  也可以通过 gc_collect_cycles() 强制执行周期回收 </li></ol><h1 id="PHP常用选项"><a href="#PHP常用选项" class="headerlink" title="PHP常用选项"></a>PHP常用选项</h1><ul><li>display_errors 是否显示错误信息 辅助开发使用，不要在生产环境使用</li><li>error_reporting 设置错误报告的级别</li><li>variables_order 设置EGPCS超全局变量的解析顺序</li><li>request_order 确定 <code>$_GET</code> 和 <code>$_POST</code> 等超全局变量的顺序，后面的会把前面的数据重写覆盖   “GP”</li><li>disable_classes 、 disable_functions 禁用某些类和某些函数</li></ul><h1 id="HTTP-协议"><a href="#HTTP-协议" class="headerlink" title="HTTP 协议"></a>HTTP 协议</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /index.html HTTP/1.1</span><br><span class="line">HOST: www.example.com</span><br><span class="line">Range: bytcs-500-999</span><br><span class="line">Connection:keep-alive</span><br></pre></td></tr></table></figure><ul><li>HTTP 工作流程<br>访问一个网址时，发生了什么？<blockquote><ol><li>通过DNS解析域名对应的服务器IP地址</li><li>建立TCP连接</li><li>向服务器发送请求</li><li>返回内容</li></ol></blockquote></li></ul><h1 id="javascript"><a href="#javascript" class="headerlink" title="javascript"></a>javascript</h1><ul><li>闭包<blockquote><p>闭包使用不当可能会导致内存泄露。<br>闭包是指有权访问另一个函数作用域中的变量的函数<br>一个外部函数执行完毕后，由于其内部函数被外部引用，导致其作用域中的变量存活，而不能在函数执行完毕后被销毁，包含这些变量的那个对象就被称为闭包</p></blockquote></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;文件&quot;&gt;&lt;a href=&quot;#文件&quot; class=&quot;headerlink&quot; title=&quot;文件&quot;&gt;&lt;/a&gt;文件&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;二进制文件读写 pack() unpack()&lt;/li&gt;
&lt;li&gt;系统函数判断图像类型：exif_imagetype()&lt;/li
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>PHP细节-01</title>
    <link href="http://blog.uiste.com/2018/20180331-1.html"/>
    <id>http://blog.uiste.com/2018/20180331-1.html</id>
    <published>2018-03-31T03:56:35.000Z</published>
    <updated>2019-04-02T04:19:16.829Z</updated>
    
    <content type="html"><![CDATA[<h1 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h1><ul><li>双引号或者heredoc其中的变量 以及 <code>\</code> 开始的符合8进制16进制和特殊符号</li><li>字符串底层是C语言的结构体，所以可以用<code>[]</code> 或 <code>{}</code> 来访问某个字符</li><li>字符串最大长度可以达到2G内存</li><li>C语言字符串<code>\0</code>代表字符串结束，但PHP结构体是有个长度字段，可以让二进制字符串安全</li><li>用超出字符串长度的下标写入将会拉长字符串并以空格填充</li><li>UTF-8 编码<blockquote><p>16进制 Unicode 编码范围 0800 - FFFF<br>2进制 1110xxxx 10xxxxxx 10xxxxxx<br>为了通用优先选择UTF-8 3个字节,为了节省空间用GBK 2个字节</p></blockquote></li></ul><h1 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h1><ul><li>key 可以是integer 或者 string (包含合法整形的字符串，浮点数和布尔值都会被转化为整形)</li><li>unset() 后，不会重建索引</li><li><p>遍历中的引用分析</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $key =&gt; &amp;$value) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $value; <span class="comment">// 3 是 &amp;$arr[2] = 3;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var_dump($arr); <span class="comment">// [1,2,2]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 循环1 $value = &amp;$arr[2] = $arr[0] = 1;</span></span><br><span class="line"><span class="comment">// 循环2 $value = &amp;$arr[2] = $arr[1] = 2;</span></span><br><span class="line"><span class="comment">// 循环3 $value = &amp;$arr[2] = $arr[2] = 2;</span></span><br></pre></td></tr></table></figure></li><li><p>位运算：<code>$a&amp;1 == 0 偶数 反之奇数</code></p></li></ul><h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>组成 = 元字符 + 普通字符<br>常见元字符<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">^ 匹配字符串的开始</span><br><span class="line">$       匹配字符串的结束</span><br><span class="line">.匹配除换行以外的任意字符</span><br><span class="line">\w 匹配字母或者数字或者下划线</span><br><span class="line">\W 不匹配字母数字下划线</span><br><span class="line">\s 匹配任意的空字符 相当于[\f\r\n\t\v]</span><br><span class="line">\d 匹配任意的数字</span><br><span class="line">\b 匹配单词的开始或者结束</span><br><span class="line">\xxx查找以八进制xxx规定的字符</span><br><span class="line">\xdd查找以十六进制dd对顶的字符</span><br><span class="line">\uxxx 查找以十六进制 xxxx 规定的 Unicode 字符</span><br><span class="line">[abcd]  匹配任意一个字符</span><br><span class="line">[a-d]   匹配任意一个字符</span><br><span class="line">[^abcd] 不匹配任意一个字符</span><br><span class="line">[\u4e00-\u9fa5] 匹配任意单个汉字</span><br></pre></td></tr></table></figure></p><p>常见限定符 （限定的是前面一个单元）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|或关系</span><br><span class="line">*匹配0到多个，相当于&#123;0,&#125;</span><br><span class="line">?匹配0到1个，相当于&#123;0,1&#125;</span><br><span class="line">+匹配至少1个字符，相当于&#123;1,&#125;</span><br><span class="line">&#123;n&#125;匹配n个字符</span><br><span class="line">&#123;n,&#125;    匹配至少n个字符</span><br><span class="line">&#123;n,m&#125;匹配n到m个字符</span><br></pre></td></tr></table></figure></p><p>环视<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(?=exp) 位置后面能匹配exp</span><br><span class="line">(?!=exp)位置后面不能匹配exp</span><br><span class="line">(?&lt;=exp)位置前面能匹配exp</span><br><span class="line">(?&lt;!exp)位置前面不能匹配exp</span><br></pre></td></tr></table></figure></p><p>贪婪与懒惰</p><blockquote><p>通常的行为是尽可能匹配多的字符（回溯）<br>只要在它后面加一个问号，匹配成功的前提是使用最少的重复</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$string = &apos;aaabaab&apos;;</span><br><span class="line">$pattern1 = &apos;/a.&#123;1,10&#125;b/&apos;;</span><br><span class="line">$pattern2 = &apos;/a.&#123;1,10&#125;?b/&apos;;</span><br><span class="line">preg_match_all($pattern1,$string,$matchs1);</span><br><span class="line">preg_match_all($pattern2,$string,$matchs2);</span><br><span class="line"></span><br><span class="line">var_dump($matchs1);</span><br><span class="line">var_dump($matchs2);</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  array(1) &#123;</span><br><span class="line">    [0]=&gt;</span><br><span class="line">    string(7) &quot;aaabaab&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  array(2) &#123;</span><br><span class="line">    [0]=&gt;</span><br><span class="line">    string(4) &quot;aaab&quot;</span><br><span class="line">    [1]=&gt;</span><br><span class="line">    string(3) &quot;aab&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回溯</p><blockquote><p>贪婪模式的回溯是影响性能</p></blockquote><h1 id="习惯"><a href="#习惯" class="headerlink" title="习惯"></a>习惯</h1><ul><li>优先使用单引号</li><li><p>内置函数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 邮件过滤：$email = filter_var(&apos;hi@uiste.com&apos;, FILTER_VALIDATE_EMAIL);</span><br><span class="line">2. 获取文件扩展名：pathinfo($filename, PATHINFO_EXTENSION);</span><br></pre></td></tr></table></figure></li><li><p>strtr 与 str_replace 函数前者优先级更高</p></li><li><p>yield 实现协程 生成器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">function createRange($number)&#123;</span><br><span class="line">    for($i=0;$i&lt;$number;$i++)&#123;</span><br><span class="line">        yield time();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result = createRange(10); // 这里调用上面我们创建的函数</span><br><span class="line">foreach($result as $value)&#123;</span><br><span class="line">    sleep(1);</span><br><span class="line">    echo $value , PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">1554027375</span><br><span class="line">1554027376</span><br><span class="line">1554027377</span><br><span class="line">1554027378</span><br><span class="line">1554027379</span><br><span class="line">1554027380</span><br><span class="line">1554027381</span><br><span class="line">1554027382</span><br><span class="line">1554027383</span><br><span class="line">1554027384</span><br><span class="line">[Finished in 10.2s]</span><br><span class="line"></span><br><span class="line">我们来还原一下代码执行过程。</span><br><span class="line"></span><br><span class="line">首先调用 createRange 函数，传入参数10，但是 for 值执行了一次然后停止了，并且告诉 foreach 第一次循环可以用的值。</span><br><span class="line"> foreach 开始对 $result 循环，进来首先 sleep(1) ，然后开始使用 for 给的一个值执行输出。</span><br><span class="line"> foreach 准备第二次循环，开始第二次循环之前，它向 for 循环又请求了一次。</span><br><span class="line"> for 循环于是又执行了一次，将生成的时间戳告诉 foreach .</span><br><span class="line"> foreach 拿到第二个值，并且输出。由于 foreach 中 sleep(1) ，所以， for 循环延迟了1秒生成当前时间</span><br><span class="line">所以，整个代码执行中，始终只有一个记录值参与循环，内存中也只有一条信息。</span><br><span class="line"></span><br><span class="line">无论开始传入的 $number 有多大，由于并不会立即生成所有结果集，所以内存始终是一条循环的值。</span><br><span class="line"></span><br><span class="line">读取超大文件</span><br><span class="line">PHP开发很多时候都要读取大文件，比如csv文件、text文件，或者一些日志文件。这些文件如果很大，比如5个G。这时，直接一次性把所有的内容读取到内存中计算不太现实。</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">header(&quot;content-type:text/html;charset=utf-8&quot;);</span><br><span class="line">function readTxt()</span><br><span class="line">&#123;</span><br><span class="line">    # code...</span><br><span class="line">    $handle = fopen(&quot;./test.txt&quot;, &apos;rb&apos;);</span><br><span class="line"></span><br><span class="line">    while (feof($handle)===false) &#123;</span><br><span class="line">        # code...</span><br><span class="line">        yield fgets($handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose($handle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foreach (readTxt() as $key =&gt; $value) &#123;</span><br><span class="line">    # code...</span><br><span class="line">    echo $value , PHP_EOL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>语法支持带来更高效率 用 ** 更快</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo 2**3 , PHP_EOL;</span><br><span class="line">echo pow(2,3) , PHP_EOL;</span><br></pre></td></tr></table></figure></li><li><p>用 … 定义变成参数</p></li><li>&lt;=&gt; 大于为1，等于为0，小于为-1</li><li>if 使用技巧给定初始值，比增加else效率更高</li><li>if 使用技巧 三元运算符替换</li><li>去掉多此一举的写法 直接return 出去，尽量精简代码</li><li>根据二维数组中的某个键值排序：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 根据uv_price排序</span><br><span class="line">array_multisort(array_column($productData, &apos;uv_price&apos;), SORT_DESC, $productData);</span><br></pre></td></tr></table></figure></li></ul><h2 id="php坑人题"><a href="#php坑人题" class="headerlink" title="php坑人题"></a>php坑人题</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">3</span>;</span><br><span class="line">$b = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">if</span>($a = <span class="number">5</span> || $b = <span class="number">7</span>)&#123;</span><br><span class="line">$a++;</span><br><span class="line">++$b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $a . <span class="string">'-'</span> . $b;  <span class="comment">//1-7</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$count = <span class="number">5</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCount</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">static</span> $count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> $count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> ++$count . PHP_EOL; <span class="comment">//6</span></span><br><span class="line"><span class="keyword">echo</span> getCount() . PHP_EOL; <span class="comment">//0</span></span><br><span class="line"><span class="keyword">echo</span> getCount() . PHP_EOL; <span class="comment">//1</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> count(<span class="string">'1234'</span>) + count(<span class="keyword">null</span>) + count(<span class="keyword">false</span>) . PHP_EOL; <span class="comment">// 1+0+1 = 2</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">0.2</span>+<span class="number">0.7</span>;</span><br><span class="line">$b = <span class="number">0.9</span>;</span><br><span class="line"><span class="keyword">echo</span> $a . PHP_EOL; <span class="comment">// 0.9</span></span><br><span class="line"><span class="keyword">echo</span> $b . PHP_EOL; <span class="comment">// 0.9</span></span><br><span class="line">var_dump($a == $b); <span class="comment">// bool(false)</span></span><br><span class="line"><span class="comment">// php在比较浮点数大小时，需要把浮点数转为字符串进行比较。</span></span><br><span class="line"></span><br><span class="line">要使用 BC 这个函数库，要在编译 PHP 程序时加入 --enable-bcmath 的选项。</span><br><span class="line"></span><br><span class="line">bcadd: 将二个高精确度数字相加。</span><br><span class="line">bccomp: 比较二个高精确度数字。</span><br><span class="line">bcdiv: 将二个高精确度数字相除。</span><br><span class="line">bcmod: 取得高精确度数字的余数。</span><br><span class="line">bcmul: 将二个高精确度数字相乘。</span><br><span class="line">bcpow: 求一高精确度数字次方值。</span><br><span class="line">bcscale: 配置程序中所有 BC 函数库的默认小数点位数。</span><br><span class="line">bcsqrt: 求一高精确度数字的平方根。</span><br><span class="line">bcsub: 将二个高精确度数字相减。</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;字符串&quot;&gt;&lt;a href=&quot;#字符串&quot; class=&quot;headerlink&quot; title=&quot;字符串&quot;&gt;&lt;/a&gt;字符串&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;双引号或者heredoc其中的变量 以及 &lt;code&gt;\&lt;/code&gt; 开始的符合8进制16进制和特殊符号&lt;/li&gt;
&lt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>brew更换国内镜像源</title>
    <link href="http://blog.uiste.com/2018/20180329-5.html"/>
    <id>http://blog.uiste.com/2018/20180329-5.html</id>
    <published>2018-03-29T11:21:44.000Z</published>
    <updated>2019-04-02T04:21:49.412Z</updated>
    
    <content type="html"><![CDATA[<p>homebrew主要分两部分：git repo（位于GitHub）和二进制bottle（位于binary），这两者在国内访问不太顺畅。其实可以替换成国内的镜像，git repo国内镜像就比较多了，可以自行查找，如：中科大镜像…</p><h2 id="替换homebrew默认源"><a href="#替换homebrew默认源" class="headerlink" title="替换homebrew默认源"></a>替换homebrew默认源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">替换brew.git:</span><br><span class="line">cd &quot;$(brew --repo)&quot;</span><br><span class="line">git remote set-url origin https://mirrors.ustc.edu.cn/brew.git</span><br><span class="line"></span><br><span class="line">替换homebrew-core.git:</span><br><span class="line">cd &quot;$(brew --repo)/Library/Taps/homebrew/homebrew-core&quot;</span><br><span class="line">git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git</span><br></pre></td></tr></table></figure><p>如果替换源之后brew update 没反应<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &quot;$(brew --repo)&quot;</span><br><span class="line">git pull origin master</span><br></pre></td></tr></table></figure></p><h2 id="切回官方源"><a href="#切回官方源" class="headerlink" title="切回官方源"></a>切回官方源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">重置brew.git:</span><br><span class="line">cd &quot;$(brew --repo)&quot;</span><br><span class="line">git remote set-url origin https://github.com/Homebrew/brew.git</span><br><span class="line"></span><br><span class="line">重置homebrew-core.git:</span><br><span class="line">cd &quot;$(brew --repo)/Library/Taps/homebrew/homebrew-core&quot;</span><br><span class="line">git remote set-url origin https://github.com/Homebrew/homebrew-core.git</span><br></pre></td></tr></table></figure><p>注释掉bash配置文件里的有关Homebrew Bottles即可恢复官方源。 重启bash或让bash重读配置文件。<br>Homebrew Bottles是Homebrew提供的二进制代码包，目前镜像站收录了以下仓库：</p><p>对于bash用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles&apos; &gt;&gt; ~/.bash_profile</span><br><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure></p><p>对于zsh用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles&apos; &gt;&gt; ~/.zshrc</span><br><span class="line">source ~/.zshrc</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;homebrew主要分两部分：git repo（位于GitHub）和二进制bottle（位于binary），这两者在国内访问不太顺畅。其实可以替换成国内的镜像，git repo国内镜像就比较多了，可以自行查找，如：中科大镜像…&lt;/p&gt;
&lt;h2 id=&quot;替换homebrew默
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>网络协议</title>
    <link href="http://blog.uiste.com/2018/20180329-4.html"/>
    <id>http://blog.uiste.com/2018/20180329-4.html</id>
    <published>2018-03-29T04:32:20.000Z</published>
    <updated>2019-04-02T04:19:18.748Z</updated>
    
    <content type="html"><![CDATA[<p>网络协议为计算机网络中进行数据交换而建立的规则,标准或约定的集合,所有的计算机/手机等网络设备通信都得遵循网络协议.<br>网络协议根据通信的步骤,层级划分为7个层级,从上往下为:</p><ul><li>应用层</li><li>表示层</li><li>会话层</li><li>传输层</li><li>网络层</li><li>数据链路层</li><li>物理层</li></ul><p><img src="https://www.easyswoole.com/Manual/3.x/Cn/_book/noobCourse/NetworkrPotocol/networkPotocol.png" alt="TCP/IP模型与OSI模型对比"></p><blockquote><p>内容来源： <img src="https://www.easyswoole.com" alt="easyswoole"></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;网络协议为计算机网络中进行数据交换而建立的规则,标准或约定的集合,所有的计算机/手机等网络设备通信都得遵循网络协议.&lt;br&gt;网络协议根据通信的步骤,层级划分为7个层级,从上往下为:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;应用层&lt;/li&gt;
&lt;li&gt;表示层&lt;/li&gt;
&lt;li&gt;会话层&lt;/li
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>立个flag</title>
    <link href="http://blog.uiste.com/2018/20180329-3.html"/>
    <id>http://blog.uiste.com/2018/20180329-3.html</id>
    <published>2018-03-29T03:25:31.000Z</published>
    <updated>2019-04-02T04:19:21.587Z</updated>
    
    <content type="html"><![CDATA[<p>好久都没有在这里写笔记了。记录的地方比较零散，有道云、OneNote、web博客(域名迁移备案失效，服务器也关闭了)。有时候突然想要查找一些内容都忘记放在哪里了。也就只能是一个记录过程却少了一些查找的过程。立个flag以后继续记录在这里了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;好久都没有在这里写笔记了。记录的地方比较零散，有道云、OneNote、web博客(域名迁移备案失效，服务器也关闭了)。有时候突然想要查找一些内容都忘记放在哪里了。也就只能是一个记录过程却少了一些查找的过程。立个flag以后继续记录在这里了。&lt;/p&gt;

      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>nginx 配置</title>
    <link href="http://blog.uiste.com/2018/20180329-2.html"/>
    <id>http://blog.uiste.com/2018/20180329-2.html</id>
    <published>2018-03-29T02:32:49.000Z</published>
    <updated>2019-04-02T04:19:22.884Z</updated>
    
    <content type="html"><![CDATA[<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">upstream http_server &#123;</span><br><span class="line">server x.x.x.x weight=10; # 权重</span><br><span class="line">server x.x.x.x weight=20; # 权重</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream backend &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">    server 127.0.0.1:9090;</span><br><span class="line">    ip_hash; # ip_hash</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>nginx 转发比较消耗CPU</p></blockquote><h1 id="nginx-转发"><a href="#nginx-转发" class="headerlink" title="nginx 转发"></a>nginx 转发</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 8888;</span><br><span class="line">server name localhost;</span><br><span class="line"></span><br><span class="line">#access_log logs/host.access.log main;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">root /home/...;</span><br><span class="line">index index.html index.htm</span><br><span class="line"></span><br><span class="line">if (!-e $request_filename) &#123; # 找不到请求地址</span><br><span class="line">proxy_pass http://127.0.0.1:8811; # 单机转发 外网IP</span><br><span class="line">#proxy_pass http://http_server; # 负载均衡名称</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="nginx-的-upstream权重配置"><a href="#nginx-的-upstream权重配置" class="headerlink" title="nginx 的 upstream权重配置"></a>nginx 的 upstream权重配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">权重配置：</span><br><span class="line"></span><br><span class="line">weight和请求数量成正比，主要用于上游服务器配置不均衡的情况。下面的配置中，192.168.10.2机器的请求量是192.168.10.1机器请求量的2倍。</span><br><span class="line"></span><br><span class="line">upstream nodes &#123;</span><br><span class="line"></span><br><span class="line">server 192.168.10.1:8668 weight=5;</span><br><span class="line"></span><br><span class="line">server 192.168.10.2:8668 weight=10;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip_hash配置：</span><br><span class="line"></span><br><span class="line">每一个请求按照请求的ip的hash结果分配。这样每一个请求固定落在一个上游服务器，能够解决ip会话在同一台服务器的问题。</span><br><span class="line"></span><br><span class="line">upstream nodes &#123;</span><br><span class="line"></span><br><span class="line">ip_hash;</span><br><span class="line"></span><br><span class="line">server 192.168.10.1:8668;</span><br><span class="line"></span><br><span class="line">server 192.168.10.2:8668;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fair配置：</span><br><span class="line"></span><br><span class="line">按上游服务器的响应时间来分配请求。响应时间短的优先分配。</span><br><span class="line"></span><br><span class="line">upstream nodes &#123;</span><br><span class="line"></span><br><span class="line">server 192.168.10.1:8668;</span><br><span class="line"></span><br><span class="line">server 192.168.10.2:8668;</span><br><span class="line"></span><br><span class="line">fair;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url_hash配置：</span><br><span class="line"></span><br><span class="line">按照访问的url的hash结果来分配请求，使每一个url定向到同一个上游服务器。注意：在upstream中加入hash语句。server语句中不能写入weight等其他的參数，hash_method是使用的hash算法。</span><br><span class="line"></span><br><span class="line">upstream nodes &#123;</span><br><span class="line"></span><br><span class="line">server 192.168.10.1:8668;</span><br><span class="line"></span><br><span class="line">server 192.168.10.2:8668;</span><br><span class="line"></span><br><span class="line">hash $request_uri;</span><br><span class="line"></span><br><span class="line">hash_method crc32;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下面再说下在upstream中常用的配置项：</span><br><span class="line"></span><br><span class="line">down：表示当前的server不參与负载均衡。</span><br><span class="line"></span><br><span class="line">weight：默觉得1，weight越大，负载的权重就越大。</span><br><span class="line"></span><br><span class="line">max_fails ：请求失败的次数默觉得1。</span><br><span class="line"></span><br><span class="line">fail_timeout : max_fails次失败后，暂停请求此台服务器的时间。</span><br><span class="line"></span><br><span class="line">backup： 其他全部的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。</span><br><span class="line"></span><br><span class="line">upstream nodes &#123;</span><br><span class="line"></span><br><span class="line">ip_hash;</span><br><span class="line"></span><br><span class="line">server 192.168.10.1:8668 down;</span><br><span class="line"></span><br><span class="line">server 192.168.10.2:8668 weight=2;</span><br><span class="line"></span><br><span class="line">server 192.168.10.3:8668;</span><br><span class="line"></span><br><span class="line">server 192.168.10.4:8668 backup;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Linux命令"><a href="#Linux命令" class="headerlink" title="Linux命令"></a>Linux命令</h1><h2 id="机器名"><a href="#机器名" class="headerlink" title="机器名"></a>机器名</h2><p><code>hostname -i</code></p><h2 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h2><p><code>netstat -anp | grep 8888</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;负载均衡&quot;&gt;&lt;a href=&quot;#负载均衡&quot; class=&quot;headerlink&quot; title=&quot;负载均衡&quot;&gt;&lt;/a&gt;负载均衡&lt;/h1&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pr
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>sheel 脚本</title>
    <link href="http://blog.uiste.com/2018/20180329-1.html"/>
    <id>http://blog.uiste.com/2018/20180329-1.html</id>
    <published>2018-03-29T01:53:51.000Z</published>
    <updated>2019-04-02T04:19:23.881Z</updated>
    
    <content type="html"><![CDATA[<h1 id="reload-sh-平滑重启"><a href="#reload-sh-平滑重启" class="headerlink" title="reload.sh  平滑重启"></a>reload.sh  平滑重启</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;loading...&quot;</span><br><span class="line">pid = `pidof live_master`</span><br><span class="line">echo $pid</span><br><span class="line">kill -USR1 $pid</span><br><span class="line">echo &apos;&quot;loading success&apos;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;reload-sh-平滑重启&quot;&gt;&lt;a href=&quot;#reload-sh-平滑重启&quot; class=&quot;headerlink&quot; title=&quot;reload.sh  平滑重启&quot;&gt;&lt;/a&gt;reload.sh  平滑重启&lt;/h1&gt;&lt;figure class=&quot;highligh
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>mysql 常见问题</title>
    <link href="http://blog.uiste.com/2018/20180328-1.html"/>
    <id>http://blog.uiste.com/2018/20180328-1.html</id>
    <published>2018-03-28T03:12:26.000Z</published>
    <updated>2019-04-02T04:19:25.053Z</updated>
    
    <content type="html"><![CDATA[<h2 id="mysql8-0-设置简单密码报错ERROR-1819-HY000-Your-password-does-not-satisfy-the-current-policy-requirements"><a href="#mysql8-0-设置简单密码报错ERROR-1819-HY000-Your-password-does-not-satisfy-the-current-policy-requirements" class="headerlink" title="mysql8.0 设置简单密码报错ERROR 1819 (HY000): Your password does not satisfy the current policy requirements"></a>mysql8.0 设置简单密码报错ERROR 1819 (HY000): Your password does not satisfy the current policy requirements</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &apos;validate_password%&apos;;</span><br><span class="line">+--------------------------------------+--------+</span><br><span class="line">| Variable_name                        | Value  |</span><br><span class="line">+--------------------------------------+--------+</span><br><span class="line">| validate_password.check_user_name    | ON     |</span><br><span class="line">| validate_password.dictionary_file    |        |</span><br><span class="line">| validate_password.length             | 8      |</span><br><span class="line">| validate_password.mixed_case_count   | 1      |</span><br><span class="line">| validate_password.number_count       | 1      |</span><br><span class="line">| validate_password.policy             | MEDIUM |</span><br><span class="line">| validate_password.special_char_count | 1      |</span><br><span class="line">+--------------------------------------+--------+</span><br><span class="line">7 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global validate_password.policy=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global validate_password.length=4;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit;</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line">➜  ~ mysql_secure_installation</span><br><span class="line"></span><br><span class="line">Securing the MySQL server deployment.</span><br><span class="line"></span><br><span class="line">Enter password for user root:</span><br><span class="line">Error: Access denied for user &apos;root&apos;@&apos;localhost&apos; (using password: YES)</span><br></pre></td></tr></table></figure><h2 id="Syntax-error-or-access-violation-1055-Expression-1-of-SELECT-list-is-not-in-GROUP-BY-clause-and-contains-nonaggregated-column-‘XXX-Y-ZZZZ’-which-is-not-functionally-dependent-on-columns-in-GROUP-BY-clause-this-is-incompatible-with-sql-mode-only-full-group-by"><a href="#Syntax-error-or-access-violation-1055-Expression-1-of-SELECT-list-is-not-in-GROUP-BY-clause-and-contains-nonaggregated-column-‘XXX-Y-ZZZZ’-which-is-not-functionally-dependent-on-columns-in-GROUP-BY-clause-this-is-incompatible-with-sql-mode-only-full-group-by" class="headerlink" title="Syntax error or access violation: 1055 Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column ‘XXX.Y.ZZZZ’ which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by"></a>Syntax error or access violation: 1055 Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column ‘XXX.Y.ZZZZ’ which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by</h2><blockquote><p>原因：<br>MySQL 5.7.5和up实现了对功能依赖的检测。如果启用了only_full_group_by SQL模式(在默认情况下是这样)，那么MySQL就会拒绝选择列表、条件或顺序列表引用的查询，这些查询将引用组中未命名的非聚合列，而不是在功能上依赖于它们。(在5.7.5之前，MySQL没有检测到功能依赖项，only_full_group_by在默认情况下是不启用的。关于前5.7.5行为的描述，请参阅MySQL 5.6参考手册。)</p></blockquote><p>执行以下个命令，可以查看 sql_mode 的内容。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">　　mysql&gt; SHOW SESSION VARIABLES;</span><br><span class="line"></span><br><span class="line">　　</span><br><span class="line">　　mysql&gt; SHOW GLOBAL VARIABLES;</span><br><span class="line"></span><br><span class="line">　　mysql&gt; select @@sql_mode;</span><br></pre></td></tr></table></figure></p><p>可见session和global 的sql_mode的值都为： </p><p><code>ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</code></p><p>only_full_group_by说明：<br>only_full_group_by ：使用这个就是使用和oracle一样的group 规则, select的列都要在group中,或者本身是聚合列(SUM,AVG,MAX,MIN) 才行，其实这个配置目前个人感觉和distinct差不多的，所以去掉就好<br>官网摘抄：<br>官网：ONLY_FULL_GROUP_BY<br>Reject queries for which the select list, HAVING condition, or ORDER BY list refer to nonaggregated columns that are neither named in the GROUP BY clause nor are functionally dependent on (uniquely determined by) GROUP BY columns.</p><p>As of MySQL 5.7.5, the default SQL mode includes ONLY_FULL_GROUP_BY. (Before 5.7.5, MySQL does not detect functional dependency and ONLY_FULL_GROUP_BY is not enabled by default. For a description of pre-5.7.5 behavior, see the MySQL 5.6 Reference Manual.)</p><p>A MySQL extension to standard SQL permits references in the HAVING clause to aliased expressions in the select list. Before MySQL 5.7.5, enabling ONLY_FULL_GROUP_BY disables this extension, thus requiring the HAVING clause to be written using unaliased expressions. As of MySQL 5.7.5, this restriction is lifted so that the HAVING clause can refer to aliases regardless of whether ONLY_FULL_GROUP_BY is enabled.</p><p>解决：<br>执行以下两个命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global sql_mode=&apos;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&apos;;</span><br><span class="line"></span><br><span class="line">mysql&gt; set session sql_mode=&apos;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&apos;;</span><br></pre></td></tr></table></figure></p><p>这两个命令，去掉 sql_mode 的 ONLY_FULL_GROUP_BY</p><h2 id="Mac-OS-X-完全卸载MySQL"><a href="#Mac-OS-X-完全卸载MySQL" class="headerlink" title="Mac OS X 完全卸载MySQL"></a>Mac OS X 完全卸载MySQL</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">执行下列命令</span><br><span class="line">servie.mysql stop</span><br><span class="line">brew uninstall mysql</span><br><span class="line">sudo rm /usr/local/mysql</span><br><span class="line">sudo rm -rf /usr/local/mysql*</span><br><span class="line">sudo rm -rf /Library/StartupItems/MySQLCOM</span><br><span class="line">sudo rm -rf /Library/PreferencePanes/My*</span><br><span class="line">rm -rf ~/Library/PreferencePanes/My*</span><br><span class="line">sudo rm -rf /Library/Receipts/mysql*</span><br><span class="line">sudo rm -rf /Library/Receipts/MySQL*</span><br><span class="line">sudo rm -rf /var/db/receipts/com.mysql.*</span><br><span class="line">其实不同的安装方式有些东西的存储位置不一样，删除完检查一下下面这些文件是否删除了，没有的话则删除掉：</span><br><span class="line"></span><br><span class="line">/usr/local/Cellar 里的mysql文件</span><br><span class="line">/usr/local/var 里的mysql文件</span><br><span class="line">/tmp 里的mysql.sock, mysql.sock.lock, my.cnf文件</span><br><span class="line">pid文件和err文件都在/usr/local/var/mysql里确保删除了</span><br><span class="line">brew安装的安装包存储在/usr/local/Library/Cache/Homebrew也可以一并删除</span><br><span class="line">执行brew cleanup</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;mysql8-0-设置简单密码报错ERROR-1819-HY000-Your-password-does-not-satisfy-the-current-policy-requirements&quot;&gt;&lt;a href=&quot;#mysql8-0-设置简单密码报错ERROR-1
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>swoole</title>
    <link href="http://blog.uiste.com/2018/20180325-3.html"/>
    <id>http://blog.uiste.com/2018/20180325-3.html</id>
    <published>2018-03-25T09:10:47.000Z</published>
    <updated>2019-04-02T04:19:25.947Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装PHP"><a href="#安装PHP" class="headerlink" title="安装PHP"></a>安装PHP</h2><h2 id="安装sowoole-扩展"><a href="#安装sowoole-扩展" class="headerlink" title="安装sowoole 扩展"></a>安装sowoole 扩展</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  package cd swoole</span><br><span class="line">➜  swoole git:(master) phpize</span><br><span class="line">Configuring for:</span><br><span class="line">PHP Api Version:         20170718</span><br><span class="line">Zend Module Api No:      20170718</span><br><span class="line">Zend Extension Api No:   320170718</span><br><span class="line">➜  swoole git:(master) ./configure</span><br><span class="line">➜  swoole git:(master) make &amp;&amp; make installs</span><br><span class="line"></span><br><span class="line">···</span><br><span class="line">Build complete.</span><br><span class="line">Don&apos;t forget to run &apos;make test&apos;.</span><br><span class="line"></span><br><span class="line">Installing shared extensions:     /usr/local/Cellar/php@7.2/7.2.16/pecl/20170718/</span><br><span class="line">Installing header files:          /usr/local/Cellar/php@7.2/7.2.16/include/php/</span><br></pre></td></tr></table></figure><h2 id="ws-server"><a href="#ws-server" class="headerlink" title="ws_server"></a>ws_server</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ws</span> </span>&#123;</span><br><span class="line">    <span class="keyword">CONST</span> HOST = <span class="string">"0.0.0.0"</span>;</span><br><span class="line">    <span class="keyword">CONST</span> PORT = <span class="number">8811</span>;</span><br><span class="line">    <span class="keyword">CONST</span> CHART_PORT = <span class="number">8812</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $ws = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取 key 有值 del</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws = <span class="keyword">new</span> swoole_websocket_server(<span class="keyword">self</span>::HOST, <span class="keyword">self</span>::PORT);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;listen(<span class="keyword">self</span>::HOST, <span class="keyword">self</span>::CHART_PORT, SWOOLE_SOCK_TCP);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;set(</span><br><span class="line">            [</span><br><span class="line">                <span class="string">'enable_static_handler'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">                <span class="string">'document_root'</span> =&gt; <span class="string">"/home/work/hdtocs/swoole_mooc/thinkphp/public/static"</span>,</span><br><span class="line">                <span class="string">'worker_num'</span> =&gt; <span class="number">4</span>,</span><br><span class="line">                <span class="string">'task_worker_num'</span> =&gt; <span class="number">4</span>,</span><br><span class="line">            ]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">"start"</span>, [<span class="keyword">$this</span>, <span class="string">'onStart'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">"open"</span>, [<span class="keyword">$this</span>, <span class="string">'onOpen'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">"message"</span>, [<span class="keyword">$this</span>, <span class="string">'onMessage'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">"workerstart"</span>, [<span class="keyword">$this</span>, <span class="string">'onWorkerStart'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">"request"</span>, [<span class="keyword">$this</span>, <span class="string">'onRequest'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">"task"</span>, [<span class="keyword">$this</span>, <span class="string">'onTask'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">"finish"</span>, [<span class="keyword">$this</span>, <span class="string">'onFinish'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;on(<span class="string">"close"</span>, [<span class="keyword">$this</span>, <span class="string">'onClose'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;ws-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $server</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onStart</span><span class="params">($server)</span> </span>&#123;</span><br><span class="line">        swoole_set_process_name(<span class="string">"live_master"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $server</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $worker_id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onWorkerStart</span><span class="params">($server,  $worker_id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 定义应用目录</span></span><br><span class="line">        define(<span class="string">'APP_PATH'</span>, <span class="keyword">__DIR__</span> . <span class="string">'/../../../application/'</span>);</span><br><span class="line">        <span class="comment">// 加载框架里面的文件</span></span><br><span class="line">        <span class="comment">//require __DIR__ . '/../thinkphp/base.php';</span></span><br><span class="line">        <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../../../thinkphp/start.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request回调</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">($request, $response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($request-&gt;server[<span class="string">'request_uri'</span>] == <span class="string">'/favicon.ico'</span>) &#123;</span><br><span class="line">            $response-&gt;status(<span class="number">404</span>);</span><br><span class="line">            $response-&gt;end();</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SERVER  =  [];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($request-&gt;server)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span>($request-&gt;server <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $_SERVER[strtoupper($k)] = $v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($request-&gt;header)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span>($request-&gt;header <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $_SERVER[strtoupper($k)] = $v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_GET = [];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($request-&gt;get)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span>($request-&gt;get <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $_GET[$k] = $v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $_FILES = [];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($request-&gt;files)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span>($request-&gt;files <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $_FILES[$k] = $v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $_POST = [];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($request-&gt;post)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span>($request-&gt;post <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $_POST[$k] = $v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;writeLog();</span><br><span class="line">        $_POST[<span class="string">'http_server'</span>] = <span class="keyword">$this</span>-&gt;ws;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ob_start();</span><br><span class="line">        <span class="comment">// 执行应用并响应</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            think\Container::get(<span class="string">'app'</span>, [APP_PATH])</span><br><span class="line">                -&gt;run()</span><br><span class="line">                -&gt;send();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="comment">// todo</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $res = ob_get_contents();</span><br><span class="line">        ob_end_clean();</span><br><span class="line">        $response-&gt;end($res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $serv</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $taskId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $workerId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onTask</span><span class="params">($serv, $taskId, $workerId, $data)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分发 task 任务机制，让不同的任务 走不同的逻辑</span></span><br><span class="line">        $obj = <span class="keyword">new</span> app\common\lib\task\Task;</span><br><span class="line"></span><br><span class="line">        $method = $data[<span class="string">'method'</span>];</span><br><span class="line">        $flag = $obj-&gt;$method($data[<span class="string">'data'</span>], $serv);</span><br><span class="line">        <span class="comment">/*$obj = new app\common\lib\ali\Sms();</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            $response = $obj::sendSms($data['phone'], $data['code']);</span></span><br><span class="line"><span class="comment">        &#125;catch (\Exception $e) &#123;</span></span><br><span class="line"><span class="comment">            // todo</span></span><br><span class="line"><span class="comment">            echo $e-&gt;getMessage();</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $flag; <span class="comment">// 告诉worker</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $serv</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $taskId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onFinish</span><span class="params">($serv, $taskId, $data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"taskId:&#123;$taskId&#125;\n"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"finish-data-sucess:&#123;$data&#125;\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听ws连接事件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $ws</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onOpen</span><span class="params">($ws, $request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// fd redis [1]</span></span><br><span class="line">        \app\common\lib\redis\Predis::getInstance()-&gt;sAdd(config(<span class="string">'redis.live_game_key'</span>), $request-&gt;fd);</span><br><span class="line">        var_dump($request-&gt;fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听ws消息事件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $ws</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $frame</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onMessage</span><span class="params">($ws, $frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"ser-push-message:&#123;$frame-&gt;data&#125;\n"</span>;</span><br><span class="line">        $ws-&gt;push($frame-&gt;fd, <span class="string">"server-push:"</span>.date(<span class="string">"Y-m-d H:i:s"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * close</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $ws</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $fd</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onClose</span><span class="params">($ws, $fd)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// fd del</span></span><br><span class="line">        \app\common\lib\redis\Predis::getInstance()-&gt;sRem(config(<span class="string">'redis.live_game_key'</span>), $fd);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"clientid:&#123;$fd&#125;\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录日志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeLog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $datas = array_merge([<span class="string">'date'</span> =&gt; date(<span class="string">"Ymd H:i:s"</span>)],$_GET, $_POST, $_SERVER);</span><br><span class="line"></span><br><span class="line">        $logs = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">foreach</span>($datas <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            $logs .= $key . <span class="string">":"</span> . $value . <span class="string">" "</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        swoole_async_writefile(APP_PATH.<span class="string">'../runtime/log/'</span>.date(<span class="string">"Ym"</span>).<span class="string">"/"</span>.date(<span class="string">"d"</span>).<span class="string">"_access.log"</span>, $logs.PHP_EOL, <span class="function"><span class="keyword">function</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">            <span class="comment">// todo</span></span><br><span class="line">        &#125;, FILE_APPEND);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Ws();</span><br></pre></td></tr></table></figure><h2 id="ws-client"><a href="#ws-client" class="headerlink" title="ws_client"></a>ws_client</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>singwa-swoole-ws测试<span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> wsUrl = <span class="string">"ws://swoole.demo.com:8812"</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> websocket = <span class="keyword">new</span> WebSocket(wsUrl);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">//实例对象的onopen属性</span></span></span><br><span class="line"><span class="javascript">    websocket.onopen = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      websocket.send(<span class="string">"hello-sinwa"</span>);</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">"conected-swoole-success"</span>);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 实例化 onmessage</span></span></span><br><span class="line"><span class="javascript">    websocket.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">"ws-server-return-data:"</span> + evt.data);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">//onclose</span></span></span><br><span class="line"><span class="javascript">    websocket.onclose = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">"close"</span>);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="comment">//onerror</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    websocket.onerror = <span class="function"><span class="keyword">function</span>(<span class="params">evt, e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">"error:"</span> + evt.data);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Server &#123;</span><br><span class="line">    const PORT = 8811;</span><br><span class="line"></span><br><span class="line">    public function port() &#123;</span><br><span class="line">        $shell  =  &quot;netstat -anp 2&gt;/dev/null | grep &quot;. self::PORT . &quot; | grep LISTEN | wc -l&quot;;</span><br><span class="line"></span><br><span class="line">        $result = shell_exec($shell);</span><br><span class="line">        if($result != 1) &#123;</span><br><span class="line">            // 发送报警服务 邮件 短信</span><br><span class="line">            /// todo</span><br><span class="line">            echo date(&quot;Ymd H:i:s&quot;).&quot;error&quot;.PHP_EOL;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo date(&quot;Ymd H:i:s&quot;).&quot;succss&quot;.PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// nohup</span><br><span class="line">swoole_timer_tick(2000, function($timer_id) &#123;</span><br><span class="line">    (new Server())-&gt;port();</span><br><span class="line">    echo &quot;time-start&quot;.PHP_EOL;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;安装PHP&quot;&gt;&lt;a href=&quot;#安装PHP&quot; class=&quot;headerlink&quot; title=&quot;安装PHP&quot;&gt;&lt;/a&gt;安装PHP&lt;/h2&gt;&lt;h2 id=&quot;安装sowoole-扩展&quot;&gt;&lt;a href=&quot;#安装sowoole-扩展&quot; class=&quot;headerli
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>php-ini 文件</title>
    <link href="http://blog.uiste.com/2018/20180325-2.html"/>
    <id>http://blog.uiste.com/2018/20180325-2.html</id>
    <published>2018-03-25T08:54:44.000Z</published>
    <updated>2019-04-02T04:19:27.093Z</updated>
    
    <content type="html"><![CDATA[<h1 id="多个版本改哪个文件下的php-ini-配置才有效？"><a href="#多个版本改哪个文件下的php-ini-配置才有效？" class="headerlink" title="多个版本改哪个文件下的php.ini 配置才有效？"></a>多个版本改哪个文件下的php.ini 配置才有效？</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  package php -i | grep php.ini</span><br><span class="line">Configuration File (php.ini) Path =&gt; /usr/local/etc/php/7.2</span><br><span class="line">Loaded Configuration File =&gt; /usr/local/etc/php/7.2/php.ini</span><br></pre></td></tr></table></figure><h1 id="别名设置"><a href="#别名设置" class="headerlink" title="别名设置"></a>别名设置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  package vim ~/.bash_profile</span><br><span class="line"></span><br><span class="line">alias php72=/Users/uiste/Downloads/package/soft/php/bin/php</span><br><span class="line"></span><br><span class="line">➜  package source ~/.bash_profile</span><br></pre></td></tr></table></figure><h1 id="编译时指定PHP配置信息"><a href="#编译时指定PHP配置信息" class="headerlink" title="编译时指定PHP配置信息"></a>编译时指定PHP配置信息</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ./configure \</span><br><span class="line">--prefix=/usr/local/php \ # 安装路径</span><br><span class="line">--with-config-file-path=/etc # 配置路径</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;多个版本改哪个文件下的php-ini-配置才有效？&quot;&gt;&lt;a href=&quot;#多个版本改哪个文件下的php-ini-配置才有效？&quot; class=&quot;headerlink&quot; title=&quot;多个版本改哪个文件下的php.ini 配置才有效？&quot;&gt;&lt;/a&gt;多个版本改哪个文件下的
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>PHP 7.2 升级后 Yii2 升级</title>
    <link href="http://blog.uiste.com/2018/20180325-1.html"/>
    <id>http://blog.uiste.com/2018/20180325-1.html</id>
    <published>2018-03-25T07:03:44.000Z</published>
    <updated>2019-04-02T04:16:13.255Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><blockquote><p>PHP升级7.2后，Yii 2.0.12 版本由于类命名约束问题会产生如下问题：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fatal error: Cannot use &apos;Object&apos; as class name as it is reserved in /Users/uiste/www/my_project/mike-app/vendor/yiisoft/yii2/base/Object.php on line 77</span><br></pre></td></tr></table></figure><h2 id="升级方法"><a href="#升级方法" class="headerlink" title="升级方法"></a>升级方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  mike-app git:(version-update) composer install</span><br><span class="line">Loading composer repositories with package information</span><br><span class="line">Installing dependencies (including require-dev) from lock file</span><br><span class="line">Nothing to install or update</span><br><span class="line">Generating autoload files</span><br><span class="line">➜  mike-app git:(version-update) composer global require &quot;fxp/composer-asset-plugin:^1.4.1&quot;</span><br><span class="line">Changed current directory to /Users/uiste/.composer</span><br><span class="line">./composer.json has been updated</span><br><span class="line">Loading composer repositories with package information</span><br><span class="line">Updating dependencies (including require-dev)</span><br><span class="line">Package operations: 0 installs, 1 update, 0 removals</span><br><span class="line">  - Updating fxp/composer-asset-plugin (v1.2.2 =&gt; v1.4.4): Downloading (100%)         </span><br><span class="line">Writing lock file</span><br><span class="line">Generating autoload files</span><br><span class="line">➜  mike-app git:(version-update) composer update yiisoft/yii2 yiisoft/yii2-composer bower-asset/jquery.inputmask</span><br><span class="line">The &quot;extra.asset-installer-paths&quot; option is deprecated, use the &quot;config.fxp-asset.installer-paths&quot; option</span><br><span class="line">Loading composer repositories with package information</span><br><span class="line">Updating dependencies (including require-dev)                                                                                                                     GitHub API limit (60 calls/hr) is exhausted, could not fetch https://api.github.com/repos/RobinHerbots/Inputmask/contents/bower.json?ref=4.x. Create a GitHub OAuth token to go over the API rate limit. You can also wait until 2018-03-25 07:52:25 for the rate limit to reset.</span><br><span class="line"></span><br><span class="line">Head to https://github.com/settings/tokens/new?scopes=repo&amp;description=Composer+on+uiste+2018-03-25+0657</span><br><span class="line">to retrieve a token. It will be stored in &quot;/Users/uiste/.composer/auth.json&quot; for future use by Composer.</span><br><span class="line">Token (hidden):</span><br></pre></td></tr></table></figure><blockquote><p>浏览器打开：<br><code>https://github.com/settings/tokens/new?scopes=repo&amp;description=Composer+on+localhost.localdomain+2018-03-25+1945</code><br>登录github账号 生成token ，在命令行输入即可 token</p></blockquote><p>继续<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer updated</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;PHP升级7.2后，Yii 2.0.12 版本由于类命名约束问题会产生如下问题：&lt;/p&gt;
&lt;/blockquote
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>安装walle后进行检测错误总出现的问题解决</title>
    <link href="http://blog.uiste.com/2018/20180223-1.html"/>
    <id>http://blog.uiste.com/2018/20180223-1.html</id>
    <published>2018-02-23T01:05:48.000Z</published>
    <updated>2019-04-02T04:22:35.350Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装walle后进行检测错误总出现的问题解决"><a href="#安装walle后进行检测错误总出现的问题解决" class="headerlink" title="安装walle后进行检测错误总出现的问题解决"></a>安装walle后进行检测错误总出现的问题解决</h1><p>安装好 walle后，进行项目配置，但是检测总是出现错误，错误如下：</p><p>宿主机代码检出检测出错，请确认把php进程用户www的ssh-key加入git的deploy-keys列表。</p><p>目标机器检测出错，请确认php进程www用户ssh-key加入目标机器的www用户ssh-key信任列表。</p><p>目标机 ansible ping 出错，请检查 ~/.ssh/config 及 ssh 证书配置<br>目标机器检测出错，请确认www有目标机器发布版本库/data/www/publish写入权限。</p><p>解决方法：<br>  1，在宿主机安装了ansible后，就消灭了一个关于ansible未安装的问题</p><p>  2，其实我们是把宿主机器php进程用户www加入了目标机器www用户的信任authired_keys表的，但是任然报未加入，此处，主要的错误就是因为我们在目标机器中对于</p><pre><code>www用户的.ssh文件夹和authorized_keys的权限和所属者；chmod -R 755 /home/www/chmod -R 700 /home/www/.ssh/chmod -R 644 /home/www/.ssh/authorized_keys </code></pre><p> 必须满足以上三个条件才能免密码登录，同时也是解决总报没有加入目标机器信任列表的问题关键</p><p> <code>chown  www.www -R /home/www</code>      将所属者为www用户</p><blockquote><p>需要记住的宿主机和目标机器的  .ssh   authorized_keys      /home/www/   都需要注意权限问题  </p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;安装walle后进行检测错误总出现的问题解决&quot;&gt;&lt;a href=&quot;#安装walle后进行检测错误总出现的问题解决&quot; class=&quot;headerlink&quot; title=&quot;安装walle后进行检测错误总出现的问题解决&quot;&gt;&lt;/a&gt;安装walle后进行检测错误总出现的问题
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Mysql 相关命令</title>
    <link href="http://blog.uiste.com/2018/20180222-1.html"/>
    <id>http://blog.uiste.com/2018/20180222-1.html</id>
    <published>2018-02-22T02:56:08.000Z</published>
    <updated>2019-04-02T04:22:23.254Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Mysql-添加阿里RDS远程登陆用户"><a href="#Mysql-添加阿里RDS远程登陆用户" class="headerlink" title="Mysql 添加阿里RDS远程登陆用户"></a>Mysql 添加阿里RDS远程登陆用户</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; select user,host from user;</span><br><span class="line">mysql&gt; grant all privileges on *.* to &apos;dms&apos;@&apos;121.43.18.67&apos; identified by &apos;mypassword&apos;;</span><br><span class="line">mysql&gt; flush privileges; </span><br><span class="line">mysql&gt; quit;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Mysql-添加阿里RDS远程登陆用户&quot;&gt;&lt;a href=&quot;#Mysql-添加阿里RDS远程登陆用户&quot; class=&quot;headerlink&quot; title=&quot;Mysql 添加阿里RDS远程登陆用户&quot;&gt;&lt;/a&gt;Mysql 添加阿里RDS远程登陆用户&lt;/h1&gt;&lt;figu
      
    
    </summary>
    
    
  </entry>
  
</feed>
