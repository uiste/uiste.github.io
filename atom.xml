<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>uiste</title>
  <icon>https://www.gravatar.com/avatar/56992660d6f2c687a02a62364e5b9baf</icon>
  <subtitle>uiste</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.uiste.com/"/>
  <updated>2020-07-10T06:47:55.740Z</updated>
  <id>http://blog.uiste.com/</id>
  
  <author>
    <name>uiste</name>
    <email>hi@uiste.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Vim下多行同时编辑与删除技巧</title>
    <link href="http://blog.uiste.com/2020/20200426-1.html"/>
    <id>http://blog.uiste.com/2020/20200426-1.html</id>
    <published>2020-04-26T01:19:51.000Z</published>
    <updated>2020-07-10T06:47:55.740Z</updated>
    
    <content type="html"><![CDATA[<ul><li><p>方法：</p><ul><li><p>编辑：</p><ol><li><p>将光标移到要插入相同内容的第一行第一个字符上，如上面代码中<code>item 1</code>中的<code>i</code>上</p></li><li><p>按下<code>ctrl</code>+<code>v</code>进入visual block模式</p></li><li><p>按两次<code>j</code>或者<code>2j</code>，将光标移动到要插入的最后一样，如上面代码中<code>item 3</code>中的<code>i</code>上</p></li><li><p>按下<code>I</code>（大写i）进入编辑模式</p></li><li><p>开始输入要插入的内容，如<code>my_</code></p></li><li><p>按</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esc</span><br></pre></td></tr></table></figure><p>退出（</p><p>非常重要，不要忘记了</p><p>），Vim会自动在这几行前面添加相同的内容，可能需要一些运行时间。</p></li></ol></li></ul></li></ul><pre><code>插入</code></pre><ul><li><p>删除：</p><ol><li><p>将光标移到要删除相同内容的第一行第一个字符上，如代码中<code>my_item 1</code>中的<code>m</code>上</p></li><li><p>按下<code>ctrl</code>+<code>v</code>进入visual block模式</p></li><li><p>使用motion选中想要删除的所有内容，在本问题中，按两次<code>j</code>和两次<code>l</code></p></li><li><p>按下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d</span><br></pre></td></tr></table></figure><p>，同时删除所有选中的字符</p><p>删除</p></li></ol></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;&lt;p&gt;方法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;编辑：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;将光标移到要插入相同内容的第一行第一个字符上，如上面代码中&lt;code&gt;item 1&lt;/code&gt;中的&lt;code&gt;i&lt;/code&gt;上&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;按下&lt;co
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Mac启动多个微信客户端</title>
    <link href="http://blog.uiste.com/2020/20200211-1.html"/>
    <id>http://blog.uiste.com/2020/20200211-1.html</id>
    <published>2020-02-11T02:26:25.000Z</published>
    <updated>2020-04-26T01:05:35.692Z</updated>
    
    <content type="html"><![CDATA[<p><code>open -n /Applications/WeChat.app/Contents/MacOS/WeChat</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;code&gt;open -n /Applications/WeChat.app/Contents/MacOS/WeChat&lt;/code&gt;&lt;/p&gt;

      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>(六) docker 私有仓库搭建</title>
    <link href="http://blog.uiste.com/2019/20190923-4.html"/>
    <id>http://blog.uiste.com/2019/20190923-4.html</id>
    <published>2019-09-23T15:59:03.000Z</published>
    <updated>2020-04-26T01:05:29.357Z</updated>
    
    <content type="html"><![CDATA[<h1 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h1><p><code>docker run -d -v /home/registry:/var/lib/registry -p 5000:5000 --restart=always --privileged=true --name registry registry:lastest</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-v 挂载目录</span><br><span class="line">-p 端口映射</span><br><span class="line">--restart=always 在容器退出时总是重启容器</span><br><span class="line">--name 指定容器的名称</span><br></pre></td></tr></table></figure></p><h1 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h1><p><code>docker build -t redis .</code></p><h1 id="使用tag命令修改标签"><a href="#使用tag命令修改标签" class="headerlink" title="使用tag命令修改标签"></a>使用tag命令修改标签</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag redis-cluster 118.xx.xxx.54:5000/redis</span><br><span class="line">      镜像名称 IP地址：端口号 镜像名</span><br></pre></td></tr></table></figure><h1 id="推送镜像"><a href="#推送镜像" class="headerlink" title="推送镜像"></a>推送镜像</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker push 118.xx.xxx.54:5000/redis</span><br><span class="line"></span><br><span class="line"># 若报错</span><br><span class="line">echo &apos;&#123;&quot;insecure-registries&quot;:[&quot;118.xx.xxx.54:5000&quot;]&#125;&apos; &gt; /etc/docker/daemon.json</span><br><span class="line"># 然后重启docker</span><br></pre></td></tr></table></figure><h1 id="拉取私有镜像"><a href="#拉取私有镜像" class="headerlink" title="拉取私有镜像"></a>拉取私有镜像</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull 118.xx.xxx.54:5000/redis</span><br></pre></td></tr></table></figure><h1 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a>查看镜像</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 127.0.0.1:5000/v2/_catalog</span><br></pre></td></tr></table></figure><h1 id="使用私有仓库镜像"><a href="#使用私有仓库镜像" class="headerlink" title="使用私有仓库镜像"></a>使用私有仓库镜像</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name redis 118.xx.xxx.54:5000/redis</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;启动容器&quot;&gt;&lt;a href=&quot;#启动容器&quot; class=&quot;headerlink&quot; title=&quot;启动容器&quot;&gt;&lt;/a&gt;启动容器&lt;/h1&gt;&lt;p&gt;&lt;code&gt;docker run -d -v /home/registry:/var/lib/registry -p 500
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>(五) docker-swarm 集群管理工具</title>
    <link href="http://blog.uiste.com/2019/20190923-3.html"/>
    <id>http://blog.uiste.com/2019/20190923-3.html</id>
    <published>2019-09-23T15:59:02.000Z</published>
    <updated>2020-04-26T01:05:29.356Z</updated>
    
    <content type="html"><![CDATA[<p>swarm deamon 只是一个调度器加路由器，swarm自己不运行容器，它只是接受docker客户端发送过来的请求，调度适合的节点来运行容器。</p><p><a href="https://www.cnblogs.com/liuyansheng/p/8178341.html" target="_blank" rel="noopener">DOCKER管理工具-SWARM部署记录</a></p><h1 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h1><h2 id="manager初始化"><a href="#manager初始化" class="headerlink" title="manager初始化"></a>manager初始化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr 47.99.236.50</span><br></pre></td></tr></table></figure><h2 id="加入节点"><a href="#加入节点" class="headerlink" title="加入节点"></a>加入节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 作为worker加入到swarm</span><br><span class="line">docker swarm join --token SWMTKN-1-3xt1c2h1aek21zlh15nq1fg29o2i8yhxjsw8j59f9ngddpvihf-d0tb91hx2krdysuwfepv8dny9 47.99.236.50:2377</span><br><span class="line"></span><br><span class="line"># 作为manager加入到swarm</span><br><span class="line">docker swarm join-token manager</span><br></pre></td></tr></table></figure><h2 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node ls</span><br></pre></td></tr></table></figure><h2 id="节点升降级"><a href="#节点升降级" class="headerlink" title="节点升降级"></a>节点升降级</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将节点升级为manager：docker node promote 节点名</span><br><span class="line">将节点降级为worker： docker node demote 节点名</span><br></pre></td></tr></table></figure><h2 id="端口开放"><a href="#端口开放" class="headerlink" title="端口开放"></a>端口开放</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2377 集群管理端口</span><br><span class="line">7946 tcp/udp端口 节点间通讯</span><br><span class="line">4789 用于覆盖网络流量</span><br></pre></td></tr></table></figure><h2 id="操作记录"><a href="#操作记录" class="headerlink" title="操作记录"></a>操作记录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@manager ~]# docker swarm init --advertise-addr 47.99.236.50</span><br><span class="line">Swarm initialized: current node (038olxese1szrj1f0am0mi0ab) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-3xt1c2h1aek21zlh15nq1fg29o2i8yhxjsw8j59f9ngddpvihf-d0tb91hx2krdysuwfepv8dny9 47.99.236.50:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br><span class="line"></span><br><span class="line">[root@manager ~]# docker swarm join-token worker</span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-3xt1c2h1aek21zlh15nq1fg29o2i8yhxjsw8j59f9ngddpvihf-d0tb91hx2krdysuwfepv8dny9 47.99.236.50:2377</span><br><span class="line"></span><br><span class="line">[root@manager ~]# docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">038olxese1szrj1f0am0mi0ab *   manager             Ready               Active              Leader              19.03.5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@worker1 ~]# docker swarm join --token SWMTKN-1-3xt1c2h1aek21zlh15nq1fg29o2i8yhxjsw8j59f9ngddpvihf-d0tb91hx2krdysuwfepv8dny9 47.99.236.50:2377</span><br><span class="line">This node joined a swarm as a worker.</span><br><span class="line"></span><br><span class="line">[root@manager ~]# docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">038olxese1szrj1f0am0mi0ab *   manager             Ready               Active              Leader              19.03.5</span><br><span class="line">k34cve7sd9au2zu5a4phwvokv     worker1             Ready               Active</span><br></pre></td></tr></table></figure><h1 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h1><h2 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker service create --replicas 5  -p 8080:80 --name nginx  nginx</span><br><span class="line"></span><br><span class="line">--replicas 服务数量</span><br></pre></td></tr></table></figure><h2 id="更新服务"><a href="#更新服务" class="headerlink" title="更新服务"></a>更新服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service update --image nginx:alpine nginx</span><br></pre></td></tr></table></figure><h2 id="删除服务"><a href="#删除服务" class="headerlink" title="删除服务"></a>删除服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service rm nginx</span><br></pre></td></tr></table></figure><h2 id="服务实例"><a href="#服务实例" class="headerlink" title="服务实例"></a>服务实例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker service scale nginx=0</span><br><span class="line">docker service scale nginx=5</span><br></pre></td></tr></table></figure><h2 id="查看服务容器状态"><a href="#查看服务容器状态" class="headerlink" title="查看服务容器状态"></a>查看服务容器状态</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service ps nginx</span><br></pre></td></tr></table></figure><h2 id="查看服务的详细信息"><a href="#查看服务的详细信息" class="headerlink" title="查看服务的详细信息"></a>查看服务的详细信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service inspect nginx</span><br></pre></td></tr></table></figure><blockquote><p>docker swarm 默认就实现了轮询的负载均衡</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 进入swarm节点机器配置</span><br><span class="line">docker config create redis.conf redis.conf</span><br><span class="line"> 配置文件名称  文件地址</span><br></pre></td></tr></table></figure><h2 id="网络共享问题"><a href="#网络共享问题" class="headerlink" title="网络共享问题"></a>网络共享问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver=overlay myOverly</span><br></pre></td></tr></table></figure><p>docker-compose.yaml<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">"3.6"</span></span><br><span class="line">services:</span><br><span class="line">  redis-master1:</span><br><span class="line">     image: redis:3.2.2</span><br><span class="line">     ports:</span><br><span class="line">       - <span class="string">"6397:6397"</span></span><br><span class="line">       - <span class="string">"16397:16397"</span></span><br><span class="line">     stdin_open: <span class="literal">true</span></span><br><span class="line">     deploy:</span><br><span class="line">        mode: replicated</span><br><span class="line">        replicas: 2</span><br><span class="line">     networks:</span><br><span class="line">        - cluster</span><br><span class="line">     tty: <span class="literal">true</span></span><br><span class="line">     configs:</span><br><span class="line">       - <span class="built_in">source</span>: redis.conf</span><br><span class="line">         target: /root/redis.conf</span><br><span class="line">     privileged: <span class="literal">true</span></span><br><span class="line">     volumes: [<span class="string">"/root/config:/data"</span>]</span><br><span class="line">configs:</span><br><span class="line">  redis.conf:</span><br><span class="line">    external: <span class="literal">true</span></span><br><span class="line">networks:</span><br><span class="line">     cluster:</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 进入swarm节点机器配置</span><br><span class="line">docker stack deploy -c docker-compose.yaml redis-cluster</span><br></pre></td></tr></table></figure><h2 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker service update --update-parallelism 2  --image demo:2.0 --update-delay 10s test</span><br><span class="line"></span><br><span class="line">--update-parallelism  参数用来指定最大同步更新任务数。</span><br><span class="line">--update-delay       两次更新的间隔，单位默认为秒</span><br></pre></td></tr></table></figure><blockquote><p>可以测试更新镜像版本的时候客户端并不会断开连接，服务平滑升级，即服务不停机更新，客户端无感知。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;swarm deamon 只是一个调度器加路由器，swarm自己不运行容器，它只是接受docker客户端发送过来的请求，调度适合的节点来运行容器。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.cnblogs.com/liuyansheng/p/8178341.h
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>(四) docker-machine 集群伸缩</title>
    <link href="http://blog.uiste.com/2019/20190923-2.html"/>
    <id>http://blog.uiste.com/2019/20190923-2.html</id>
    <published>2019-09-23T15:59:01.000Z</published>
    <updated>2020-04-26T11:04:25.246Z</updated>
    
    <content type="html"><![CDATA[<p>使用docker-machine ，可以启动、审查、停止、重新启动托管的宿主机、升级docker客户端和守护程序，并配置docker客户端与宿主机通信。</p><h1 id="安装docker-machine"><a href="#安装docker-machine" class="headerlink" title="安装docker-machine"></a>安装docker-machine</h1><p>If you are running macOS:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ base=https://github.com/docker/machine/releases/download/v0.16.0 &amp;&amp;</span><br><span class="line">  curl -L $base/docker-machine-$(uname -s)-$(uname -m) &gt;/usr/local/bin/docker-machine &amp;&amp;</span><br><span class="line">  chmod +x /usr/local/bin/docker-machine</span><br></pre></td></tr></table></figure></p><p>If you are running Linux:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ base=https://github.com/docker/machine/releases/download/v0.16.0 &amp;&amp;</span><br><span class="line">  curl -L $base/docker-machine-$(uname -s)-$(uname -m) &gt;/tmp/docker-machine &amp;&amp;</span><br><span class="line">  sudo mv /tmp/docker-machine /usr/local/bin/docker-machine &amp;&amp;</span><br><span class="line">  chmod +x /usr/local/bin/docker-machine</span><br></pre></td></tr></table></figure></p><p>If you are running Windows with Git BASH:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ base=https://github.com/docker/machine/releases/download/v0.16.0 &amp;&amp;</span><br><span class="line">  mkdir -p &quot;$HOME/bin&quot; &amp;&amp;</span><br><span class="line">  curl -L $base/docker-machine-Windows-x86_64.exe &gt; &quot;$HOME/bin/docker-machine.exe&quot; &amp;&amp;</span><br><span class="line">  chmod +x &quot;$HOME/bin/docker-machine.exe&quot;</span><br></pre></td></tr></table></figure></p><p>参考: <a href="https://docs.docker.com/machine/install-machine/" target="_blank" rel="noopener">官方文档</a></p><h1 id="下载阿里云docker-machine驱动"><a href="#下载阿里云docker-machine驱动" class="headerlink" title="下载阿里云docker-machine驱动"></a>下载阿里云docker-machine驱动</h1><h2 id="下载docker-machine阿里云驱动"><a href="#下载docker-machine阿里云驱动" class="headerlink" title="下载docker-machine阿里云驱动"></a>下载docker-machine阿里云驱动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 下载</span><br><span class="line">wget https://docker-machine-drivers.oss-cn-beijing.aliyuncs.com/docker-machine-driver-aliyunecs_linux-amd64.tgz</span><br><span class="line"></span><br><span class="line"># 解压</span><br><span class="line">tar zxvf docker-machine-driver-aliyunecs_linux-amd64.tgz</span><br><span class="line"></span><br><span class="line"># 移动</span><br><span class="line">mv ./bin/docker-machine-driver-aliyunecs.linux-amd64 /usr/local/bin/docker-machine-driver-aliyunecs</span><br><span class="line"></span><br><span class="line"># 权限</span><br><span class="line">chmod +x  /usr/local/bin/docker-machine-driver-aliyunecs</span><br><span class="line"></span><br><span class="line"># 创建</span><br><span class="line">docker-machine create -d aliyunecs --aliyunecs-io-optimized=optimized    --aliyunecs-description=aliyunecs-machine-driver  --aliyunecs-instance-type=ecs.mn4.small   --aliyunecs-access-key-id=&apos;&lt;Your access key ID&gt;&apos; --aliyunecs-access-key-secret=&apos;&lt;Your secret access key&gt;&apos; --aliyunecs-region=cn-hangzhou  --aliyunecs-ssh-password=zaq1@wsx  manager</span><br><span class="line"></span><br><span class="line">--aliyunecs-io-optimized=optimized     //磁盘io优化</span><br><span class="line">--aliyunecs-description=aliyunecs-machine-driver   //描述</span><br><span class="line">--aliyunecs-instance-type=ecs.mn4.small     //实例规格</span><br><span class="line">--aliyunecs-access-key-id=LTxxxcxx      // key</span><br><span class="line">--aliyunecs-access-key-secret=Axxx     //秘钥</span><br><span class="line">--aliyunecs-region=cn-hangzhou     //地区</span><br><span class="line">--aliyunecs-ssh-password=zaq1@wsx  //ssh登录密码</span><br><span class="line">–aliyunecs-image-id=centos_7_04_64_20G_alibase_201701015.vhd  //镜像实例</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果创建失败可以用下面命令删除</span><br><span class="line">docker-machine rm bboysoul --force</span><br></pre></td></tr></table></figure><p>参考: <a href="https://yq.aliyun.com/articles/411336?spm=a2c4e.11153940.0.0.72882defNeF9bp" target="_blank" rel="noopener">docker machine介绍和使用文档</a></p><p>想要创建一个阿里云虚拟化示例，需要满足几个条件</p><ol><li>账户余额大于100，因为创建的实例为按量付费</li><li>设置accesskey，需要具备操作账户的权限</li></ol><h2 id="操作记录"><a href="#操作记录" class="headerlink" title="操作记录"></a>操作记录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# base=https://github.com/docker/machine/releases/download/v0.16.0 &amp;&amp;</span><br><span class="line">&gt;   curl -L $base/docker-machine-$(uname -s)-$(uname -m) &gt;/tmp/docker-machine &amp;&amp;</span><br><span class="line">&gt;   sudo mv /tmp/docker-machine /usr/local/bin/docker-machine &amp;&amp;</span><br><span class="line">&gt;   chmod +x /usr/local/bin/docker-machine</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   617    0   617    0     0    310      0 --:--:--  0:00:01 --:--:--   310</span><br><span class="line">100 26.8M  100 26.8M    0     0  14897      0  0:31:30  0:31:30 --:--:-- 20899</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# docker-machine -v</span><br><span class="line">docker-machine version 0.16.0, build 702c267f</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# wget https://docker-machine-drivers.oss-cn-beijing.aliyuncs.com/docker-machine-driver-aliyunecs_linux-amd64.tgz</span><br><span class="line">--2019-09-25 13:17:50--  https://docker-machine-drivers.oss-cn-beijing.aliyuncs.com/docker-machine-driver-aliyunecs_linux-amd64.tgz</span><br><span class="line">正在解析主机 docker-machine-drivers.oss-cn-beijing.aliyuncs.com (docker-machine-drivers.oss-cn-beijing.aliyuncs.com)... 59.110.185.69</span><br><span class="line">正在连接 docker-machine-drivers.oss-cn-beijing.aliyuncs.com (docker-machine-drivers.oss-cn-beijing.aliyuncs.com)|59.110.185.69|:443... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：3852839 (3.7M) [application/gzip]</span><br><span class="line">正在保存至: “docker-machine-driver-aliyunecs_linux-amd64.tgz”</span><br><span class="line"></span><br><span class="line">100%[=================================================================================================================================================================================&gt;] 3,852,839   14.3MB/s 用时 0.3s</span><br><span class="line"></span><br><span class="line">2019-09-25 13:17:50 (14.3 MB/s) - 已保存 “docker-machine-driver-aliyunecs_linux-amd64.tgz” [3852839/3852839])</span><br><span class="line"></span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# ls</span><br><span class="line">dms-db-gateway  dms-db-gateway.tar.gz  docker-machine-driver-aliyunecs_linux-amd64.tgz  php-7.0.1  php7.tar.gz  walle-web.zip</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# tar zxvf docker-machine-driver-aliyunecs_linux-amd64.tgz</span><br><span class="line">bin/docker-machine-driver-aliyunecs.linux-amd64</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# mv ./bin/docker-machine-driver-aliyunecs.linux-amd64 /usr/local/bin/docker-machine-driver-aliyunecs</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# chmod +x  /usr/local/bin/docker-machine-driver-aliyunecs</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]#</span><br><span class="line"></span><br><span class="line"># 命令</span><br><span class="line">docker-machine create -d aliyunecs \</span><br><span class="line">--aliyunecs-access-key-id=&apos;&lt;Your access key ID&gt;&apos; \</span><br><span class="line">--aliyunecs-access-key-secret=&apos;&lt;Your secret access key&gt;&apos; \</span><br><span class="line">--aliyunecs-system-disk-size=&apos;40&apos; \</span><br><span class="line">--aliyunecs-image-id=&apos;centos_7_05_64_20G_alibase_20181210.vhd&apos; \</span><br><span class="line">--aliyunecs-io-optimized=&apos;true&apos; \</span><br><span class="line">--aliyunecs-instance-type=&apos;ecs.t5-lc2m1.nano&apos; \</span><br><span class="line">--aliyunecs-internet-max-bandwidth=&apos;1&apos; \</span><br><span class="line">--aliyunecs-region=&apos;cn-hangzhou&apos; \</span><br><span class="line">--aliyunecs-ssh-password=&apos;&lt;Your ssh password&gt;&apos; \</span><br><span class="line">--aliyunecs-zone=&apos;cn-hangzhou-i&apos; \</span><br><span class="line"></span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# docker-machine create -d aliyunecs --aliyunecs-access-key-id=&apos;&lt;Your access key ID&gt;&apos; --aliyunecs-access-key-secret=&apos;&lt;Your secret access key&gt;&apos; --aliyunecs-system-disk-size=&apos;40&apos; --aliyunecs-image-id=&apos;centos_7_05_64_20G_alibase_20181210.vhd&apos; --aliyunecs-io-optimized=&apos;true&apos; --aliyunecs-instance-type=&apos;ecs.t5-lc2m1.nano&apos; --aliyunecs-internet-max-bandwidth=&apos;1&apos; --aliyunecs-region=&apos;cn-hangzhou&apos; --aliyunecs-ssh-password=&apos;&lt;Your ssh password&gt;&apos; --aliyunecs-zone=&apos;cn-hangzhou-i&apos; manager</span><br><span class="line">Running pre-create checks...</span><br><span class="line">Creating machine...</span><br><span class="line">(manager) manager | Creating key pair for instance ...</span><br><span class="line">(manager) manager | Configuring security groups instance ...</span><br><span class="line">(manager) manager | Creating instance with image centos_7_05_64_20G_alibase_20181210.vhd ...</span><br><span class="line">(manager) manager | Create instance i-bp18so0vhjjsk6xyynep successfully</span><br><span class="line">(manager) manager | Allocate publice IP address 47.99.236.50 for instance i-bp18so0vhjjsk6xyynep successfully</span><br><span class="line">(manager) manager | Starting instance i-bp18so0vhjjsk6xyynep ...</span><br><span class="line">(manager) manager | Start instance i-bp18so0vhjjsk6xyynep successfully</span><br><span class="line">(manager) manager | Waiting SSH service 47.99.236.50:22 is ready to connect ...</span><br><span class="line">(manager) manager | Uploading SSH keypair to 47.99.236.50:22 ...</span><br><span class="line">(manager) manager | Created instance i-bp18so0vhjjsk6xyynep successfully with public IP address 47.99.236.50 and private IP address 172.16.142.104</span><br><span class="line">Waiting for machine to be running, this may take a few minutes...</span><br><span class="line">Detecting operating system of created instance...</span><br><span class="line">Waiting for SSH to be available...</span><br><span class="line">Detecting the provisioner...</span><br><span class="line">Provisioning with centos...</span><br><span class="line">Copying certs to the local machine directory...</span><br><span class="line">Copying certs to the remote machine...</span><br><span class="line">Setting Docker configuration on the remote daemon...</span><br><span class="line">Checking connection to Docker...</span><br><span class="line">Docker is up and running!</span><br><span class="line">To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env manager</span><br></pre></td></tr></table></figure><p><img src="../../../assets/imgs/201909230201.png" alt="ECS实例图示"></p><h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><p>杭州镜像创建：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create -d aliyunecs \</span><br><span class="line">--aliyunecs-access-key-id=&apos;&lt;Your access key ID&gt;&apos; \</span><br><span class="line">--aliyunecs-access-key-secret=&apos;&lt;Your secret access key&gt;&apos; \</span><br><span class="line">--aliyunecs-system-disk-size=&apos;40&apos; \</span><br><span class="line">--aliyunecs-image-id=&apos;centos_7_05_64_20G_alibase_20181210.vhd&apos; \</span><br><span class="line">--aliyunecs-io-optimized=&apos;true&apos; \</span><br><span class="line">--aliyunecs-instance-type=&apos;ecs.t5-lc2m1.nano&apos; \</span><br><span class="line">--aliyunecs-internet-max-bandwidth=&apos;1&apos; \</span><br><span class="line">--aliyunecs-region=&apos;cn-hangzhou&apos; \</span><br><span class="line">--aliyunecs-ssh-password=&apos;&lt;Your ssh password&gt;&apos; \</span><br><span class="line">--aliyunecs-zone=&apos;cn-hangzhou-i&apos; \</span><br><span class="line">worker1</span><br><span class="line"></span><br><span class="line">--aliyunecs-zoneECS_ZONE-可用区id，这个我没有找到，后来是用阿里云openapi explorer查出来的</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://api.aliyun.com/?spm=a2c4g.11186623.2.8.2a6f7f49RdvJPV#/?product=Ecs&amp;api=DescribeZones&amp;params=&#123;%22RegionId%22:%22cn-hangzhou%22&#125;&amp;tab=DEMO&amp;lang=JAVA</span><br><span class="line"></span><br><span class="line">--aliyunecs-image-idECS_IMAGE_ID-ecs镜像id，我找这个找了很久，因为找的是公共镜像，公共镜像id在控制台，云服务器ECS，镜像，公共镜像里有</span><br></pre></td></tr></table></figure></p><h1 id="删除服务器"><a href="#删除服务器" class="headerlink" title="删除服务器"></a>删除服务器</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# docker-machine ls</span><br><span class="line">NAME      ACTIVE   DRIVER      STATE     URL                        SWARM   DOCKER     ERRORS</span><br><span class="line">manager   -        aliyunecs   Running   tcp://139.224.56.70:2376           v1.12.6</span><br><span class="line">worker1   -        aliyunecs   Running   tcp://121.41.65.234:2376           v19.03.5</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# docker-machine rm manager</span><br><span class="line">About to remove manager</span><br><span class="line">WARNING: This action will delete both local reference and remote instance.</span><br><span class="line">Are you sure? (y/n): y</span><br><span class="line">(manager) manager | Remove instance i-uf6afru7j8ieppzodrls ...</span><br><span class="line">(manager) manager | Deleting instance: i-uf6afru7j8ieppzodrls</span><br><span class="line">Successfully removed manager</span><br></pre></td></tr></table></figure><h1 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h1><h2 id="链接服务器"><a href="#链接服务器" class="headerlink" title="链接服务器"></a>链接服务器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# docker-machine env manager</span><br><span class="line">export DOCKER_TLS_VERIFY=&quot;1&quot;</span><br><span class="line">export DOCKER_HOST=&quot;tcp://139.224.56.70:2376&quot;</span><br><span class="line">export DOCKER_CERT_PATH=&quot;/root/.docker/machine/machines/manager&quot;</span><br><span class="line">export DOCKER_MACHINE_NAME=&quot;manager&quot;</span><br><span class="line"># Run this command to configure your shell:</span><br><span class="line"># eval $(docker-machine env manager)</span><br><span class="line"></span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# docker-machine ssh manager</span><br><span class="line">Last login: Mon Nov 25 14:11:18 CST 2019 from 47.96.181.251 on ssh</span><br><span class="line"></span><br><span class="line">Welcome to Alibaba Cloud Elastic Compute Service !</span><br><span class="line"></span><br><span class="line">manager ~ #</span><br></pre></td></tr></table></figure><h2 id="查看主机配置信息"><a href="#查看主机配置信息" class="headerlink" title="查看主机配置信息"></a>查看主机配置信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-machine config [options]</span><br><span class="line"></span><br><span class="line">docker-machine config worker1</span><br></pre></td></tr></table></figure><h2 id="挂载共享目录"><a href="#挂载共享目录" class="headerlink" title="挂载共享目录"></a>挂载共享目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install fuse-sshfs</span><br><span class="line"></span><br><span class="line">[machine:][path] [mountpoint]</span><br><span class="line"></span><br><span class="line">docker-machine mount worker1:/root/test test</span><br></pre></td></tr></table></figure><blockquote><p>sshfs可以把远程主机的文件系统映射到本地主机上，透过ssh把远程文件系统挂载到本机上，这样可以不必使用scp工具就可以做到直接复制及删除远程主机的文件了。就像操作本地磁盘一样方便。<br>注意如果挂载的文件不为空，会提示让你设置参数，但是docker-machine mount 是不支持的</p></blockquote><p>下面这种方式可以，但是会将现有文件的内容清空，谨慎使用<br><code>sshfs root@121.xxx.xxx.187:/root/worker1 worker1 -o nonempty</code></p><p>docker-machine操作步骤<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# yum install fuse-sshfs -y</span><br><span class="line"></span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# mkdir data</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# pwd</span><br><span class="line">/root</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# docker-machine mount manager:/data ./data</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# cd data/</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz data]# touch remark.md</span><br><span class="line">[root@izbp1bb2egi7vzn29c1dhvz data]# cat remark.md</span><br><span class="line">挂载成功</span><br></pre></td></tr></table></figure></p><p>docker-manager操作步骤<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@izbp1bb2egi7vzn29c1dhvz ~]# docker-machine ssh manager</span><br><span class="line">Last login: Mon Nov 25 16:10:53 2019 from 47.96.181.251</span><br><span class="line"></span><br><span class="line">Welcome to Alibaba Cloud Elastic Compute Service !</span><br><span class="line"></span><br><span class="line">[root@manager ~]# ll</span><br><span class="line">total 0</span><br><span class="line">[root@manager ~]# mkdir /data</span><br><span class="line">[root@manager ~]# vim /data/remark.md</span><br><span class="line">挂载成功</span><br><span class="line"></span><br><span class="line">[root@manager ~]# cat /data/remark.md</span><br><span class="line">挂载成功</span><br></pre></td></tr></table></figure></p><blockquote><p>取消挂载 -u<br><code>docker-machine mount -u manager:/data ./data</code><br>一个目录只能被挂载到一台机器上</p></blockquote><p><img src="../../../assets/imgs/201909230202.png" alt="图示"></p><h2 id="拷贝文件-SCP"><a href="#拷贝文件-SCP" class="headerlink" title="拷贝文件 SCP"></a>拷贝文件 SCP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-machine scp -r host1:/tmp/a(源地址) host2:/tmp/b(目标地址)</span><br><span class="line"></span><br><span class="line">-r 递归目录拷贝</span><br><span class="line">-d 大文件增量拷贝</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;使用docker-machine ，可以启动、审查、停止、重新启动托管的宿主机、升级docker客户端和守护程序，并配置docker客户端与宿主机通信。&lt;/p&gt;
&lt;h1 id=&quot;安装docker-machine&quot;&gt;&lt;a href=&quot;#安装docker-machine&quot; cl
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>(三)redis docker 集群配置</title>
    <link href="http://blog.uiste.com/2019/20190923-1.html"/>
    <id>http://blog.uiste.com/2019/20190923-1.html</id>
    <published>2019-09-23T08:35:26.000Z</published>
    <updated>2020-04-26T01:05:29.354Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><blockquote><p>当业务场景需要足够大量的Redis存储时，主从结构+哨兵可以实现高可用故障切换+冗余备份，但是并不能解决数据容量的问题，用哨兵Redis每个势力也是全量存储，每个Redis存储的内容都是完整的数据，良妃内存且存在木桶效应。<br>为了最大化利用内存，可以采用cluster集群，就是分布式存储。即每台Redis存储不同的内容。</p></blockquote><p>分布式方案：</p><ol><li>客户端分区方案：优点是分区逻辑可控，缺点是需要自己处理数据路由、高可用、故障转移等问题。在redis2.8之前使用key的hashcode取余分布到不同的节点，一旦节点的增删，都会导致key无法命中。</li><li>代理方案：简化客户端分布式逻辑和升级维护遍历。缺点是加重架构部署复杂度和性能损耗，如：twemproxy,codis</li><li>官方为我们提供了专有的集群方案：redis cluster</li></ol><p>redis集群提供了以下两个好处：</p><ol><li>将数据自动切分到多个节点的能力</li><li>当集群中的一部分节点失效或者无法进行通讯时，仍然可以继续处理名利请求的能力，拥有自动故障转移的能力</li><li>客户端可以与任何一个节点相连接，然后就可以访问集群中的任何一个节点，对其进行存取和其它操作</li></ol><h1 id="redis-cluster-vs-replication-sentinal-如何选择"><a href="#redis-cluster-vs-replication-sentinal-如何选择" class="headerlink" title="redis cluster vs replication + sentinal 如何选择"></a>redis cluster vs replication + sentinal 如何选择</h1><ol><li>如果数据很少，主要是承载高并发高性能的场景，单机即可</li><li>replication：一个master，多个slave，要几个slave跟你要求的读吞吐量有关系，结合sentinal集群，去保证Redis主从架构的高可用性，就可以了</li><li>redis cluster：主要是针对海量数据+高并发+高可用的场景</li></ol><h1 id="分布式是如何进行的"><a href="#分布式是如何进行的" class="headerlink" title="分布式是如何进行的"></a>分布式是如何进行的</h1><p>顺序分区和哈希分区</p><p>数据倾斜 + 数据迁移 + 节点伸缩 </p><blockquote><p>顺序分区：会导致数据倾斜，主要是访问倾斜。每次点击会重点访问某台机器，这就导致最后数据都到这台机器上了。<br>哈希分区：但需要扩容时，专业上称之为”节点伸缩“，这个时候，因为是哈希算法，会导致数据迁移。<br>一致性哈希：加减节点会造成哈希环中部分数据无法命中，需要手动处理或者忽略这部分数据，因此一致性哈希常用于缓存场景。<br>虚拟槽分区：使用CRC16算法，钱庙的使用了哈希空间，使用分散度良好的哈希函数把所有数据映射到一个固定范围的整数集合中，整数定义为槽。redis cluster槽的范围是0~16383，槽是集群内数据管理和迁移的基本单位。采用大范围槽的主要母的是为了方便数据拆分和集群扩展。每个节点会负责一定数量的槽。每当key访问过来，redis cluster会计算哈希值是否在这个区间里。它们彼此都知道对应的槽在哪台机器上，这样就能做到平均分配了。</p></blockquote><p>集群限制</p><blockquote><p>key批量操作，mget()</p></blockquote><h1 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h1><blockquote><p>Docker Compose 是 Docker 官方编排（Orchestration）项目之一，负责快速的部署分布式应<br>用。Compose 允许用户通过一个单独的 docker-compose.yml 模板文件<br>（YAML 格式）来定义一组相关联的应用容器为一个项目（project）。<br>Compose 中有两个重要的概念：</p><ul><li>服务 ( service )：一个应用的容器，实际上可以包括若干运行相同镜像的容器实例。</li><li>项目 ( project )：由一组关联的应用容器组成的一个完整业务单元，在 dockercompose.yml 文件中定义。</li></ul></blockquote><h1 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#节点端口</span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line">#开启集群模式</span><br><span class="line">cluster-enabled yes</span><br><span class="line"></span><br><span class="line">#节点超时时间，单位毫秒</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line"></span><br><span class="line">#集群内部配置文件</span><br><span class="line">cluster-config-file ”nodes-6379.conf“</span><br></pre></td></tr></table></figure><h2 id="构建redis-cluster镜像"><a href="#构建redis-cluster镜像" class="headerlink" title="构建redis-cluster镜像"></a>构建redis-cluster镜像</h2><p>文件路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos usr]# tree /usr/docker/</span><br><span class="line">/usr/docker/</span><br><span class="line">└── redis</span><br><span class="line">    ├── config</span><br><span class="line">    │   ├── nodes-6391.conf</span><br><span class="line">    │   ├── nodes-6392.conf</span><br><span class="line">    │   ├── nodes-6393.conf</span><br><span class="line">    │   ├── nodes-6394.conf</span><br><span class="line">    │   ├── nodes-6395.conf</span><br><span class="line">    │   ├── nodes-6396.conf</span><br><span class="line">    │   ├── redis.sh</span><br><span class="line">    │   └── redis-trib.rb</span><br><span class="line">    └── Dockerfile</span><br><span class="line"></span><br><span class="line">2 directories, 9 files</span><br></pre></td></tr></table></figure></p><p>Dockerfile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:latest</span><br><span class="line">RUN groupadd -r redis &amp;&amp; useradd  -r -g redis redis</span><br><span class="line">RUN  yum -y install wget \</span><br><span class="line">&amp;&amp; wget http://mirrors.sohu.com/fedora-epel/epel-release-latest-8.noarch.rpm \</span><br><span class="line">&amp;&amp; rpm -ivh epel-release-latest-8.noarch.rpm \</span><br><span class="line">&amp;&amp; yum clean all &amp;&amp; yum makecache &amp;&amp; yum -y update &amp;&amp;  yum -y install epel-release \</span><br><span class="line">&amp;&amp;   yum -y install redis  &amp;&amp; yum -y install wget \</span><br><span class="line">&amp;&amp;   yum -y install net-tools \</span><br><span class="line">&amp;&amp;   yum -y install  ruby &amp;&amp; yum  -y install  rubygems</span><br><span class="line">RUN wget https://nuoyit.oss-cn-hangzhou.aliyuncs.com/package/redis-3.2.1.gem  &amp;&amp;  gem install -l ./redis-3.2.1.gem \</span><br><span class="line">&amp;&amp;  rm -f redis-3.2.1.gem</span><br><span class="line">COPY  ./config/redis-trib.rb  /usr/bin</span><br><span class="line">COPY  ./config/redis.sh       /usr/bin</span><br><span class="line">RUN  mkdir -p /config  &amp;&amp; chmod  775  /usr/bin/redis.sh</span><br></pre></td></tr></table></figure></p><blockquote><p>dockerfile处理了在腾讯云装epel-release源问题，参考文章：<br><a href="http://www.mamicode.com/info-detail-2297252.html" target="_blank" rel="noopener">CentOS安装epel源详解</a></p></blockquote><p>构建镜像<br><code>docker build -t redis-cluster .</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos redis]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">redis-cluster       latest              cda424fce4bf        2 minutes ago       391MB</span><br></pre></td></tr></table></figure><h2 id="准备节点"><a href="#准备节点" class="headerlink" title="准备节点"></a>准备节点</h2><p>docker-compose.yml<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">"3.6"</span></span><br><span class="line">services:</span><br><span class="line">  redis-cluster-master1:</span><br><span class="line">     image: redis-cluster</span><br><span class="line">     container_name: redis-cluster-master1</span><br><span class="line">     working_dir: /config</span><br><span class="line">     environment:</span><br><span class="line">       - PORT=6391</span><br><span class="line">     ports:</span><br><span class="line">       - <span class="string">"6391:6391"</span></span><br><span class="line">       - <span class="string">"16391:16391"</span></span><br><span class="line">     stdin_open: <span class="literal">true</span></span><br><span class="line">     networks:</span><br><span class="line">        redis-master:</span><br><span class="line">          ipv4_address: 172.50.0.2</span><br><span class="line">     tty: <span class="literal">true</span></span><br><span class="line">     privileged: <span class="literal">true</span></span><br><span class="line">     volumes: [<span class="string">"/usr/docker/redis/config:/config"</span>]</span><br><span class="line">     entrypoint:</span><br><span class="line">       - /bin/bash</span><br><span class="line">       - redis.sh</span><br><span class="line">  redis-cluster-master2:</span><br><span class="line">       image: redis-cluster</span><br><span class="line">       working_dir: /config</span><br><span class="line">       container_name: redis-cluster-master2</span><br><span class="line">       environment:</span><br><span class="line">              - PORT=6392</span><br><span class="line">       networks:</span><br><span class="line">          redis-master:</span><br><span class="line">             ipv4_address: 172.50.0.3</span><br><span class="line">       ports:</span><br><span class="line">         - <span class="string">"6392:6392"</span></span><br><span class="line">         - <span class="string">"16392:16392"</span></span><br><span class="line">       stdin_open: <span class="literal">true</span></span><br><span class="line">       tty: <span class="literal">true</span></span><br><span class="line">       privileged: <span class="literal">true</span></span><br><span class="line">       volumes: [<span class="string">"/usr/docker/redis/config:/config"</span>]</span><br><span class="line">       entrypoint:</span><br><span class="line">         - /bin/bash</span><br><span class="line">         - redis.sh</span><br><span class="line">  redis-cluster-master3:</span><br><span class="line">       image: redis-cluster</span><br><span class="line">       container_name: redis-cluster-master3</span><br><span class="line">       working_dir: /config</span><br><span class="line">       environment:</span><br><span class="line">              - PORT=6393</span><br><span class="line">       networks:</span><br><span class="line">          redis-master:</span><br><span class="line">            ipv4_address: 172.50.0.4</span><br><span class="line">       ports:</span><br><span class="line">         - <span class="string">"6393:6393"</span></span><br><span class="line">         - <span class="string">"16393:16393"</span></span><br><span class="line">       stdin_open: <span class="literal">true</span></span><br><span class="line">       tty: <span class="literal">true</span></span><br><span class="line">       privileged: <span class="literal">true</span></span><br><span class="line">       volumes: [<span class="string">"/usr/docker/redis/config:/config"</span>]</span><br><span class="line">       entrypoint:</span><br><span class="line">         - /bin/bash</span><br><span class="line">         - redis.sh</span><br><span class="line">  redis-cluster-slave1:</span><br><span class="line">       image: redis-cluster</span><br><span class="line">       container_name: redis-cluster-slave1</span><br><span class="line">       working_dir: /config</span><br><span class="line">       environment:</span><br><span class="line">            - PORT=6394</span><br><span class="line">       networks:</span><br><span class="line">          redis-slave:</span><br><span class="line">             ipv4_address: 172.30.0.2</span><br><span class="line">       ports:</span><br><span class="line">         - <span class="string">"6394:6394"</span></span><br><span class="line">         - <span class="string">"16394:16394"</span></span><br><span class="line">       stdin_open: <span class="literal">true</span></span><br><span class="line">       tty: <span class="literal">true</span></span><br><span class="line">       privileged: <span class="literal">true</span></span><br><span class="line">       volumes: [<span class="string">"/usr/docker/redis/config:/config"</span>]</span><br><span class="line">       entrypoint:</span><br><span class="line">         - /bin/bash</span><br><span class="line">         - redis.sh</span><br><span class="line">  redis-cluster-slave2:</span><br><span class="line">       image: redis-cluster</span><br><span class="line">       working_dir: /config</span><br><span class="line">       container_name: redis-cluster-slave2</span><br><span class="line">       environment:</span><br><span class="line">             - PORT=6395</span><br><span class="line">       ports:</span><br><span class="line">         - <span class="string">"6395:6395"</span></span><br><span class="line">         - <span class="string">"16395:16395"</span></span><br><span class="line">       stdin_open: <span class="literal">true</span></span><br><span class="line">       networks:</span><br><span class="line">          redis-slave:</span><br><span class="line">              ipv4_address: 172.30.0.3</span><br><span class="line">       tty: <span class="literal">true</span></span><br><span class="line">       privileged: <span class="literal">true</span></span><br><span class="line">       volumes: [<span class="string">"/usr/docker/redis/config:/config"</span>]</span><br><span class="line">       entrypoint:</span><br><span class="line">         - /bin/bash</span><br><span class="line">         - redis.sh</span><br><span class="line">  redis-cluster-slave3:</span><br><span class="line">       image: redis-cluster</span><br><span class="line">       container_name: redis-cluster-slave3</span><br><span class="line">       working_dir: /config</span><br><span class="line">       environment:</span><br><span class="line">          - PORT=6396</span><br><span class="line">       ports:</span><br><span class="line">         - <span class="string">"6396:6396"</span></span><br><span class="line">         - <span class="string">"16396:16396"</span></span><br><span class="line">       stdin_open: <span class="literal">true</span></span><br><span class="line">       networks:</span><br><span class="line">          redis-slave:</span><br><span class="line">            ipv4_address: 172.30.0.4</span><br><span class="line">       tty: <span class="literal">true</span></span><br><span class="line">       privileged: <span class="literal">true</span></span><br><span class="line">       volumes: [<span class="string">"/usr/docker/redis/config:/config"</span>]</span><br><span class="line">       entrypoint:</span><br><span class="line">         - /bin/bash</span><br><span class="line">         - redis.sh</span><br><span class="line">networks:</span><br><span class="line">  redis-master:</span><br><span class="line">     driver: bridge</span><br><span class="line">     ipam:</span><br><span class="line">       driver: default</span><br><span class="line">       config:</span><br><span class="line">          -</span><br><span class="line">           subnet: 172.50.0.0/16</span><br><span class="line">  redis-slave:</span><br><span class="line">       driver: bridge</span><br><span class="line">       ipam:</span><br><span class="line">         driver: default</span><br><span class="line">         config:</span><br><span class="line">            -</span><br><span class="line">             subnet: 172.30.0.0/16</span><br><span class="line">  redis-test:</span><br><span class="line">     external:</span><br><span class="line">       name: mynetwork</span><br></pre></td></tr></table></figure></p><p>redis.sh<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server  /config/nodes-<span class="variable">$&#123;PORT&#125;</span>.conf</span><br></pre></td></tr></table></figure></p><p>操作步骤<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos redis]# docker-compose -p redis-cluster up -d</span><br><span class="line">WARNING: Some networks were defined but are not used by any service: redis-test</span><br><span class="line">Creating redis-cluster-master1 ... done</span><br><span class="line">Creating redis-cluster-salve2  ... done</span><br><span class="line">Creating redis-cluster-master2 ... done</span><br><span class="line">Creating redis-cluster-slave1  ... done</span><br><span class="line">Creating redis-cluster-slave3  ... done</span><br><span class="line">Creating redis-cluster-master3 ... done</span><br><span class="line"></span><br><span class="line">[root@VM_0_6_centos redis]# docker exec -it redis-cluster-master1 bash</span><br><span class="line">[root@7ba6993e9fcf config]# pwd</span><br><span class="line">/config</span><br><span class="line"># 文件已共享</span><br><span class="line">[root@7ba6993e9fcf config]# ls</span><br><span class="line">nodes-6391.conf  nodes-6392.conf  nodes-6393.conf  nodes-6394.conf  nodes-6395.conf  nodes-6396.conf  redis-trib.rb  redis.sh</span><br><span class="line">[root@7ba6993e9fcf config]#</span><br><span class="line"># 查看节点ID</span><br><span class="line">[root@7ba6993e9fcf config]# cat /var/lib/redis/nodes-6379.conf</span><br><span class="line">df23468b9980f0814c35acdc4fb83968c8263d50 :0@0 myself,master - 0 0 0 connected</span><br><span class="line">vars currentEpoch 0 lastVoteEpoch 0</span><br><span class="line">[root@7ba6993e9fcf config]#</span><br><span class="line"></span><br><span class="line"># 登录客户端，参看集群信息</span><br><span class="line">[root@7ba6993e9fcf config]# echo $PORT</span><br><span class="line">6391</span><br><span class="line">[root@7ba6993e9fcf config]# redis-cli -p 6391</span><br><span class="line">127.0.0.1:6391&gt; cluster info</span><br><span class="line">cluster_state:fail</span><br><span class="line">cluster_slots_assigned:0</span><br><span class="line">cluster_slots_ok:0</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:1</span><br><span class="line">cluster_size:0</span><br><span class="line">cluster_current_epoch:0</span><br><span class="line">cluster_my_epoch:0</span><br><span class="line">cluster_stats_messages_sent:0</span><br><span class="line">cluster_stats_messages_received:0</span><br><span class="line">127.0.0.1:6391&gt; cluster nodes</span><br><span class="line">df23468b9980f0814c35acdc4fb83968c8263d50 :6391@16391 myself,master - 0 0 0 connected</span><br></pre></td></tr></table></figure></p><h2 id="节点握手"><a href="#节点握手" class="headerlink" title="节点握手"></a>节点握手</h2><p>节点握手是指一批运行在集群模式下的节点通过Gossip协议彼此通信，到达感知对方的过程。由客户端发起命令：<code>cluster meet {ip} {port}</code></p><p><code>cluster meet 127.0.0.1 6380</code></p><p><strong> 注意 </strong></p><blockquote><ol><li>每个redis cluster节点会占用两个TCP端口，一个监听客户端的请求，默认是6379，另一个在端口上加上10000，比如16379，来监听数据的请求，节点和节点之前会监听第二个端口，用一套二进制协议来通信。<br>节点之间会通过这套协议来进行失败检测，配置更新，failover认证等等。<br>为了保证节点之间的正常访问，需要注意防火墙的配置。</li><li>节点简历握手之后集群还不能正常工作，这时集群处于下线状态，所有的数据读写都被禁止<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6391&gt; set age 18</span><br><span class="line">(error) CLUSTERDOWN Hash slot not served</span><br></pre></td></tr></table></figure></li></ol></blockquote><blockquote><ol start="3"><li>作为一个完整的集群，需要主从节点，保证当他出现故障时可以自动进行故障转移。集群模式下，redis节点角色分为主节点和从节点。首次启动的节点和被分配槽的节点都是主节点，从节点负责复制主节点槽信息和相关数据</li></ol></blockquote><p>使用 <code>cluster replicate {nodeid}</code> 命令让一个节点称为从节点。其中命令执行必须在对应的从节点上执行，将当前节点设置为node_id指定的节点的从节点。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6391&gt; CLUSTER MEET 118.xx.xxx.54 6392</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6391&gt; CLUSTER MEET 118.xx.xxx.54 6393</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6391&gt; CLUSTER MEET 118.xx.xxx.54 6394</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6391&gt; CLUSTER MEET 118.xx.xxx.54 6395</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6391&gt; CLUSTER MEET 118.xx.xxx.54 6396</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6391&gt; CLUSTER NODES</span><br><span class="line">5689df453773f99399a2d93285c6906c0d7f7154 118.xx.xxx.54:6395@16395 master - 0 1574519726000 5 connected</span><br><span class="line">bbba975c724f6ad8c734bcce627f0ae6304f446f 118.xx.xxx.54:6393@16393 master - 0 1574519728000 2 connected</span><br><span class="line">90990230d7a0181a0a07144d9172004a737072f7 118.xx.xxx.54:6396@16396 master - 0 1574519728000 4 connected</span><br><span class="line">6c8fa041a2c71a668b5ab07618c5bec4d1eadad8 118.xx.xxx.54:6392@16392 master - 0 1574519728576 1 connected</span><br><span class="line">b920e563a56577786094bd940536f291b342495c 118.xx.xxx.54:6394@16394 master - 0 1574519729577 3 connected</span><br><span class="line">df23468b9980f0814c35acdc4fb83968c8263d50 118.xx.xxx.54:6391@16391 myself,master - 0 1574519729000 0 connected</span><br></pre></td></tr></table></figure><p>配置主从<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@cd4ac43057f5 config]# redis-cli -h 118.xx.xxx.54 -p 6394 CLUSTER REPLICATE df23468b9980f0814c35acdc4fb83968c8263d50</span><br><span class="line">OK</span><br><span class="line">[root@cd4ac43057f5 config]# redis-cli -h 118.xx.xxx.54 -p 6395 CLUSTER REPLICATE 6c8fa041a2c71a668b5ab07618c5bec4d1eadad8</span><br><span class="line">OK</span><br><span class="line">[root@cd4ac43057f5 config]# redis-cli -h 118.xx.xxx.54 -p 6396 CLUSTER REPLICATE bbba975c724f6ad8c734bcce627f0ae6304f446f</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">[root@cd4ac43057f5 config]# redis-cli -h 118.xx.xxx.54 -p 6391</span><br><span class="line">127.0.0.1:6391&gt; CLUSTER NODES</span><br><span class="line">5689df453773f99399a2d93285c6906c0d7f7154 118.xx.xxx.54:6395@16395 slave 6c8fa041a2c71a668b5ab07618c5bec4d1eadad8 0 1574520112000 5 connected</span><br><span class="line">bbba975c724f6ad8c734bcce627f0ae6304f446f 118.xx.xxx.54:6393@16393 master - 0 1574520111000 2 connected</span><br><span class="line">90990230d7a0181a0a07144d9172004a737072f7 118.xx.xxx.54:6396@16396 slave bbba975c724f6ad8c734bcce627f0ae6304f446f 0 1574520112276 4 connected</span><br><span class="line">6c8fa041a2c71a668b5ab07618c5bec4d1eadad8 118.xx.xxx.54:6392@16392 master - 0 1574520113277 1 connected</span><br><span class="line">b920e563a56577786094bd940536f291b342495c 118.xx.xxx.54:6394@16394 slave df23468b9980f0814c35acdc4fb83968c8263d50 0 1574520111273 3 connected</span><br><span class="line">df23468b9980f0814c35acdc4fb83968c8263d50 118.xx.xxx.54:6391@16391 myself,master - 0 1574520110000 0 connected</span><br></pre></td></tr></table></figure></p><h2 id="分配槽"><a href="#分配槽" class="headerlink" title="分配槽"></a>分配槽</h2><p>redis集群把所有的数据映射到16384个槽中。每个key会映射为一个固定的槽，只有当节点分配了槽，才能响应和这些槽关联的键命令。通过<code>cluster addslots</code>命令为节点分配槽</p><p>利用bash特性批量设置槽（slots）,命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 118.xx.xxx.54 -p 6391 cluster addslots &#123;0..5461&#125;</span><br><span class="line">redis-cli -h 118.xx.xxx.54 -p 6392 cluster addslots &#123;5462..10922&#125;</span><br><span class="line">redis-cli -h 118.xx.xxx.54 -p 6393 cluster addslots &#123;10923..16383&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>我们依照redis协议手动建立一个集群。它由6个节点组成，3个主节点负责处理漕河相关数据，3个从节点负责故障转移。redis官方提供了redis-trib.rb 工具方便我们快速搭建集群</p></blockquote><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@7ba6993e9fcf config]# redis-cli -p 6391</span><br><span class="line">118.xx.xxx.54:6391&gt; set age 18</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">[root@cd4ac43057f5 config]# redis-cli -h 118.xx.xxx.54 -p 6394</span><br><span class="line">118.xx.xxx.54:6394&gt; get age</span><br><span class="line">(error) MOVED 741 118.xx.xxx.54:6391</span><br><span class="line">118.xx.xxx.54:6394&gt; exit</span><br><span class="line">[root@cd4ac43057f5 config]# redis-cli -h 118.xx.xxx.54 -p 6391</span><br><span class="line">118.xx.xxx.54:6391&gt; get age</span><br><span class="line">&quot;18&quot;</span><br></pre></td></tr></table></figure><blockquote><p>操作集群 -c 集群模式 <code>redis-cli -c -p 6391 get age</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@7ba6993e9fcf config]# redis-cli -c -h 118.xx.xxx.54 -p 6391 get age</span><br><span class="line">&quot;18&quot;</span><br><span class="line">[root@7ba6993e9fcf config]# redis-cli -c -h 118.xx.xxx.54 -p 6392 get age</span><br><span class="line">&quot;18&quot;</span><br><span class="line">[root@7ba6993e9fcf config]# redis-cli -c -h 118.xx.xxx.54 -p 6393 get age</span><br></pre></td></tr></table></figure></p></blockquote><h1 id="redis-trib-rb-搭建集群"><a href="#redis-trib-rb-搭建集群" class="headerlink" title="redis-trib.rb 搭建集群"></a>redis-trib.rb 搭建集群</h1><p>redis-trib.rb 是采用 Ruby实现的redis集群管理工具。内部通过cluster相关命令帮我们建立集群创建、检查、槽迁移和均衡等常见运维操作，使用之前需要安装Ruby依赖环境。</p><p>启动好6个节点之后，使用<code>redis-trib.rb create</code>命令完成节点握手和槽分配过程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb create --replicas 1  118.xx.xxx.54:6391 118.xx.xxx.54:6392 118.xx.xxx.54:6393 118.xx.xxx.54:6394 118.xx.xxx.54:6395 118.xx.xxx.54:6396</span><br></pre></td></tr></table></figure><blockquote><p><code>--replicas</code> 参数指定集群中每个主节点配备几个从节点，这里设置为1，redis-trib.rb 会尽可能保证主从节点不分配在同一机器下，因此会重新排序节点列表顺序。节点列表顺序用语确定主从角色，先主节点之后是从节点。创建过程中首先会给出主从节点角色分配的计划，并且会生成报告</p></blockquote><h1 id="操作记录"><a href="#操作记录" class="headerlink" title="操作记录"></a>操作记录</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@544b4c16b923 config]# redis-trib.rb create --replicas 1 118.xx.xxx.54:6391 118.xx.xxx.54:6392 118.xx.xxx.54:6393 118.xx.xxx.54:6394 118.xx.xxx.54:6395 118.xx.xxx.54:6396</span><br><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">/usr/local/share/gems/gems/redis-3.2.1/lib/redis/client.rb:443: warning: constant ::Fixnum is deprecated</span><br><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Using 3 masters:</span><br><span class="line">118.xx.xxx.54:6391</span><br><span class="line">118.xx.xxx.54:6392</span><br><span class="line">118.xx.xxx.54:6393</span><br><span class="line">Adding replica 118.xx.xxx.54:6394 to 118.xx.xxx.54:6391</span><br><span class="line">Adding replica 118.xx.xxx.54:6395 to 118.xx.xxx.54:6392</span><br><span class="line">Adding replica 118.xx.xxx.54:6396 to 118.xx.xxx.54:6393</span><br><span class="line">M: 561782045ab4a9332859c532ba5f5e8163b527b5 118.xx.xxx.54:6391</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">M: daf938ff3ed7f571fcb63b2ad2cd952208ede80a 118.xx.xxx.54:6392</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">M: 4f2769409d9353896847337a04f09b5254ca00cf 118.xx.xxx.54:6393</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">S: 6a5973e8a0dc6c7db1831d0ef7322101be4bf109 118.xx.xxx.54:6394</span><br><span class="line">   replicates 561782045ab4a9332859c532ba5f5e8163b527b5</span><br><span class="line">S: 4059332e853bb8d381ecaff6d802566f549932c2 118.xx.xxx.54:6395</span><br><span class="line">   replicates daf938ff3ed7f571fcb63b2ad2cd952208ede80a</span><br><span class="line">S: d0e0b01e0a9becac7e6dd02cf52f5c28b316af83 118.xx.xxx.54:6396</span><br><span class="line">   replicates 4f2769409d9353896847337a04f09b5254ca00cf</span><br><span class="line">Can I set the above configuration? (type &apos;yes&apos; to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join....</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 118.xx.xxx.54:6391)</span><br><span class="line">M: 561782045ab4a9332859c532ba5f5e8163b527b5 118.xx.xxx.54:6391</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: daf938ff3ed7f571fcb63b2ad2cd952208ede80a 118.xx.xxx.54:6392@16392</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: d0e0b01e0a9becac7e6dd02cf52f5c28b316af83 118.xx.xxx.54:6396@16396</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4f2769409d9353896847337a04f09b5254ca00cf</span><br><span class="line">S: 6a5973e8a0dc6c7db1831d0ef7322101be4bf109 118.xx.xxx.54:6394@16394</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 561782045ab4a9332859c532ba5f5e8163b527b5</span><br><span class="line">M: 4f2769409d9353896847337a04f09b5254ca00cf 118.xx.xxx.54:6393@16393</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 4059332e853bb8d381ecaff6d802566f549932c2 118.xx.xxx.54:6395@16395</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates daf938ff3ed7f571fcb63b2ad2cd952208ede80a</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br><span class="line">127.0.0.1:6391&gt; CLUSTER NODES</span><br><span class="line">daf938ff3ed7f571fcb63b2ad2cd952208ede80a 118.xx.xxx.54:6392@16392 master - 0 1574524576000 2 connected 5461-10922</span><br><span class="line">d0e0b01e0a9becac7e6dd02cf52f5c28b316af83 118.xx.xxx.54:6396@16396 slave 4f2769409d9353896847337a04f09b5254ca00cf 0 1574524575566 6 connected</span><br><span class="line">561782045ab4a9332859c532ba5f5e8163b527b5 172.50.0.2:6391@16391 myself,master - 0 1574524575000 1 connected 0-5460</span><br><span class="line">6a5973e8a0dc6c7db1831d0ef7322101be4bf109 118.xx.xxx.54:6394@16394 slave 561782045ab4a9332859c532ba5f5e8163b527b5 0 1574524575000 4 connected</span><br><span class="line">4f2769409d9353896847337a04f09b5254ca00cf 118.xx.xxx.54:6393@16393 master - 0 1574524577570 3 connected 10923-16383</span><br><span class="line">4059332e853bb8d381ecaff6d802566f549932c2 118.xx.xxx.54:6395@16395 slave daf938ff3ed7f571fcb63b2ad2cd952208ede80a 0 1574524577000 5 connected</span><br></pre></td></tr></table></figure><h1 id="集群功能限制"><a href="#集群功能限制" class="headerlink" title="集群功能限制"></a>集群功能限制</h1><p>redis集群相对淡季在功能上存在一些限制：</p><ol><li>key批量操作支持有限。如mset,mget。目前只支持具有相同slot值的key执行批量操作。</li><li>key事务操作支持有限。同理只支持多key在同一节点上的事务操作。</li><li>不支持多数据库空间。单机下redis可以支持16个数据库，集群模式下只能使用一个数据库空间，即db0。</li><li>复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构</li></ol><blockquote><p>利用redisC扩展支持Mset,Mget操作。 redisCluster<br>Predis包不支持Mset,Mget等批量操作</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;当业务场景需要足够大量的Redis存储时，主从结构+哨兵可以实现高可用故障切换+冗余备份，但是并不能解决数据容量的
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>(二)redis docker 哨兵模式</title>
    <link href="http://blog.uiste.com/2019/20190922-2.html"/>
    <id>http://blog.uiste.com/2019/20190922-2.html</id>
    <published>2019-09-22T08:07:36.000Z</published>
    <updated>2020-04-26T11:02:50.514Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Redis主从复制的原理及相关问题"><a href="#Redis主从复制的原理及相关问题" class="headerlink" title="Redis主从复制的原理及相关问题"></a>Redis主从复制的原理及相关问题</h1><ol><li>保存主节点信息</li><li>主从建立socket连接</li><li>发送ping命令</li><li>权限验证</li><li>同步数据集</li><li>命令持续复制</li></ol><h1 id="全量复制"><a href="#全量复制" class="headerlink" title="全量复制"></a>全量复制</h1><h1 id="部分复制"><a href="#部分复制" class="headerlink" title="部分复制"></a>部分复制</h1><p>redis2.8以后才支持</p><h1 id="复制偏移量"><a href="#复制偏移量" class="headerlink" title="复制偏移量"></a>复制偏移量</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">info replication</span><br><span class="line">slave0:ip=172.10.0.3,port=6379,state=online,offset=5545,lag=0</span><br><span class="line">master_repl_offset</span><br></pre></td></tr></table></figure><h1 id="积压缓存区"><a href="#积压缓存区" class="headerlink" title="积压缓存区"></a>积压缓存区</h1><h1 id="dockerfile-指令"><a href="#dockerfile-指令" class="headerlink" title="dockerfile 指令"></a>dockerfile 指令</h1><p>COPY<br>ADD<br>CMD<br>ENTRYPOINT<br>ENV<br>ARG<br>VOLUME<br>EXPOSE<br>WORKDIR<br>USER</p><h1 id="主从复制的常见问题"><a href="#主从复制的常见问题" class="headerlink" title="主从复制的常见问题"></a>主从复制的常见问题</h1><p>repl-disable-tcp-nodelay<br>yes 时 TCP协议会合并小包统一发送，减少主从节点的包数量并节省带宽，会增加数据同步到slave的时间</p><p>slave-priority<br>指定slave的优先级。在不止1个slave的情况下，master宕机时，redis sentinel 会将priority值最小的slave提升为master。需要注意的是，若该配置项为0，则对应的slave永远不会被redis sentinel 自动提升为master</p><h1 id="redis-sentinel-哨兵的作用"><a href="#redis-sentinel-哨兵的作用" class="headerlink" title="redis sentinel 哨兵的作用"></a>redis sentinel 哨兵的作用</h1><ol><li>监控：定期检查Redis数据节点、其余sentinel节点是否可达</li><li>通知：sentinel 节点会将故障转移的结果通知给应用方</li><li>主节点故障转移：实现从节点晋升为主节点并维护后续正确的主从关系</li><li>sentinel节点本身就是独立的Redis节点，只不过她们有一些特殊，自己不存储数据，只支持部分命令</li></ol><h1 id="哨兵配置"><a href="#哨兵配置" class="headerlink" title="哨兵配置"></a>哨兵配置</h1><h2 id="新增一个Redis-slave2"><a href="#新增一个Redis-slave2" class="headerlink" title="新增一个Redis-slave2"></a>新增一个Redis-slave2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos ~]# docker run -itd --name redis-slave2 --net mynetwork -p 6382:6379 --ip 172.10.0.4 redis</span><br><span class="line">d8ceb85aa3bedacad69e0765e5dcac28a4906eeb99c2f22b4e3af2bd3bb29501</span><br><span class="line">[root@VM_0_6_centos ~]# docker exec -it redis-slave2 bash</span><br><span class="line">[root@d8ceb85aa3be /]# vi /etc/redis.conf</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"># JUST COMMENT THE FOLLOWING LINE.</span><br><span class="line"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">#bind 127.0.0.1</span><br><span class="line">bind 0.0.0.0</span><br><span class="line"># Protected mode is a layer of security protection, in order to avoid that</span><br><span class="line"># Redis instances left open on the internet are accessed and exploited.</span><br><span class="line">#</span><br><span class="line"># When protected mode is on and if:</span><br><span class="line">#</span><br><span class="line"># 1) The server is not binding explicitly to a set of addresses using the</span><br><span class="line">#    &quot;bind&quot; directive.</span><br><span class="line"># 2) No password is configured.</span><br><span class="line">#</span><br><span class="line"># The server only accepts connections from clients connecting from the</span><br><span class="line"># IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain</span><br><span class="line"># sockets.</span><br><span class="line">#</span><br><span class="line"># By default protected mode is enabled. You should disable it only if</span><br><span class="line"># you are sure you want clients from other hosts to connect to Redis</span><br><span class="line"># even if no authentication is configured, nor a specific set of interfaces</span><br><span class="line"># are explicitly listed using the &quot;bind&quot; directive.</span><br><span class="line">#protected-mode yes</span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line">replicaof 172.10.0.2 6379</span><br><span class="line"># If the master is password protected (using the &quot;requirepass&quot; configuration</span><br><span class="line"># directive below) it is possible to tell the replica to authenticate before</span><br><span class="line"># starting the replication synchronization process, otherwise the master will</span><br><span class="line"># refuse the replica request.</span><br><span class="line">#</span><br><span class="line"># masterauth &lt;master-password&gt;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@d8ceb85aa3be /]# redis-server /etc/redis.conf &amp;</span><br><span class="line">[1] 29</span><br><span class="line">[root@d8ceb85aa3be /]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:172.10.0.2</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:3</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:101921</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:73aa73a6ca2674e214b2081989f8f5cd642b1774</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:101921</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:101880</span><br><span class="line">repl_backlog_histlen:42</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure><h2 id="配置sentinel集群"><a href="#配置sentinel集群" class="headerlink" title="配置sentinel集群"></a>配置sentinel集群</h2><h3 id="核心配置"><a href="#核心配置" class="headerlink" title="核心配置"></a>核心配置</h3><p><code>sentinel monitor mymaster 127.0.0.1 7000 2</code></p><blockquote><p>监控的主节点的名字、IP和端口，最后一个2的意思是有几台 sentinel发现问题，就会发生故障转移，例如 配置为2，代表至少有2个sentinel节点认为主节点不可达，那么这个不可达的判断才是客观的。对于设置的越小，那么达到下线的条件越宽松，反之越严格。一般建议将其设置为sentinel节点的一半加1</p></blockquote><p><code>sentinel  down-after-minllsenconds mymaster 30000</code></p><blockquote><p>这个是超时的时间（单位是毫秒）。当你去ping一个机器的时候，多长时间后仍ping不通，那么就热为它是有问题的</p></blockquote><p><code>sentinel parallel-syncs mymaster 1</code></p><blockquote><p>parallel-syncs就是用来限制在一次故障转移之后，每次向新的主节点发起复制操作的从节点个数，支出sentinel属于并发还是创新，1代表每次只能复制一个，可以减轻master的压力</p></blockquote><p><code>sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</code></p><blockquote><p>如果sentinel监控的主节点配置了密码，sentinel auth-pass配置通过添加主节点的密码，房子sentinel节点对主节点无法监控</p></blockquote><p><code>sentinel failover-timeout mymaster 180000</code></p><blockquote><p>标识故障转移的时间</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name redis-sentinel1 --net mynetwork -p 22530:6379 --ip 172.10.0.30 redis</span><br><span class="line">docker run -itd --name redis-sentinel2 --net mynetwork -p 22531:6379 --ip 172.10.0.31 redis</span><br><span class="line">docker run -itd --name redis-sentinel3 --net mynetwork -p 22532:6379 --ip 172.10.0.32 redis</span><br></pre></td></tr></table></figure><p>操作记录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos ~]# docker run -itd --name redis-sentinel1 --net mynetwork -p 22530:6379 --ip 172.10.0.30 redis</span><br><span class="line">706f81a08f15c74581b5f54a351ac809f3d782e7ee96d4f51b4ff745c8520039</span><br><span class="line">[root@VM_0_6_centos ~]# docker exec -it redis-sentinel1 bash</span><br><span class="line">[root@706f81a08f15 /]# vi /etc/redis-sentinel.conf</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"># bind 127.0.0.1 192.168.1.1</span><br><span class="line">#</span><br><span class="line"># protected-mode no</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">protected-mode no</span><br><span class="line"># port &lt;sentinel-port&gt;</span><br><span class="line"># The port that this sentinel instance will run on</span><br><span class="line">port 26379</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># Note: master name should not include special characters or spaces.</span><br><span class="line"># The valid charset is A-z 0-9 and the three characters &quot;.-_&quot;.</span><br><span class="line">#sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line">sentinel monitor mymaster 172.10.0.2 6379 2</span><br><span class="line"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span><br><span class="line">#</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@706f81a08f15 /]# redis-sentinel /etc/redis-sentinel.conf &amp;</span><br></pre></td></tr></table></figure></p><p>配置日志查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@706f81a08f15 /]# vi /var/log/redis/sentinel.log</span><br><span class="line">29:X 23 Nov 2019 04:29:30.667 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">29:X 23 Nov 2019 04:29:30.667 # Redis version=5.0.3, bits=64, commit=00000000, modified=0, pid=29, just started</span><br><span class="line">29:X 23 Nov 2019 04:29:30.667 # Configuration loaded</span><br><span class="line">29:X 23 Nov 2019 04:29:30.670 * Running mode=sentinel, port=26379.</span><br><span class="line">29:X 23 Nov 2019 04:29:30.670 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">29:X 23 Nov 2019 04:29:30.678 # Sentinel ID is 7475415502d8812fb642905c4837a8e071f7a75a</span><br><span class="line">29:X 23 Nov 2019 04:29:30.678 # +monitor master mymaster 172.10.0.2 6379 quorum 2</span><br><span class="line">29:X 23 Nov 2019 04:29:30.766 * +slave slave 172.10.0.3:6379 172.10.0.3 6379 @ mymaster 172.10.0.2 6379</span><br><span class="line">29:X 23 Nov 2019 04:29:30.772 * +slave slave 172.10.0.4:6379 172.10.0.4 6379 @ mymaster 172.10.0.2 6379</span><br><span class="line">29:X 23 Nov 2019 04:29:37.290 * +sentinel sentinel 9e58d80dbc53015c666e1f3c5dba5146ddf56795 172.10.0.31 26379 @ mymaster 172.10.0.2 6379</span><br><span class="line">29:X 23 Nov 2019 04:29:39.245 * +sentinel sentinel acf0b15e88a1734fdc1af5213817c6ac83aadb78 172.10.0.32 26379 @ mymaster 172.10.0.2 6379</span><br></pre></td></tr></table></figure></p><blockquote><p>备注：其它两台的配置一模一样，参数都不需要改变。哨兵集群只需要配置对主节点的监控即可。重启后0.2新的从节点会和新的0.4主节点建立连接</p></blockquote><p><img src="../../../assets/imgs/201909220201.png" alt="配置查看"></p><p>登录查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">[root@706f81a08f15 /]# redis-cli -p 26379</span><br><span class="line">127.0.0.1:26379&gt; info</span><br><span class="line"># Server</span><br><span class="line">redis_version:5.0.3</span><br><span class="line">redis_git_sha1:00000000</span><br><span class="line">redis_git_dirty:0</span><br><span class="line">redis_build_id:8c0bf22bfba82c8f</span><br><span class="line">redis_mode:sentinel</span><br><span class="line">os:Linux 3.10.0-862.11.6.el7.x86_64 x86_64</span><br><span class="line">arch_bits:64</span><br><span class="line">multiplexing_api:epoll</span><br><span class="line">atomicvar_api:atomic-builtin</span><br><span class="line">gcc_version:8.2.1</span><br><span class="line">process_id:29</span><br><span class="line">run_id:efcfa986c11fb8a4815bba1db1caee13dcb60bae</span><br><span class="line">tcp_port:26379</span><br><span class="line">uptime_in_seconds:4473</span><br><span class="line">uptime_in_days:0</span><br><span class="line">hz:17</span><br><span class="line">configured_hz:10</span><br><span class="line">lru_clock:14206755</span><br><span class="line">executable:/redis-sentinel</span><br><span class="line">config_file:/etc/redis-sentinel.conf</span><br><span class="line"></span><br><span class="line"># Clients</span><br><span class="line">connected_clients:3</span><br><span class="line">client_recent_max_input_buffer:2</span><br><span class="line">client_recent_max_output_buffer:0</span><br><span class="line">blocked_clients:0</span><br><span class="line"></span><br><span class="line"># CPU</span><br><span class="line">used_cpu_sys:8.485302</span><br><span class="line">used_cpu_user:4.427473</span><br><span class="line">used_cpu_sys_children:0.000000</span><br><span class="line">used_cpu_user_children:0.000000</span><br><span class="line"></span><br><span class="line"># Stats</span><br><span class="line">total_connections_received:3</span><br><span class="line">total_commands_processed:12991</span><br><span class="line">instantaneous_ops_per_sec:2</span><br><span class="line">total_net_input_bytes:716377</span><br><span class="line">total_net_output_bytes:77880</span><br><span class="line">instantaneous_input_kbps:0.16</span><br><span class="line">instantaneous_output_kbps:0.01</span><br><span class="line">rejected_connections:0</span><br><span class="line">sync_full:0</span><br><span class="line">sync_partial_ok:0</span><br><span class="line">sync_partial_err:0</span><br><span class="line">expired_keys:0</span><br><span class="line">expired_stale_perc:0.00</span><br><span class="line">expired_time_cap_reached_count:0</span><br><span class="line">evicted_keys:0</span><br><span class="line">keyspace_hits:0</span><br><span class="line">keyspace_misses:0</span><br><span class="line">pubsub_channels:0</span><br><span class="line">pubsub_patterns:0</span><br><span class="line">latest_fork_usec:0</span><br><span class="line">migrate_cached_sockets:0</span><br><span class="line">slave_expires_tracked_keys:0</span><br><span class="line">active_defrag_hits:0</span><br><span class="line">active_defrag_misses:0</span><br><span class="line">active_defrag_key_hits:0</span><br><span class="line">active_defrag_key_misses:0</span><br><span class="line"></span><br><span class="line"># Sentinel</span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=172.10.0.4:6379,slaves=2,sentinels=3</span><br><span class="line">127.0.0.1:26379&gt; sentinel get-master-addr-by-name mymaster</span><br><span class="line">1) &quot;172.10.0.4&quot;</span><br><span class="line">2) &quot;6379&quot;</span><br></pre></td></tr></table></figure></p><h1 id="PHP通过哨兵去任意从库读取数据"><a href="#PHP通过哨兵去任意从库读取数据" class="headerlink" title="PHP通过哨兵去任意从库读取数据"></a>PHP通过哨兵去任意从库读取数据</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: uiste</span></span><br><span class="line"><span class="comment"> * Date: 2019/11/23</span></span><br><span class="line"><span class="comment"> * Time: 下午2:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">$sentinelConf = [</span><br><span class="line">[<span class="string">'ip'</span> =&gt; <span class="string">'172.10.0.30'</span>, <span class="string">'port'</span> =&gt; <span class="number">26379</span>],</span><br><span class="line">[<span class="string">'ip'</span> =&gt; <span class="string">'172.10.0.31'</span>, <span class="string">'port'</span> =&gt; <span class="number">26379</span>],</span><br><span class="line">[<span class="string">'ip'</span> =&gt; <span class="string">'172.10.0.32'</span>, <span class="string">'port'</span> =&gt; <span class="number">26379</span>],</span><br><span class="line">];</span><br><span class="line"><span class="comment">//随机访问</span></span><br><span class="line">$sentinelInfo = $sentinelConf[array_rand($sentinelConf)];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect($sentinelInfo[<span class="string">'ip'</span>], $sentinelInfo[<span class="string">'port'</span>]);</span><br><span class="line"></span><br><span class="line">$slavesInfo = $redis-&gt;rawCommand(<span class="string">'SENTINEL'</span>, <span class="string">'slaves'</span>, <span class="string">'mymaster'</span>);</span><br><span class="line">$slaves = [];</span><br><span class="line"><span class="keyword">foreach</span> ($slavesInfo <span class="keyword">as</span> $val) &#123;</span><br><span class="line">$slaves[] = [<span class="string">'ip'</span> =&gt; $val[<span class="number">3</span>], <span class="string">'port'</span> =&gt; $val[<span class="number">5</span>]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment"># 随机从任意从库读取数据</span></span><br><span class="line">$slave = $slaves[array_rand($slaves)];</span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect($slave[<span class="string">'ip'</span>], $slave[<span class="string">'port'</span>]);</span><br><span class="line">var_dump($slave, $redis-&gt;get(<span class="string">'name'</span>));</span><br><span class="line"></span><br><span class="line">$count++;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"第&#123;$count&#125;次访问的是：[&#123;$slave['ip']&#125;] : [&#123;$slave['port']&#125;] \r\n"</span>;</span><br><span class="line">sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (\RedisException $e) &#123;</span><br><span class="line"><span class="keyword">echo</span> $e-&gt;getMessage();</span><br><span class="line"><span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>debug info<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos test]# php test.php</span><br><span class="line">array(2) &#123;</span><br><span class="line">  [&quot;ip&quot;]=&gt;</span><br><span class="line">  string(10) &quot;172.10.0.2&quot;</span><br><span class="line">  [&quot;port&quot;]=&gt;</span><br><span class="line">  string(4) &quot;6379&quot;</span><br><span class="line">&#125;</span><br><span class="line">string(5) &quot;uiste&quot;</span><br><span class="line">第1次访问的是：[172.10.0.2] : [6379]</span><br><span class="line">array(2) &#123;</span><br><span class="line">  [&quot;ip&quot;]=&gt;</span><br><span class="line">  string(10) &quot;172.10.0.2&quot;</span><br><span class="line">  [&quot;port&quot;]=&gt;</span><br><span class="line">  string(4) &quot;6379&quot;</span><br><span class="line">&#125;</span><br><span class="line">string(5) &quot;uiste&quot;</span><br><span class="line">第2次访问的是：[172.10.0.2] : [6379]</span><br><span class="line">array(2) &#123;</span><br><span class="line">  [&quot;ip&quot;]=&gt;</span><br><span class="line">  string(10) &quot;172.10.0.3&quot;</span><br><span class="line">  [&quot;port&quot;]=&gt;</span><br><span class="line">  string(4) &quot;6379&quot;</span><br><span class="line">&#125;</span><br><span class="line">string(5) &quot;uiste&quot;</span><br><span class="line">第3次访问的是：[172.10.0.3] : [6379]</span><br><span class="line">array(2) &#123;</span><br><span class="line">  [&quot;ip&quot;]=&gt;</span><br><span class="line">  string(10) &quot;172.10.0.2&quot;</span><br><span class="line">  [&quot;port&quot;]=&gt;</span><br><span class="line">  string(4) &quot;6379&quot;</span><br><span class="line">&#125;</span><br><span class="line">string(5) &quot;uiste&quot;</span><br><span class="line">第4次访问的是：[172.10.0.2] : [6379]</span><br><span class="line"></span><br><span class="line">debug $slavesInfo</span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  array(40) &#123;</span><br><span class="line">    [0]=&gt;</span><br><span class="line">    string(4) &quot;name&quot;</span><br><span class="line">    [1]=&gt;</span><br><span class="line">    string(15) &quot;172.10.0.2:6379&quot;</span><br><span class="line">    [2]=&gt;</span><br><span class="line">    string(2) &quot;ip&quot;</span><br><span class="line">    [3]=&gt;</span><br><span class="line">    string(10) &quot;172.10.0.2&quot;</span><br><span class="line">    [4]=&gt;</span><br><span class="line">    string(4) &quot;port&quot;</span><br><span class="line">    [5]=&gt;</span><br><span class="line">    string(4) &quot;6379&quot;</span><br><span class="line">    [6]=&gt;</span><br><span class="line">    string(5) &quot;runid&quot;</span><br><span class="line">    [7]=&gt;</span><br><span class="line">    string(40) &quot;0e681802737476f1432e1bd21fa85b15d008892a&quot;</span><br><span class="line">    [8]=&gt;</span><br><span class="line">    string(5) &quot;flags&quot;</span><br><span class="line">    [9]=&gt;</span><br><span class="line">    string(5) &quot;slave&quot;</span><br><span class="line">    [10]=&gt;</span><br><span class="line">    string(21) &quot;link-pending-commands&quot;</span><br><span class="line">    [11]=&gt;</span><br><span class="line">    string(1) &quot;0&quot;</span><br><span class="line">    [12]=&gt;</span><br><span class="line">    string(13) &quot;link-refcount&quot;</span><br><span class="line">    [13]=&gt;</span><br><span class="line">    string(1) &quot;1&quot;</span><br><span class="line">    [14]=&gt;</span><br><span class="line">    string(14) &quot;last-ping-sent&quot;</span><br><span class="line">    [15]=&gt;</span><br><span class="line">    string(1) &quot;0&quot;</span><br><span class="line">    [16]=&gt;</span><br><span class="line">    string(18) &quot;last-ok-ping-reply&quot;</span><br><span class="line">    [17]=&gt;</span><br><span class="line">    string(3) &quot;490&quot;</span><br><span class="line">    [18]=&gt;</span><br><span class="line">    string(15) &quot;last-ping-reply&quot;</span><br><span class="line">    [19]=&gt;</span><br><span class="line">    string(3) &quot;490&quot;</span><br><span class="line">    [20]=&gt;</span><br><span class="line">    string(23) &quot;down-after-milliseconds&quot;</span><br><span class="line">    [21]=&gt;</span><br><span class="line">    string(5) &quot;30000&quot;</span><br><span class="line">    [22]=&gt;</span><br><span class="line">    string(12) &quot;info-refresh&quot;</span><br><span class="line">    [23]=&gt;</span><br><span class="line">    string(4) &quot;5825&quot;</span><br><span class="line">    [24]=&gt;</span><br><span class="line">    string(13) &quot;role-reported&quot;</span><br><span class="line">    [25]=&gt;</span><br><span class="line">    string(5) &quot;slave&quot;</span><br><span class="line">    [26]=&gt;</span><br><span class="line">    string(18) &quot;role-reported-time&quot;</span><br><span class="line">    [27]=&gt;</span><br><span class="line">    string(7) &quot;9292293&quot;</span><br><span class="line">    [28]=&gt;</span><br><span class="line">    string(21) &quot;master-link-down-time&quot;</span><br><span class="line">    [29]=&gt;</span><br><span class="line">    string(1) &quot;0&quot;</span><br><span class="line">    [30]=&gt;</span><br><span class="line">    string(18) &quot;master-link-status&quot;</span><br><span class="line">    [31]=&gt;</span><br><span class="line">    string(2) &quot;ok&quot;</span><br><span class="line">    [32]=&gt;</span><br><span class="line">    string(11) &quot;master-host&quot;</span><br><span class="line">    [33]=&gt;</span><br><span class="line">    string(10) &quot;172.10.0.4&quot;</span><br><span class="line">    [34]=&gt;</span><br><span class="line">    string(11) &quot;master-port&quot;</span><br><span class="line">    [35]=&gt;</span><br><span class="line">    string(4) &quot;6379&quot;</span><br><span class="line">    [36]=&gt;</span><br><span class="line">    string(14) &quot;slave-priority&quot;</span><br><span class="line">    [37]=&gt;</span><br><span class="line">    string(3) &quot;100&quot;</span><br><span class="line">    [38]=&gt;</span><br><span class="line">    string(17) &quot;slave-repl-offset&quot;</span><br><span class="line">    [39]=&gt;</span><br><span class="line">    string(7) &quot;2791574&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  array(40) &#123;</span><br><span class="line">    [0]=&gt;</span><br><span class="line">    string(4) &quot;name&quot;</span><br><span class="line">    [1]=&gt;</span><br><span class="line">    string(15) &quot;172.10.0.3:6379&quot;</span><br><span class="line">    [2]=&gt;</span><br><span class="line">    string(2) &quot;ip&quot;</span><br><span class="line">    [3]=&gt;</span><br><span class="line">    string(10) &quot;172.10.0.3&quot;</span><br><span class="line">    [4]=&gt;</span><br><span class="line">    string(4) &quot;port&quot;</span><br><span class="line">    [5]=&gt;</span><br><span class="line">    string(4) &quot;6379&quot;</span><br><span class="line">    [6]=&gt;</span><br><span class="line">    string(5) &quot;runid&quot;</span><br><span class="line">    [7]=&gt;</span><br><span class="line">    string(40) &quot;74c3a5ad5201ec08b04c34a6c1e8be43e3454f2f&quot;</span><br><span class="line">    [8]=&gt;</span><br><span class="line">    string(5) &quot;flags&quot;</span><br><span class="line">    [9]=&gt;</span><br><span class="line">    string(5) &quot;slave&quot;</span><br><span class="line">    [10]=&gt;</span><br><span class="line">    string(21) &quot;link-pending-commands&quot;</span><br><span class="line">    [11]=&gt;</span><br><span class="line">    string(1) &quot;0&quot;</span><br><span class="line">    [12]=&gt;</span><br><span class="line">    string(13) &quot;link-refcount&quot;</span><br><span class="line">    [13]=&gt;</span><br><span class="line">    string(1) &quot;1&quot;</span><br><span class="line">    [14]=&gt;</span><br><span class="line">    string(14) &quot;last-ping-sent&quot;</span><br><span class="line">    [15]=&gt;</span><br><span class="line">    string(1) &quot;0&quot;</span><br><span class="line">    [16]=&gt;</span><br><span class="line">    string(18) &quot;last-ok-ping-reply&quot;</span><br><span class="line">    [17]=&gt;</span><br><span class="line">    string(3) &quot;490&quot;</span><br><span class="line">    [18]=&gt;</span><br><span class="line">    string(15) &quot;last-ping-reply&quot;</span><br><span class="line">    [19]=&gt;</span><br><span class="line">    string(3) &quot;490&quot;</span><br><span class="line">    [20]=&gt;</span><br><span class="line">    string(23) &quot;down-after-milliseconds&quot;</span><br><span class="line">    [21]=&gt;</span><br><span class="line">    string(5) &quot;30000&quot;</span><br><span class="line">    [22]=&gt;</span><br><span class="line">    string(12) &quot;info-refresh&quot;</span><br><span class="line">    [23]=&gt;</span><br><span class="line">    string(4) &quot;2184&quot;</span><br><span class="line">    [24]=&gt;</span><br><span class="line">    string(13) &quot;role-reported&quot;</span><br><span class="line">    [25]=&gt;</span><br><span class="line">    string(5) &quot;slave&quot;</span><br><span class="line">    [26]=&gt;</span><br><span class="line">    string(18) &quot;role-reported-time&quot;</span><br><span class="line">    [27]=&gt;</span><br><span class="line">    string(8) &quot;13031310&quot;</span><br><span class="line">    [28]=&gt;</span><br><span class="line">    string(21) &quot;master-link-down-time&quot;</span><br><span class="line">    [29]=&gt;</span><br><span class="line">    string(1) &quot;0&quot;</span><br><span class="line">    [30]=&gt;</span><br><span class="line">    string(18) &quot;master-link-status&quot;</span><br><span class="line">    [31]=&gt;</span><br><span class="line">    string(2) &quot;ok&quot;</span><br><span class="line">    [32]=&gt;</span><br><span class="line">    string(11) &quot;master-host&quot;</span><br><span class="line">    [33]=&gt;</span><br><span class="line">    string(10) &quot;172.10.0.4&quot;</span><br><span class="line">    [34]=&gt;</span><br><span class="line">    string(11) &quot;master-port&quot;</span><br><span class="line">    [35]=&gt;</span><br><span class="line">    string(4) &quot;6379&quot;</span><br><span class="line">    [36]=&gt;</span><br><span class="line">    string(14) &quot;slave-priority&quot;</span><br><span class="line">    [37]=&gt;</span><br><span class="line">    string(3) &quot;100&quot;</span><br><span class="line">    [38]=&gt;</span><br><span class="line">    string(17) &quot;slave-repl-offset&quot;</span><br><span class="line">    [39]=&gt;</span><br><span class="line">    string(7) &quot;2792254&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Redis主从复制的原理及相关问题&quot;&gt;&lt;a href=&quot;#Redis主从复制的原理及相关问题&quot; class=&quot;headerlink&quot; title=&quot;Redis主从复制的原理及相关问题&quot;&gt;&lt;/a&gt;Redis主从复制的原理及相关问题&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;保存主节
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>(一)redis docker 主从配置</title>
    <link href="http://blog.uiste.com/2019/20190922-1.html"/>
    <id>http://blog.uiste.com/2019/20190922-1.html</id>
    <published>2019-09-22T06:01:58.000Z</published>
    <updated>2020-04-26T01:05:29.352Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境相关"><a href="#环境相关" class="headerlink" title="环境相关"></a>环境相关</h1><h2 id="docker-安装参考"><a href="#docker-安装参考" class="headerlink" title="docker 安装参考"></a>docker 安装参考</h2><p>参考: <a href="https://yeasy.gitbooks.io/docker_practice/install/" target="_blank" rel="noopener">Docker 安装</a></p><h2 id="docker-lnmp-集成环境"><a href="#docker-lnmp-集成环境" class="headerlink" title="docker-lnmp 集成环境"></a>docker-lnmp 集成环境</h2><p>参考：<a href="https://github.com/uiste/docker-lnmp" target="_blank" rel="noopener">Docker-lnmp</a></p><h1 id="Redis-主从配置"><a href="#Redis-主从配置" class="headerlink" title="Redis 主从配置"></a>Redis 主从配置</h1><h2 id="指定自定义网络"><a href="#指定自定义网络" class="headerlink" title="指定自定义网络"></a>指定自定义网络</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos redis]# pwd</span><br><span class="line">/data/web/redis</span><br><span class="line"></span><br><span class="line">[root@VM_0_6_centos redis]# docker network create --subnet=172.10.0.0/16 mynetwork</span><br><span class="line">1e74de7cbd62306d0f1785e83ef5426cafb021cccd6e1bdfaa316cd7017911d9</span><br></pre></td></tr></table></figure><h2 id="创建-Dockerfile"><a href="#创建-Dockerfile" class="headerlink" title="创建 Dockerfile"></a>创建 Dockerfile</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:latest</span><br><span class="line">RUN groupadd -r redis &amp;&amp; useradd  -r -g redis redis</span><br><span class="line">RUN yum -y update &amp;&amp;  yum -y install epel-release &amp;&amp; yum -y install redis &amp;&amp; yum -y install net-tools</span><br><span class="line">EXPOSE 6379</span><br></pre></td></tr></table></figure><h2 id="在-Dockerfile-目录-执行下面的代码，注意后面上下文点号"><a href="#在-Dockerfile-目录-执行下面的代码，注意后面上下文点号" class="headerlink" title="在 Dockerfile 目录 执行下面的代码，注意后面上下文点号"></a>在 Dockerfile 目录 执行下面的代码，注意后面上下文点号</h2><p><code>docker build -t redis .</code></p><h2 id="使用此docker-镜像-创建容器"><a href="#使用此docker-镜像-创建容器" class="headerlink" title="使用此docker 镜像 创建容器"></a>使用此docker 镜像 创建容器</h2><p>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name redis-master --net mynetwork -p 6380:6379 --ip 172.10.0.2 redis</span><br><span class="line">docker run -itd --name redis-slave --net mynetwork -p 6381:6379 --ip 172.10.0.3 redis</span><br><span class="line">docker run -itd --name redis-slave2 --net mynetwork -p 6382:6379 --ip 172.10.0.4 redis</span><br></pre></td></tr></table></figure></p><p>参数说明：<br>参考: <a href="https://www.runoob.com/docker/docker-command-manual.html" target="_blank" rel="noopener">菜鸟教程文档</a></p><h3 id="查看网络"><a href="#查看网络" class="headerlink" title="查看网络"></a>查看网络</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos redis]# docker network inspect mynetwork</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mynetwork&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;1e74de7cbd62306d0f1785e83ef5426cafb021cccd6e1bdfaa316cd7017911d9&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2019-09-22T14:01:10.470838603+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.10.0.0/16&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;3391a5251e6324274a6f431b0346fabb9010cbcc0fe156c988ffb6bd20148a72&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;redis-master&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;6e6505d09e0b2a58d80a8b3e306f506dd2da8a7c77f345a051d05cce4618a6a4&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:0a:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.10.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;ff01a57b5de5d54a387d5945fe8b7d5d12b2cf3476b6f93ed6dc4a0f82fa0aef&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;redis-slave&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;5a5d3ea726d9b7b9fc7555138e209ad3ec04fa758713c210c1cd8269806f2b05&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:0a:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.10.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos redis]# docker exec -it ff01a57b5de5 /bin/bash</span><br><span class="line">[root@ff01a57b5de5 /]#</span><br></pre></td></tr></table></figure><h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><h3 id="主从复制说明"><a href="#主从复制说明" class="headerlink" title="主从复制说明"></a>主从复制说明</h3><p>为了解决单一节点 机器故障、容量瓶颈等问题，会把数据复制多个副本部署到其它节点上进行冗余备份。实现Redis的高可用。</p><blockquote><p>主从复制-&gt;哨兵-&gt;集群</p></blockquote><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>redis服务器启动后，直接通过客户端执行命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slaveof &lt;masterip&gt; &lt;masterport&gt; 则该redis实例成为从节点</span><br><span class="line"></span><br><span class="line">slaveof no one 断开连接</span><br></pre></td></tr></table></figure></p><p>修改redis保护模式 配置从节点依赖的主节点IP</p><p>主节点调整<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos redis]# docker exec -it redis-master /bin/bash</span><br><span class="line">[root@ff01a57b5de5 /]# vi /etc/redis.conf</span><br><span class="line">...</span><br><span class="line"># JUST COMMENT THE FOLLOWING LINE.</span><br><span class="line"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">#bind 127.0.0.1</span><br><span class="line">bind 0.0.0.0</span><br><span class="line"># Protected mode is a layer of security protection, in order to avoid that</span><br><span class="line"># Redis instances left open on the internet are accessed and exploited.</span><br><span class="line">#</span><br><span class="line"># When protected mode is on and if:</span><br><span class="line">#</span><br><span class="line"># 1) The server is not binding explicitly to a set of addresses using the</span><br><span class="line">#    &quot;bind&quot; directive.</span><br><span class="line"># 2) No password is configured.</span><br><span class="line">#</span><br><span class="line"># The server only accepts connections from clients connecting from the</span><br><span class="line"># IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain</span><br><span class="line"># sockets.</span><br><span class="line">#</span><br><span class="line"># By default protected mode is enabled. You should disable it only if</span><br><span class="line"># you are sure you want clients from other hosts to connect to Redis</span><br><span class="line"># even if no authentication is configured, nor a specific set of interfaces</span><br><span class="line"># are explicitly listed using the &quot;bind&quot; directive.</span><br><span class="line">#protected-mode yes</span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>从节点调整<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos redis]# docker exec -it redis-slave /bin/bash</span><br><span class="line">[root@ff01a57b5de5 /]# vi /etc/redis.conf</span><br><span class="line">...</span><br><span class="line"># JUST COMMENT THE FOLLOWING LINE.</span><br><span class="line"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">#bind 127.0.0.1</span><br><span class="line">bind 0.0.0.0</span><br><span class="line"># Protected mode is a layer of security protection, in order to avoid that</span><br><span class="line"># Redis instances left open on the internet are accessed and exploited.</span><br><span class="line">#</span><br><span class="line"># When protected mode is on and if:</span><br><span class="line">#</span><br><span class="line"># 1) The server is not binding explicitly to a set of addresses using the</span><br><span class="line">#    &quot;bind&quot; directive.</span><br><span class="line"># 2) No password is configured.</span><br><span class="line">#</span><br><span class="line"># The server only accepts connections from clients connecting from the</span><br><span class="line"># IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain</span><br><span class="line"># sockets.</span><br><span class="line">#</span><br><span class="line"># By default protected mode is enabled. You should disable it only if</span><br><span class="line"># you are sure you want clients from other hosts to connect to Redis</span><br><span class="line"># even if no authentication is configured, nor a specific set of interfaces</span><br><span class="line"># are explicitly listed using the &quot;bind&quot; directive.</span><br><span class="line">#protected-mode yes</span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line">replicaof 172.10.0.2 6379</span><br><span class="line"># If the master is password protected (using the &quot;requirepass&quot; configuration</span><br><span class="line"># directive below) it is possible to tell the replica to authenticate before</span><br><span class="line"># starting the replication synchronization process, otherwise the master will</span><br><span class="line"># refuse the replica request.</span><br><span class="line">#</span><br><span class="line"># masterauth &lt;master-password&gt;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><h3 id="数据测试"><a href="#数据测试" class="headerlink" title="数据测试"></a>数据测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_6_centos redis]# docker exec -it redis-master /bin/bash</span><br><span class="line">[root@3391a5251e63 /]# vi /etc/redis.conf</span><br><span class="line">[root@3391a5251e63 /]# redis-server /etc/redis.conf &amp;</span><br><span class="line">[1] 28</span><br><span class="line">[root@3391a5251e63 /]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set name uiste</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;uiste&quot;</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=172.10.0.3,port=6379,state=online,offset=5545,lag=0</span><br><span class="line">master_replid:73aa73a6ca2674e214b2081989f8f5cd642b1774</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:5545</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:5545</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@VM_0_6_centos ~]# docker exec -it redis-slave /bin/bash</span><br><span class="line">[root@ff01a57b5de5 /]# redis-server /etc/redis.conf &amp;</span><br><span class="line">[1] 73</span><br><span class="line">[root@ff01a57b5de5 /]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;uiste&quot;</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:172.10.0.2</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:3</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:5503</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:73aa73a6ca2674e214b2081989f8f5cd642b1774</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:5503</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:5503</span><br></pre></td></tr></table></figure><blockquote><p>多个从节点的时候，避免主节点同步压力的增加，可以将其它从节点依赖于从节点同步</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;环境相关&quot;&gt;&lt;a href=&quot;#环境相关&quot; class=&quot;headerlink&quot; title=&quot;环境相关&quot;&gt;&lt;/a&gt;环境相关&lt;/h1&gt;&lt;h2 id=&quot;docker-安装参考&quot;&gt;&lt;a href=&quot;#docker-安装参考&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>多级缓存架构设计需要解决的问题</title>
    <link href="http://blog.uiste.com/2019/20190921-1.html"/>
    <id>http://blog.uiste.com/2019/20190921-1.html</id>
    <published>2019-09-20T16:26:03.000Z</published>
    <updated>2020-04-26T01:05:29.351Z</updated>
    
    <content type="html"><![CDATA[<h2 id="亿级流量电商网站的商品详情页系统架构"><a href="#亿级流量电商网站的商品详情页系统架构" class="headerlink" title="亿级流量电商网站的商品详情页系统架构"></a>亿级流量电商网站的商品详情页系统架构</h2><p>面临难题：对于每天上亿流量，拥有上亿页面的大型电商网站来说，能够支撑高并发访问，同时能够秒级让最新模板生效的商品详情页系统的架构是如何设计的？</p><p>解决方案：异步多级缓存架构+nginx本地化缓存+动态模板渲染的架构</p><h2 id="redis企业级集群架构"><a href="#redis企业级集群架构" class="headerlink" title="redis企业级集群架构"></a>redis企业级集群架构</h2><p>面临难题：如何让redis集群支撑几十万QPS高并发+99.99%高可用+TB级海量数据+企业级数据备份与恢复？</p><p>解决方案：redis的企业级备份恢复方案+复制架构+读写分离+哨兵架构+redis cluster集群部署</p><h2 id="多级缓存架构设计"><a href="#多级缓存架构设计" class="headerlink" title="多级缓存架构设计"></a>多级缓存架构设计</h2><p>面临难题：如何将缓存架构设计的能够支撑高性能以及高并发到极致？同时还要给缓存架构最后的一个安全保护层？</p><p>解决方案：nginx抗热点数据+redis抗大规模离线请求+ehcache抗redis崩溃的三级缓存架构</p><h2 id="数据库-缓存双写一致性解决方案"><a href="#数据库-缓存双写一致性解决方案" class="headerlink" title="数据库+缓存双写一致性解决方案"></a>数据库+缓存双写一致性解决方案</h2><p>面临难题：高并发场景下，如何解决数据库与缓存双写的时候数据不一致的情况？</p><p>解决方案：异步队列串行化的数据库+缓存双写一致性解决方案</p><h2 id="缓存维度化拆分解决方案"><a href="#缓存维度化拆分解决方案" class="headerlink" title="缓存维度化拆分解决方案"></a>缓存维度化拆分解决方案</h2><p>面临难题：如何解决大value缓存的全量更新效率低下问题？</p><p>解决方案：商品缓存数据的维度化拆分解决方案</p><h2 id="缓存命中率提升解决方案"><a href="#缓存命中率提升解决方案" class="headerlink" title="缓存命中率提升解决方案"></a>缓存命中率提升解决方案</h2><p>面临难题：如何将缓存命中率提升到极致？</p><p>解决方案：双层nginx部署架构+lua脚本实现一致性hash流量分发策略</p><h2 id="缓存并发重建冲突解决方案"><a href="#缓存并发重建冲突解决方案" class="headerlink" title="缓存并发重建冲突解决方案"></a>缓存并发重建冲突解决方案</h2><p>面临难题：如何解决高并发场景下，缓存重建时的分布式并发重建的冲突问题？</p><p>解决方案：基于zookeeper分布式锁的缓存并发重建冲突解决方案</p><h2 id="缓存预热解决方案"><a href="#缓存预热解决方案" class="headerlink" title="缓存预热解决方案"></a>缓存预热解决方案</h2><p>面临难题：如何解决高并发场景下，缓存冷启动导致MySQL负载过高，甚至瞬间被打死的问题？</p><p>解决方案：基于storm实时统计热数据的分布式快速缓存预热解决方案</p><h2 id="热点缓存自动降级方案"><a href="#热点缓存自动降级方案" class="headerlink" title="热点缓存自动降级方案"></a>热点缓存自动降级方案</h2><p>面临难题：如何解决热点缓存导致单机器负载瞬间超高？</p><p>解决方案：基于storm的实时热点发现+毫秒级的实时热点缓存负载均衡降级</p><h2 id="高可用分布式系统架构设计"><a href="#高可用分布式系统架构设计" class="headerlink" title="高可用分布式系统架构设计"></a>高可用分布式系统架构设计</h2><p>面临难题：如何解决分布式系统中的服务高可用问题？避免多层服务依赖因为少量故障导致系统崩溃？</p><p>解决方案：基于hystrix的高可用缓存服务，资源隔离+限流+降级+熔断+超时控制</p><h2 id="复杂的高可用分布式系统架构设计"><a href="#复杂的高可用分布式系统架构设计" class="headerlink" title="复杂的高可用分布式系统架构设计"></a>复杂的高可用分布式系统架构设计</h2><p>面临难题：如何针对复杂的分布式系统将其中的服务设计为高可用架构？</p><p>解决方案：基于hystrix的容错+多级降级+手动降级+生产环境参数优化经验+可视化运维与监控</p><h2 id="缓存雪崩解决方案"><a href="#缓存雪崩解决方案" class="headerlink" title="缓存雪崩解决方案"></a>缓存雪崩解决方案</h2><p>面临难题：如何解决恐怖的缓存雪崩问题？避免给公司带来巨大的经济损失？</p><p>解决方案：全网独家的事前+事中+事后三层次完美缓存雪崩解决方案</p><h2 id="缓存穿透解决方案"><a href="#缓存穿透解决方案" class="headerlink" title="缓存穿透解决方案"></a>缓存穿透解决方案</h2><p>面临难题：如何解决高并发场景下的缓存穿透问题？避免给MySQL带来过大的压力？</p><p>解决方案：缓存穿透解决方案</p><h2 id="缓存失效解决方案"><a href="#缓存失效解决方案" class="headerlink" title="缓存失效解决方案"></a>缓存失效解决方案</h2><p>面临难题：如何解决高并发场景下的缓存失效问题？避免给redis集群带来过大的压力？</p><p>解决方案：基于随机过期时间的缓存失效解决方案</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;亿级流量电商网站的商品详情页系统架构&quot;&gt;&lt;a href=&quot;#亿级流量电商网站的商品详情页系统架构&quot; class=&quot;headerlink&quot; title=&quot;亿级流量电商网站的商品详情页系统架构&quot;&gt;&lt;/a&gt;亿级流量电商网站的商品详情页系统架构&lt;/h2&gt;&lt;p&gt;面临难题：对
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>git commit 提交的时候报错</title>
    <link href="http://blog.uiste.com/2019/20190830-1.html"/>
    <id>http://blog.uiste.com/2019/20190830-1.html</id>
    <published>2019-08-30T05:53:36.000Z</published>
    <updated>2020-04-26T01:05:29.350Z</updated>
    
    <content type="html"><![CDATA[<p>git commit 提交的时候报错husky &gt; pre-commit</p><p>这个问题是因为当你在终端输入git commit -m “XXX”,提交代码的时候,pre-commit(客户端)钩子，它会在Git键入提交信息前运行做代码风格检查。如果代码不符合相应规则，则报错，而它的检测规则就是根据.git/hooks/pre-commit文件里面的相关定义。查询了网上的解决办法，总结为以下三种解决方案，个人喜欢第三种：</p><blockquote><p>卸载husky。只要把项目的package.json文件中devDependencies节点下的husky库删掉，然后重新npm i 一次即可。或者直接在项目根目录下执行npm uninstall husky –save也可以，再次提交，自动化测试功能就屏蔽掉</p></blockquote><blockquote><p>进入项目的.git文件夹(文件夹默认隐藏,可先设置显示或者命令ls查找),再进入hooks文件夹,删除pre-commit文件,重新git commit -m ‘xxx’ git push即可。</p></blockquote><blockquote><p>将git commit -m “XXX” 改为 git commit –no-verify -m “XXX”</p></blockquote><p>注册页<br><a href="https://res.mimeicy.cn/lsprod/loan/35d217e7b39284.png" target="_blank" rel="noopener">https://res.mimeicy.cn/lsprod/loan/35d217e7b39284.png</a></p><p>IOS<br><a href="https://res.mimeicy.cn/lsprod/loan/75d217e4503fb4.png" target="_blank" rel="noopener">https://res.mimeicy.cn/lsprod/loan/75d217e4503fb4.png</a></p><p>安卓<br><a href="https://res.mimeicy.cn/lsprod/loan/85d217e6a2a086.png" target="_blank" rel="noopener">https://res.mimeicy.cn/lsprod/loan/85d217e6a2a086.png</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;git commit 提交的时候报错husky &amp;gt; pre-commit&lt;/p&gt;
&lt;p&gt;这个问题是因为当你在终端输入git commit -m “XXX”,提交代码的时候,pre-commit(客户端)钩子，它会在Git键入提交信息前运行做代码风格检查。如果代码不符合
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>shell 脚本</title>
    <link href="http://blog.uiste.com/2019/20190822-2.html"/>
    <id>http://blog.uiste.com/2019/20190822-2.html</id>
    <published>2019-08-22T08:06:14.000Z</published>
    <updated>2020-04-26T01:05:29.349Z</updated>
    
    <content type="html"><![CDATA[<h1 id="续"><a href="#续" class="headerlink" title="续"></a>续</h1><ol><li>基本监控系统脚本（CPU，内存，IO等）</li><li>后台服务监控、启动、停止脚本、数据备份脚本</li><li>利用grep、sed和awk的复杂用法处理文本</li><li>功能函数编写、主流程设计</li><li>具备复杂功能的大型脚本工具编写</li></ol><h1 id="变量替换"><a href="#变量替换" class="headerlink" title="变量替换"></a>变量替换</h1><table><thead><tr><th style="text-align:left">语法</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">${变量名#匹配规则}</td><td style="text-align:left">从变量开头进行规则匹配，将符合最短的数据删除</td></tr><tr><td style="text-align:left">${变量名##匹配规则}</td><td style="text-align:left">从变量开头进行规则匹配，将符合最长的数据删除</td></tr><tr><td style="text-align:left">${变量名%匹配规则}</td><td style="text-align:left">从变量尾部进行规则匹配，将符合最短的数据删除</td></tr><tr><td style="text-align:left">${变量名%%匹配规则}</td><td style="text-align:left">从变量尾部进行规则匹配，将符合最长的数据删除</td></tr><tr><td style="text-align:left">${变量名/匹配规则}</td><td style="text-align:left">变量内容符合旧字符串，则第一个旧字符串会被新字符串取代</td></tr><tr><td style="text-align:left">${变量名//匹配规则}</td><td style="text-align:left">变量内容符合旧字符串，则全部旧字符串会被新字符串取代</td></tr></tbody></table><h1 id="字符串处理"><a href="#字符串处理" class="headerlink" title="字符串处理"></a>字符串处理</h1><h2 id="计算字符串长度"><a href="#计算字符串长度" class="headerlink" title="计算字符串长度"></a>计算字符串长度</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">方法一：$&#123;#string&#125;</span><br><span class="line">方法二：expr length $string</span><br></pre></td></tr></table></figure><h2 id="获取字符索引位置"><a href="#获取字符索引位置" class="headerlink" title="获取字符索引位置"></a>获取字符索引位置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">方法：expr index &quot;$string&quot; substr</span><br></pre></td></tr></table></figure><h2 id="获取子串长度"><a href="#获取子串长度" class="headerlink" title="获取子串长度"></a>获取子串长度</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">方法：expr match &quot;$string&quot; substr</span><br></pre></td></tr></table></figure><h2 id="抽取字符串中的子串"><a href="#抽取字符串中的子串" class="headerlink" title="抽取字符串中的子串"></a>抽取字符串中的子串</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">方法一：</span><br><span class="line"></span><br><span class="line">1. $&#123;string:position&#125;</span><br><span class="line">2. $&#123;string:position:length&#125;</span><br><span class="line">3. $&#123;string: -postion&#125; 或者 $&#123;string:(position)&#125;</span><br><span class="line"></span><br><span class="line">方法二：</span><br><span class="line">`expr substr $string $position $length`</span><br><span class="line"></span><br><span class="line">&gt;使用expr，索引计数从1开始计算；使用`$&#123;string:positon:length&#125;`，索引计数从0开始</span><br></pre></td></tr></table></figure><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">string=<span class="string">"Bigdata process framework is Hadoop,Hadoop is an open source project"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> print_tips</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"*********************************"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"(1) 打印string长度"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"(2) 删除字符串中所有的Hadoop"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"(3) 替换第一个Hadoop为Mapreduce"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"(4) 替换全部的Hadoop为Mapreduce"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"*********************************"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> len_of_string</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;#string&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> del_hadoop</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;string//Hadoop/&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> rep_hadoop_mapreduce_first</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;string/Hadoop/Mapreduce&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> rep_hadoop_mapreduce_all</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;string//Hadoop/Mapreduce&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"【string=<span class="variable">$string</span>]"</span></span><br><span class="line">print_tips</span><br><span class="line"><span class="built_in">read</span> -p <span class="string">"please input your choice(1|2|3|4|q|Q): "</span> choice</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$choice</span> <span class="keyword">in</span> </span><br><span class="line">1)</span><br><span class="line">len_of_string</span><br><span class="line">;;</span><br><span class="line">2)</span><br><span class="line">del_hadoop</span><br><span class="line">;;</span><br><span class="line">3)</span><br><span class="line">rep_hadoop_mapreduce_first</span><br><span class="line">;;</span><br><span class="line">4)</span><br><span class="line">rep_hadoop_mapreduce_all</span><br><span class="line">;;</span><br><span class="line">q|Q)</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Error, Input only in (1|2|3|4|q|Q)"</span></span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h1 id="命令替换"><a href="#命令替换" class="headerlink" title="命令替换"></a>命令替换</h1><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>方法一：<code>command</code><br>方法二：<code>$(command)</code></p><ul><li><p>例子1：<br>获取系统的所有用户并输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">index=1</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> `cat /etc/passwd | cut -d <span class="string">":"</span> -f 1`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"This is <span class="variable">$index</span> user : <span class="variable">$user</span>"</span></span><br><span class="line">index=$((<span class="variable">$index</span>+1))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></li><li><p>例子2：<br>根据系统时间计算今年或明年</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;This is $(date +%Y) year&quot;</span><br><span class="line">echo &quot;This is $(($(date +%Y) + 1)) year &quot;</span><br></pre></td></tr></table></figure></li><li><p>例子3：<br>根据系统时间获取今年还剩下多少星期，已经过了多少星期</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;This year have passed $(date +%j) days&quot;</span><br><span class="line">echo &quot;This year have passed $(($(date +%j)/7)) weeks&quot;</span><br></pre></td></tr></table></figure></li><li><p>例子4：<br>判定nginx进程是否存在，若不存在则自动拉起该进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">nginx_process_num=$(ps -ef | grep nginx | grep -v grep | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$nginx_process_num</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line"><span class="comment">#systemctl start nginx</span></span><br><span class="line">brew services start nginx</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></li></ul><blockquote><p>`` 和 $() 两者是等价的，但推荐使用 $() ，易于掌握；缺点是极少数Unix可能不支持<br>$(()) 主要用来进行整数运算，包括加减乘除，引用变量前面可以加$，也可以不加$</p></blockquote><h1 id="变量类型"><a href="#变量类型" class="headerlink" title="变量类型"></a>变量类型</h1><h2 id="声明变量类型为只读类型"><a href="#声明变量类型为只读类型" class="headerlink" title="声明变量类型为只读类型"></a>声明变量类型为只读类型</h2><p><code>declare -r var=&quot;hello&quot;</code></p><h2 id="声明变量类型为整形"><a href="#声明变量类型为整形" class="headerlink" title="声明变量类型为整形"></a>声明变量类型为整形</h2><p><code>declare -i</code></p><h2 id="在脚本中显示定义的函数和内容"><a href="#在脚本中显示定义的函数和内容" class="headerlink" title="在脚本中显示定义的函数和内容"></a>在脚本中显示定义的函数和内容</h2><p><code>declare -f</code></p><h2 id="在脚本中显示定义的函数"><a href="#在脚本中显示定义的函数" class="headerlink" title="在脚本中显示定义的函数"></a>在脚本中显示定义的函数</h2><p><code>declare -F</code></p><h2 id="声明数组"><a href="#声明数组" class="headerlink" title="声明数组"></a>声明数组</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">declare</span> -a array</span><br><span class="line">array=(<span class="string">"jones"</span> <span class="string">"mike"</span> <span class="string">"kobe"</span> <span class="string">'jordan'</span>)</span><br><span class="line"></span><br><span class="line">输出数组内容：</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;array[@]&#125;</span> 输出全部内容</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;array[1]&#125;</span> 输出下标索引为1的内容</span><br><span class="line"></span><br><span class="line">获取数组长度</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;#array[@]&#125;</span> 输出数组内元素的个数</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;#array[2]&#125;</span> 输出数组下标索引为2的元素的长度</span><br><span class="line"></span><br><span class="line">给数组某个下标赋值</span><br><span class="line">array[0] = <span class="string">'lily'</span></span><br><span class="line"></span><br><span class="line">删除元素</span><br><span class="line"><span class="built_in">unset</span> array[2] 清空元素</span><br></pre></td></tr></table></figure><h1 id="数学运算之expr"><a href="#数学运算之expr" class="headerlink" title="数学运算之expr"></a>数学运算之expr</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|</span><br><span class="line">&amp;</span><br><span class="line">&gt;</span><br><span class="line">&gt;=</span><br><span class="line">&lt;</span><br><span class="line">&lt;=</span><br><span class="line">=</span><br><span class="line">!=</span><br><span class="line">+</span><br><span class="line">-</span><br><span class="line">*</span><br><span class="line">/</span><br><span class="line">%</span><br></pre></td></tr></table></figure><h1 id="Nginx-监控脚本"><a href="#Nginx-监控脚本" class="headerlink" title="Nginx 监控脚本"></a>Nginx 监控脚本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">this_pid=$$</span><br><span class="line">status=`ps -ef | grep nginx | grep -v nginx | grep -v <span class="variable">$this_pid</span> &amp;&gt; /dev/null`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$status</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx is running well"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">systemctl start nginx</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx is down, Start it ..."</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;续&quot;&gt;&lt;a href=&quot;#续&quot; class=&quot;headerlink&quot; title=&quot;续&quot;&gt;&lt;/a&gt;续&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;基本监控系统脚本（CPU，内存，IO等）&lt;/li&gt;
&lt;li&gt;后台服务监控、启动、停止脚本、数据备份脚本&lt;/li&gt;
&lt;li&gt;利用grep、
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>（一）nginx 原理与模块</title>
    <link href="http://blog.uiste.com/2019/20190801-1.html"/>
    <id>http://blog.uiste.com/2019/20190801-1.html</id>
    <published>2019-08-01T08:44:44.000Z</published>
    <updated>2020-04-26T11:04:57.569Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://wizardforcel.gitbooks.io/nginx-doc/content/Text/1.3_install.html" target="_blank" rel="noopener">官方文档参考1</a><br><a href="https://tengine.taobao.org/nginx_docs/cn/docs/" target="_blank" rel="noopener">Tengine文档参考2</a></p><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>正向代理</p><blockquote><p>代购、翻墙工具。特点客户端非常明确要访问的服务器地址，服务器只清楚请求来自哪个代理服务器，而不请求具体的客户端。</p></blockquote><p>方向代理</p><blockquote><p>负载均衡、分布式部署。特点按照一定的规则分发给后盾业务处理服务器。来源是客户端请求去哪里由代理服务器根据规则决定。</p></blockquote><h2 id="NGINX特性："><a href="#NGINX特性：" class="headerlink" title="NGINX特性："></a>NGINX特性：</h2><ol><li>更快</li><li>高扩展性（HTTP核心模块、events模块、log模块）</li><li>高可靠性（进程相对独立，master在起个worker进程出错时可以快速拉起新的worker子进行提供服务）</li><li>低内存消耗（1w个非活跃的HTTP keep-alive 连接 在NGINX中消耗2.5MB的内存）</li><li>单机支持10万以上的并发连接</li><li>热部署（master与worker进程的分离设计）</li><li>最自由的bsd许可协议</li></ol><h2 id="web请求处理流程"><a href="#web请求处理流程" class="headerlink" title="web请求处理流程"></a>web请求处理流程</h2><p><img src="../../../assets/imgs/201908010101.png" alt="web请求处理流程"></p><h2 id="nginx高效的原因"><a href="#nginx高效的原因" class="headerlink" title="nginx高效的原因"></a>nginx高效的原因</h2><ol><li>多进程方式</li></ol><h2 id="TCP-和-UDP"><a href="#TCP-和-UDP" class="headerlink" title="TCP 和 UDP"></a>TCP 和 UDP</h2><blockquote><p>UDP和TCP最大的区别，UDP不可靠，只管发送不管是否接受到</p></blockquote><h2 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h2><p>pcntl扩展是PHP在Linux环境下进程控制的重要扩展，WorkerMan用到了其进程创建、信号控制、定时器、进程状态监控等特性。此扩展win平台不支持。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">for ($i=0;$i&lt;3;$i++)&#123;</span><br><span class="line">    $pid=pcntl_fork();  //创建子进程</span><br><span class="line">    //父进程和子进程都会执行下面代码</span><br><span class="line">    if ($pid == -1) &#123;</span><br><span class="line">        //错误处理：创建子进程失败时返回-1.</span><br><span class="line">        die(&apos;could not fork&apos;);</span><br><span class="line">    &#125; else if ($pid) &#123;</span><br><span class="line">        //父进程会得到子进程号，所以这里是父进程执行的逻辑</span><br><span class="line">        var_dump(&apos;父进程&apos;,$pid);</span><br><span class="line">        pcntl_wait($status); //等待子进程中断，防止子进程成为僵尸进程。</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //子进程得到的$pid为0, 所以这里是子进程执行的逻辑。</span><br><span class="line">        sleep(5);</span><br><span class="line">        var_dump(&apos;子进程&apos;,$pid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>安装pcntl模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http://cn2.php.net/distributions/php-7.1.14.tar.xz</span><br><span class="line">tar xf php-7.1.14.tar.xz</span><br><span class="line">cd php-7.1.14</span><br><span class="line">cd ext/pcntl</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/usr/bin/php-config</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">echo &quot;extension=pcntl.so&quot; &gt;&gt; /etc/php.ini</span><br></pre></td></tr></table></figure></p><h2 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h2><p>就是通过一种机制，一个进程可以监视多个描述符（socket），一旦某个描述符就绪，能够通知程序执行相应的读写操作。<br>epoll是在2.6内核中提出的。是之前select和poll的增强版。select、poll问题就是需要循环检测连接是否有事件。没有描述符限制，无需轮询。epoll使用一个文件描述符管理多个描述符，当连接有I/O流时间产生的时候，epoll就会告诉警察连接有I/O流事件产生，然后警察就去处理这个进程。<br>NGINX就是基于epoll的异步非阻塞的服务器程序。自然，nginx能够轻松处理百万级的并发连接。</p><p>安装libevent依赖:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">官网：http://www.monkey.org/~provos/libevent/</span><br><span class="line">下载：http://www.monkey.org/~provos/libevent-2.0.10-stable.tar.gz</span><br><span class="line">tar zxvf libevent-2.0.10-stable.tar.gz</span><br><span class="line">cd libevent-2.0.10-stable</span><br><span class="line">    ./configure  –prefix=/usr   //安装路径设置</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">测试libevent是否安装成功：</span><br><span class="line">    ls -al /usr/lib | grep libevent</span><br></pre></td></tr></table></figure></p><p>安装event扩展:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    cd /usr/local/src</span><br><span class="line">   wget http://pecl.php.net/get/event-2.3.0.tgz</span><br><span class="line"></span><br><span class="line">    tar -zxvf event-2.3.0.tgz &amp;&amp; cd event-2.3.0</span><br><span class="line"></span><br><span class="line">    /usr/local/php/bin/phpize</span><br><span class="line"></span><br><span class="line">    ./configure  --with-event-libevent-dir=/usr/local/libevent-2.1.8-stable/    </span><br><span class="line"></span><br><span class="line">注意 --with-event-libevent-dir   libevent的安装目录</span><br><span class="line">    make &amp;&amp; make install</span><br><span class="line">在/usr/local/php/etc/ 目录下，复制php.ini 为php-cli.ini 添加下面配置</span><br><span class="line">extension=event.so</span><br></pre></td></tr></table></figure></p><h2 id="进程工作内容"><a href="#进程工作内容" class="headerlink" title="进程工作内容"></a>进程工作内容</h2><h3 id="master进程"><a href="#master进程" class="headerlink" title="master进程"></a>master进程</h3><ol><li><p>Nginx启动后，会产生一个主进程，主进程执行一系列的工作后会产生一个或者多个工作进程</p></li><li><p>在客户端请求动态站点的过程中，Nginx服务器还涉及和后端服务器的通信。Nginx将接收到的Web请求通过代理转发到后端服务器，由后端服务器进行数据处理和组织；</p></li><li><p>Nginx为了提高对请求的响应效率，降低网络压力，采用了缓存机制，将历史应答数据缓存到本地。保障对缓存文件的快速访问</p></li></ol><p>master进程主要用来管理worker进程，具体包括以下主要功能：</p><p>（1）接收来自外界的信号。<br>（2）处理配置文件读取。<br>（3）创建，绑定和关闭套接字<br>（4）启动，终止和维护配置的工作(worker)进程数<br>（5）当woker进程退出后（异常情况下），会自动重新启动新的woker进程。</p><h3 id="worker进程"><a href="#worker进程" class="headerlink" title="worker进程"></a>worker进程</h3><p>worker进程的主要任务是完成具体的任务逻辑。其主要关注点是与客户端或后端真实服务器（此时nginx作为中间代理）之间的数据可读/可写等I/O交互事件。<br>（1）接收客户端请求；<br>（2）将请求一次送入各个功能模块进行过滤处理；<br>（3）与后端服务器通信，接收后端服务器处理结果；<br>（4）数据缓存<br>（5）响应客户端请求</p><h2 id="nginx-编译安装"><a href="#nginx-编译安装" class="headerlink" title="nginx 编译安装"></a>nginx 编译安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">yum -y install   pcre pcre-devel zlib zlib-devel openssl  openssl-devel</span><br><span class="line"></span><br><span class="line">wget  http://nginx.org/download/nginx-1.14.1.tar.gz</span><br><span class="line"></span><br><span class="line">tar -zxvf nginx-1.14.1.tar.gz</span><br><span class="line"></span><br><span class="line">cd nginx-1.14.1</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_gzip_static_module --with-http_realip_module --with-http_sub_module --with-http_ssl_module --with-http_realip_module --with-http_sub_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_auth_request_module --with-http_random_index_module --with-http_slice_module --with-http_stub_status_module </span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">test -d &apos;/usr/local/nginx&apos; || mkdir -p &apos;/usr/local/nginx&apos;</span><br><span class="line">test -d &apos;/usr/local/nginx/sbin&apos; \</span><br><span class="line">|| mkdir -p &apos;/usr/local/nginx/sbin&apos;</span><br><span class="line">test ! -f &apos;/usr/local/nginx/sbin/nginx&apos; \</span><br><span class="line">|| mv &apos;/usr/local/nginx/sbin/nginx&apos; \</span><br><span class="line">&apos;/usr/local/nginx/sbin/nginx.old&apos;</span><br><span class="line">cp objs/nginx &apos;/usr/local/nginx/sbin/nginx&apos;</span><br><span class="line">test -d &apos;/usr/local/nginx/conf&apos; \</span><br><span class="line">|| mkdir -p &apos;/usr/local/nginx/conf&apos;</span><br><span class="line">cp conf/koi-win &apos;/usr/local/nginx/conf&apos;</span><br><span class="line">cp conf/koi-utf &apos;/usr/local/nginx/conf&apos;</span><br><span class="line">cp conf/win-utf &apos;/usr/local/nginx/conf&apos;</span><br><span class="line">test -f &apos;/usr/local/nginx/conf/mime.types&apos; \</span><br><span class="line">|| cp conf/mime.types &apos;/usr/local/nginx/conf&apos;</span><br><span class="line">cp conf/mime.types &apos;/usr/local/nginx/conf/mime.types.default&apos;</span><br><span class="line">test -f &apos;/usr/local/nginx/conf/fastcgi_params&apos; \</span><br><span class="line">|| cp conf/fastcgi_params &apos;/usr/local/nginx/conf&apos;</span><br><span class="line">cp conf/fastcgi_params \</span><br><span class="line">&apos;/usr/local/nginx/conf/fastcgi_params.default&apos;</span><br><span class="line">test -f &apos;/usr/local/nginx/conf/fastcgi.conf&apos; \</span><br><span class="line">|| cp conf/fastcgi.conf &apos;/usr/local/nginx/conf&apos;</span><br><span class="line">cp conf/fastcgi.conf &apos;/usr/local/nginx/conf/fastcgi.conf.default&apos;</span><br><span class="line">test -f &apos;/usr/local/nginx/conf/uwsgi_params&apos; \</span><br><span class="line">|| cp conf/uwsgi_params &apos;/usr/local/nginx/conf&apos;</span><br><span class="line">cp conf/uwsgi_params \</span><br><span class="line">&apos;/usr/local/nginx/conf/uwsgi_params.default&apos;</span><br><span class="line">test -f &apos;/usr/local/nginx/conf/scgi_params&apos; \</span><br><span class="line">|| cp conf/scgi_params &apos;/usr/local/nginx/conf&apos;</span><br><span class="line">cp conf/scgi_params \</span><br><span class="line">&apos;/usr/local/nginx/conf/scgi_params.default&apos;</span><br><span class="line">test -f &apos;/usr/local/nginx/conf/nginx.conf&apos; \</span><br><span class="line">|| cp conf/nginx.conf &apos;/usr/local/nginx/conf/nginx.conf&apos;</span><br><span class="line">cp conf/nginx.conf &apos;/usr/local/nginx/conf/nginx.conf.default&apos;</span><br><span class="line">test -d &apos;/usr/local/nginx/logs&apos; \</span><br><span class="line">|| mkdir -p &apos;/usr/local/nginx/logs&apos;</span><br><span class="line">test -d &apos;/usr/local/nginx/logs&apos; \</span><br><span class="line">|| mkdir -p &apos;/usr/local/nginx/logs&apos;</span><br><span class="line">test -d &apos;/usr/local/nginx/html&apos; \</span><br><span class="line">|| cp -R html &apos;/usr/local/nginx&apos;</span><br><span class="line">test -d &apos;/usr/local/nginx/logs&apos; \</span><br><span class="line">|| mkdir -p &apos;/usr/local/nginx/logs&apos;</span><br><span class="line">make[1]: Leaving directory `/root/nginx-1.14.1&apos;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx</span><br><span class="line">启动：</span><br><span class="line">nginx -c /usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><p><img src="../../../assets/imgs/201908010102.png" alt="nginx-config"></p><h2 id="nginx常用命令"><a href="#nginx常用命令" class="headerlink" title="nginx常用命令"></a>nginx常用命令</h2><p>1、查看Nginx的版本号：nginx  -V<br>2、停止 nginx -s stop<br>3、退出 nginx -s quit<br>4、重启加载配置 nginx -s reload<br>5、配置文件启动 nginx  -c &lt;/path/to/config&gt; 为 Nginx 指定一个配置文件，来代替缺省的<br>6、nginx  -t 不运行，而仅仅测试配置文件。nginx 将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>配置块: location<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">语法： location[=|~|~*|^~|@]/uri/&#123;...&#125;</span><br><span class="line">配置块： server</span><br><span class="line">location会尝试根据用户请求中的URI来匹配上面的/uri表达式，如果可以匹配，就选择</span><br><span class="line">location&#123;&#125;块中的配置来处理用户请求。当然，匹配方式是多样的，下面介绍location的匹配</span><br><span class="line">规则。</span><br><span class="line"></span><br><span class="line">location表达式类型</span><br><span class="line">~ 表示执行一个正则匹配，区分大小写；</span><br><span class="line">~* 表示执行一个正则匹配，不区分大小写；</span><br><span class="line">^~ 表示普通字符匹配。使用前缀匹配。如果匹配成功，则不再匹配其他location；</span><br><span class="line">= 进行普通字符精确匹配。也就是完全匹配；</span><br><span class="line">@ 它定义一个命名的 location，使用在内部定向时，例如 error_page, try_files</span><br><span class="line"></span><br><span class="line">优先级：</span><br><span class="line">等号类型（=）的优先级最高。一旦匹配成功，则不再查找其他匹配项</span><br><span class="line">前缀普通匹配(^~)优先级次之。不支持正则表达式。使用前缀匹配，如果有多个location匹配的话，则使用表达式最长的那个</span><br><span class="line">正则表达式类型（~ ~*）的优先级次之。一旦匹配成功，则不再查找其他匹配项</span><br><span class="line">常规字符串匹配，如果有多个location匹配的话，则使用表达式最长的那个</span><br><span class="line"></span><br><span class="line">(location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 部分起始路径)</span><br></pre></td></tr></table></figure></p><p>访问控制模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">用来对特定IP的进行访问控制</span><br><span class="line">默认是允许所有ip访问，若部分允许需定义deny all</span><br><span class="line">allow</span><br><span class="line">语法:   allow address | CIDR | unix: | all;</span><br><span class="line">默认值:     —</span><br><span class="line">区块: http, server, location, limit_except</span><br><span class="line">允许某个ip或者一个ip段访问</span><br><span class="line"></span><br><span class="line">deny</span><br><span class="line">语法:     deny address | CIDR | unix: | all;</span><br><span class="line">默认值:     —</span><br><span class="line">区块:     http, server, location, limit_except</span><br><span class="line"></span><br><span class="line">allow、deny实例</span><br><span class="line">location / &#123;</span><br><span class="line">deny  192.168.1.1;</span><br><span class="line">allow 192.168.1.0/24;</span><br><span class="line">allow 47.98.147.49;</span><br><span class="line">deny  all;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line"> </span><br><span class="line">比如可以限制某些目录下的某些文件的访问，具体可以自己组合</span><br><span class="line"></span><br><span class="line">禁止访问所有目录下的sql|log|txt|jar|sh|py后缀的文件，</span><br><span class="line"></span><br><span class="line">location ~.*\.(sql|log|txt|jar|war|sh|py|php) &#123;</span><br><span class="line">     deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="if模块"><a href="#if模块" class="headerlink" title="if模块"></a>if模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if指令</span><br><span class="line">语法：if(condition)&#123;…&#125;</span><br><span class="line">区块：server，location</span><br><span class="line">该指令用于检查一个条件是否符合，如果条件符合，则执行大括号内的语句。if指令不支持嵌套，不支持多个条件&amp;&amp;和||处理。</span><br><span class="line">其中，condition中可以包含的判断标识如下</span><br><span class="line">~为区分大小写匹配</span><br><span class="line">~*为不区分大小写匹配</span><br><span class="line">-f和!-f用来判断是否存在文件</span><br><span class="line">-d和!-d用来判断是否存在目录</span><br><span class="line">-e和!-e用来判断是否存在文件或目录</span><br><span class="line">-x和!-x用来判断文件是否可执行</span><br></pre></td></tr></table></figure><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><blockquote><p>IO多路复用epoll<br>模块化轻量化<br>CPU亲和（CPU核心worker进程绑定分配）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 几个物理CPU</span><br><span class="line">cat /proc/cpuinfo|grep &quot;physical id&quot; | sort | uniq | wc | -l</span><br><span class="line"></span><br><span class="line"># 几个核心</span><br><span class="line">cat /proc/cpuinfo|grep &quot;cpu cores&quot; | uniq</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="中间件架构"><a href="#中间件架构" class="headerlink" title="中间件架构"></a>中间件架构</h2><ol><li>静态资源web服务</li><li>代理服务</li><li>负载均衡调度器</li><li>动态缓存<blockquote><p>proxy_cache</p></blockquote></li></ol><h2 id="动态负载均衡"><a href="#动态负载均衡" class="headerlink" title="动态负载均衡"></a>动态负载均衡</h2><p>nginx-upsync-module提供了动态的负载均衡，动态更新上游的服务器不需要reload nginx，它的功能是拉取 consul 的后端 server 的列表，并更新 Nginx 的路由信息。此模块不依赖于任何第三方模块。 consul 作为 Nginx 的 db，利用 consul 的 KV 服务，每个 Nginx work 进程独立的去拉取各个 upstream 的配置，并更新各自的路由。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget  https://github.com/weibocom/nginx-upsync-module/archive/v2.1.0.tar.gz</span><br><span class="line"></span><br><span class="line">--add-module=/root/nginx-upsync-module-2.1.0</span><br><span class="line"></span><br><span class="line">      示例：</span><br><span class="line">upstream swoole_test &#123;</span><br><span class="line">        upsync  127.0.0.1:8700/v1/kv/upstreams/swoole_test upsync_timeout=6m upsync_interval=500ms  upsync_type=consul  strong_dependency=off;</span><br><span class="line">        upsync_dump_path /usr/local/nginx/conf/servers_test.conf;</span><br><span class="line">        include /usr/local/nginx/conf/servers_test.conf;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>upsync模块会去consul拉取最新的upstream信息并存到本地的文件中<br>upsync_timeout 配置从consul拉取上游服务器的超时时间<br>upsync_interval 配置从consul拉取上游服务器的间隔时间<br>upsync_type 指定使用配置服务器的类型，当前是consul<br>strong_dependency 启动时是否强制依赖配置服务器，如果配置为on,则拉取失败，nginx同样会启用失败</p><p>upsync_dump_path 指定从consul拉取的上游服务器后持久化到的位置，这样即使<br>Consul服务器出问题了，本地同样会有备份</p><p>添加的时候要注意名称模块的匹配：</p><p>2、安装consul<br> 对于consul的介绍可以移步到另外的文档，暂时先了解就行，我们可以先通过docker的方式pull一个consul<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> curl -X PUT -d &apos;&#123;&quot;weight&quot;:1, &quot;max_fails&quot;:2, &quot;fail_timeout&quot;:10&#125;&apos; http://$consul_ip:$port/v1/kv/$dir1/$upstream_name/$backend_ip:$backend_port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -X PUT -d &apos;&#123;&quot;weight&quot;:1,&quot;max_fails&quot;:2,&quot;fail_timeout&quot;:10&#125;&apos; http://127.0.0.1:8700/v1/kv/upstreams/swoole_test/127.0.0.1:9501</span><br></pre></td></tr></table></figure></p><p>查看所有已经存储的k/v<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl  http://127.0.0.1:8700/v1/kv/?recurse</span><br></pre></td></tr></table></figure></p><p>删除<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl  -X  DELETE  http://127.0.0.1:8700/v1/kv/upstreams/swoole_test/127.0.0.1:9501</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://wizardforcel.gitbooks.io/nginx-doc/content/Text/1.3_install.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;官方文档参考1&lt;/a&gt;&lt;br&gt;&lt;a href=
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>放松等待</title>
    <link href="http://blog.uiste.com/2019/20190630-1.html"/>
    <id>http://blog.uiste.com/2019/20190630-1.html</id>
    <published>2019-06-30T02:18:56.000Z</published>
    <updated>2020-04-26T01:05:29.347Z</updated>
    
    <content type="html"><![CDATA[<p>纽约时间比加州时间早三个小时，</p><p>New York is 3 hours ahead of California,</p><p>但加州时间并没有变慢。</p><p>but it does not make California slow.</p><p>有人22岁就毕业了，</p><p>Someone graduated at the age of 22,</p><p>但等了五年才找到好的工作！</p><p>but waited 5 years before securing a good job!</p><p>有人25岁就当上CEO，</p><p>Someone became a CEO at 25,</p><p>却在50岁去世。</p><p>and died at 50.</p><p>也有人迟到50岁才当上CEO，</p><p>While another became a CEO at 50,</p><p>然后活到90岁。</p><p>and lived to 90 years.</p><p>有人依然单身，</p><p>Someone is still single,</p><p>同时也有人已婚。</p><p>while someone else got married.</p><p>奥巴马55岁就退休，</p><p>Obama retires at 55,</p><p>川普70岁才开始当总统。</p><p>but Trump starts at 70.</p><p>世上每个人本来就有自己的发展时区。</p><p>Absolutely everyone in this world works based on their Time Zone.</p><p>身边有些人看似走在你前面，</p><p>People around you might seem to go ahead of you,</p><p>也有人看似走在你后面。</p><p>some might seem to be behind you.</p><p>但其实每个人在自己的时区有自己的步程。</p><p>But everyone is running their own RACE, in their own TIME.</p><p>不用嫉妒或嘲笑他们。</p><p>Don’t envy them or mock them.</p><p>他们都在自己的时区里，你也是！</p><p>They are in their TIME ZONE, and you are in yours!</p><p>生命就是等待正确的行动时机。</p><p>Life is about waiting for the right moment to act.</p><p>所以，放轻松。</p><p>So, RELAX.</p><p>你没有落后。</p><p>You’re not LATE.</p><p>你没有领先。</p><p>You’re not EARLY.</p><p>在命运为你安排的属于自己的时区里，一切都准时。</p><p>You are very much ON TIME, and in your TIME ZONE Destiny set up for you.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;纽约时间比加州时间早三个小时，&lt;/p&gt;
&lt;p&gt;New York is 3 hours ahead of California,&lt;/p&gt;
&lt;p&gt;但加州时间并没有变慢。&lt;/p&gt;
&lt;p&gt;but it does not make California slow.&lt;/p&gt;
&lt;p&gt;有人
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Elasticsearch第三篇！</title>
    <link href="http://blog.uiste.com/2019/20190507-1.html"/>
    <id>http://blog.uiste.com/2019/20190507-1.html</id>
    <published>2019-05-07T02:18:56.000Z</published>
    <updated>2020-04-26T01:05:35.691Z</updated>
    
    <content type="html"><![CDATA[<h1 id="API操作——-新建或删除查询索引库"><a href="#API操作——-新建或删除查询索引库" class="headerlink" title="API操作—— 新建或删除查询索引库"></a>API操作—— 新建或删除查询索引库</h1><h2 id="新建索引库"><a href="#新建索引库" class="headerlink" title="新建索引库"></a>新建索引库</h2><p>新建index，要向服务器发送一个PUT请求，下面是使用curl命令新建了一个名为test的index的例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;localhost:9200/test&apos;</span><br><span class="line">Response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;acknowledged&quot;: true,</span><br><span class="line">    &quot;shards_acknowledged&quot;: true,</span><br><span class="line">    &quot;index&quot;: &quot;test&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="删除索引库"><a href="#删除索引库" class="headerlink" title="删除索引库"></a>删除索引库</h2><p>删除index，要向服务器发送一个delete请求，下面是删除上面的test的index的例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE &apos;http://localhost:9200/customer&apos;</span><br><span class="line">Response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;acknowledged&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="查询索引库"><a href="#查询索引库" class="headerlink" title="查询索引库"></a>查询索引库</h2><p>查询index，要发送一个HEAD请求，例子如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -IHEAD &apos;localhost:9200/test&apos;</span><br><span class="line">Reponse:</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">content-type: application/json; charset=UTF-8</span><br><span class="line">content-length: 359</span><br></pre></td></tr></table></figure></p><h1 id="API操作——-创建映射关系"><a href="#API操作——-创建映射关系" class="headerlink" title="API操作—— 创建映射关系"></a>API操作—— 创建映射关系</h1><p>接下来的操作用curl比较不方便，复杂的内容使用PostMan进行操作，创建映射关系要使用PUT请求，如下json代码代表我定义了三个字段，分别是title，url和doc，他们的type属性即为数据类型，关于elasticsearch的数据类型这里不过多赘述，analyzer为ik_max_word代表使用了ik分词器的最粗粒度分词<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT test/_mapping</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;url&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;doc&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Reponse:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;acknowledged&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="API操作——-查询映射关系"><a href="#API操作——-查询映射关系" class="headerlink" title="API操作—— 查询映射关系"></a>API操作—— 查询映射关系</h1><p>查询索引库的映射关系要使用GET请求，如下我查询了上面创建的映射关系<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;localhost:9200/test/_mapping&apos;</span><br><span class="line">Response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;test&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;doc&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;analyzer&quot; : &quot;ik_max_word&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;title&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;analyzer&quot; : &quot;ik_max_word&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;url&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="API操作——-添加更新文档"><a href="#API操作——-添加更新文档" class="headerlink" title="API操作—— 添加更新文档"></a>API操作—— 添加更新文档</h1><h2 id="添加文档"><a href="#添加文档" class="headerlink" title="添加文档"></a>添加文档</h2><p>添加数据使用GET请求发送json数据，以上面的索引库为例，我添加以下数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET test/_doc</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;PlumK&apos;s blog&quot;,</span><br><span class="line">    &quot;url&quot;: &quot;plumk.site&quot;,</span><br><span class="line">    &quot;doc&quot;: &quot;this is the content,这里是正文&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><p>更新数据需要知道数据的id，可以通过查找获得，其他的跟添加数据差不多，GET请求<a href="http://localhost:9200/test/_doc/bm87BW8BcAj1cF19_7Sfjson如下：（这里的bm87BW8BcAj1cF19_7Sf就是我上面插入数据的id）" target="_blank" rel="noopener">http://localhost:9200/test/_doc/bm87BW8BcAj1cF19_7Sfjson如下：（这里的bm87BW8BcAj1cF19_7Sf就是我上面插入数据的id）</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET test/_doc/bm87BW8BcAj1cF19_7Sf</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;PlumK&apos;s blog&quot;,</span><br><span class="line">    &quot;url&quot;: &quot;plumk.site&quot;,</span><br><span class="line">    &quot;doc&quot;: &quot;this is the content,这里是修改后的正文&quot;</span><br><span class="line">&#125;</span><br><span class="line">Response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;test&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;bm87BW8BcAj1cF19_7Sf&quot;,</span><br><span class="line">    &quot;_version&quot;: 2,</span><br><span class="line">    &quot;result&quot;: &quot;updated&quot;,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 1,</span><br><span class="line">    &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="API操作——-删除文档"><a href="#API操作——-删除文档" class="headerlink" title="API操作—— 删除文档"></a>API操作—— 删除文档</h1><p>删除数据同样需要知道id，以删除上面的数据为例，对下面url发送DELETE请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:9200/test/_doc/bm87BW8BcAj1cF19_7Sf</span><br></pre></td></tr></table></figure></p><h1 id="API操作——-查询文档"><a href="#API操作——-查询文档" class="headerlink" title="API操作—— 查询文档"></a>API操作—— 查询文档</h1><h2 id="Match-all查询"><a href="#Match-all查询" class="headerlink" title="Match all查询"></a>Match all查询</h2><p>最基本的查询，他将返回所有结果，每个对象的得分为1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">POST /test/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;:&#123;</span><br><span class="line">      &quot;match_all&quot;:&#123;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">Response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 9,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 1,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 1.0,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;test&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;bm87BW8BcAj1cF19_7Sf&quot;,</span><br><span class="line">                &quot;_score&quot;: 1.0,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;PlumK&apos;s blog&quot;,</span><br><span class="line">                    &quot;url&quot;: &quot;plumk.site&quot;,</span><br><span class="line">                    &quot;doc&quot;: &quot;this is the content,这里是正文&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Match查询"><a href="#Match查询" class="headerlink" title="Match查询"></a>Match查询</h2><p>match查询返回match中属性相同的条目，下面如果url为plumk就查询不到了，也就是说必须属性完全相同<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">POST test/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">            &quot;url&quot;: &quot;plumk.site&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Reponse:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 11,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 1,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 0.2876821,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;test&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;bm87BW8BcAj1cF19_7Sf&quot;,</span><br><span class="line">                &quot;_score&quot;: 0.2876821,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;PlumK&apos;s blog&quot;,</span><br><span class="line">                    &quot;url&quot;: &quot;plumk.site&quot;,</span><br><span class="line">                    &quot;doc&quot;: &quot;this is the content,这里是修改后的正文&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Query-String查询"><a href="#Query-String查询" class="headerlink" title="Query String查询"></a>Query String查询</h2><p>该查询使用查询解析器和query_string关键字。例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">POST test/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;query_string&quot;: &#123;</span><br><span class="line">            &quot;query&quot;: &quot;plumk&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 25,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 1,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 0.2876821,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;test&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;bm87BW8BcAj1cF19_7Sf&quot;,</span><br><span class="line">                &quot;_score&quot;: 0.2876821,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;PlumK&apos;s blog&quot;,</span><br><span class="line">                    &quot;url&quot;: &quot;plumk.site&quot;,</span><br><span class="line">                    &quot;doc&quot;: &quot;this is the content,这里是修改后的正文&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="设置最小匹配度查询"><a href="#设置最小匹配度查询" class="headerlink" title="设置最小匹配度查询"></a>设置最小匹配度查询</h2><p>设置minimum_should_match字段，如果满足这个匹配度就会被查询出来，不多废话，看例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET test/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;:&#123;&quot;query&quot;: &quot;plumk的博客&quot;,&quot;minimum_should_match&quot;: &quot;50%&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="多字段查询"><a href="#多字段查询" class="headerlink" title="多字段查询"></a>多字段查询</h2><p>这里尝试在url和title中搜索plumk<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET test/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;plumk&quot;,</span><br><span class="line">        &quot;fields&quot;: [&quot;url&quot;, &quot;title&quot;]  </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>接下来的查询我接下来可能使用不到，但是考虑到会有同样刚入门的小白看到这篇博客，所以这里我还是从网上摘抄以下</p></blockquote><h2 id="Term查询"><a href="#Term查询" class="headerlink" title="Term查询"></a>Term查询</h2><p>这些查询主要处理数字、日期等结构化数据。如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST /schools/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;:&#123;</span><br><span class="line">      &quot;term&quot;:&#123;&quot;zip&quot;:&quot;176115&quot;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">Reponse:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   &quot;took&quot;:1, &quot;timed_out&quot;:false, &quot;_shards&quot;:&#123;&quot;total&quot;:10, &quot;successful&quot;:10, &quot;failed&quot;:0&#125;,</span><br><span class="line">   &quot;hits&quot;:&#123;</span><br><span class="line">      &quot;total&quot;:1, &quot;max_score&quot;:0.30685282, &quot;hits&quot;:[&#123;</span><br><span class="line">         &quot;_index&quot;:&quot;schools&quot;, &quot;_type&quot;:&quot;school&quot;, &quot;_id&quot;:&quot;1&quot;, &quot;_score&quot;:0.30685282,</span><br><span class="line">         &quot;_source&quot;:&#123;</span><br><span class="line">            &quot;name&quot;:&quot;Central School&quot;, &quot;description&quot;:&quot;CBSE Affiliation&quot;,</span><br><span class="line">            &quot;street&quot;:&quot;Nagan&quot;, &quot;city&quot;:&quot;paprola&quot;, &quot;state&quot;:&quot;HP&quot;, &quot;zip&quot;:&quot;176115&quot;,</span><br><span class="line">            &quot;location&quot;:[31.8955385, 76.8380405], &quot;fees&quot;:2200, </span><br><span class="line">            &quot;tags&quot;:[&quot;Senior Secondary&quot;, &quot;beautiful campus&quot;], &quot;rating&quot;:&quot;3.3&quot;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Range查询"><a href="#Range查询" class="headerlink" title="Range查询"></a>Range查询</h2><p>该查询用于查找值在值范围之间的对象。为此，我们需要使用如下运算符<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">gte:大于等于</span><br><span class="line">gt:大于</span><br><span class="line">lte:小于等于</span><br><span class="line">lt:小于</span><br><span class="line">POST /schools*/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;:&#123;</span><br><span class="line">      &quot;range&quot;:&#123;</span><br><span class="line">         &quot;rating&quot;:&#123;</span><br><span class="line">            &quot;gte&quot;:3.5</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">Response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   &quot;took&quot;:31, &quot;timed_out&quot;:false, &quot;_shards&quot;:&#123;&quot;total&quot;:10, &quot;successful&quot;:10, &quot;failed&quot;:0&#125;,</span><br><span class="line">   &quot;hits&quot;:&#123;</span><br><span class="line">      &quot;total&quot;:3, &quot;max_score&quot;:1.0, &quot;hits&quot;:[</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;_index&quot;:&quot;schools&quot;, &quot;_type&quot;:&quot;school&quot;, &quot;_id&quot;:&quot;2&quot;, &quot;_score&quot;:1.0,</span><br><span class="line">            &quot;_source&quot;:&#123;</span><br><span class="line">               &quot;name&quot;:&quot;Saint Paul School&quot;, &quot;description&quot;:&quot;ICSE Affiliation&quot;,</span><br><span class="line">               &quot;street&quot;:&quot;Dawarka&quot;, &quot;city&quot;:&quot;Delhi&quot;, &quot;state&quot;:&quot;Delhi&quot;, </span><br><span class="line">               &quot;zip&quot;:&quot;110075&quot;, &quot;location&quot;:[28.5733056, 77.0122136], &quot;fees&quot;:5000, </span><br><span class="line">               &quot;tags&quot;:[&quot;Good Faculty&quot;, &quot;Great Sports&quot;], &quot;rating&quot;:&quot;4.5&quot;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;, </span><br><span class="line">         &#123;</span><br><span class="line">            &quot;_index&quot;:&quot;schools_gov&quot;, &quot;_type&quot;:&quot;school&quot;, &quot;_id&quot;:&quot;2&quot;, &quot;_score&quot;:1.0, </span><br><span class="line">            &quot;_source&quot;:&#123;</span><br><span class="line">               &quot;name&quot;:&quot;Government School&quot;, &quot;description&quot;:&quot;State Board Affiliation&quot;,</span><br><span class="line">               &quot;street&quot;:&quot;Hinjewadi&quot;, &quot;city&quot;:&quot;Pune&quot;, &quot;state&quot;:&quot;MH&quot;, &quot;zip&quot;:&quot;411057&quot;,</span><br><span class="line">               &quot;location&quot;:[18.599752, 73.6821995] &quot;fees&quot;:500, </span><br><span class="line">               &quot;tags&quot;:[&quot;Great Sports&quot;], &quot;rating&quot;:&quot;4&quot;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;_index&quot;:&quot;schools&quot;, &quot;_type&quot;:&quot;school&quot;, &quot;_id&quot;:&quot;3&quot;, &quot;_score&quot;:1.0,</span><br><span class="line">            &quot;_source&quot;:&#123;</span><br><span class="line">               &quot;name&quot;:&quot;Crescent School&quot;, &quot;description&quot;:&quot;State Board Affiliation&quot;,</span><br><span class="line">               &quot;street&quot;:&quot;Tonk Road&quot;, &quot;city&quot;:&quot;Jaipur&quot;, &quot;state&quot;:&quot;RJ&quot;, &quot;zip&quot;:&quot;176114&quot;, </span><br><span class="line">               &quot;location&quot;:[26.8535922, 75.7923988], &quot;fees&quot;:2500,</span><br><span class="line">               &quot;tags&quot;:[&quot;Well equipped labs&quot;], &quot;rating&quot;:&quot;4.5&quot;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="复合查询"><a href="#复合查询" class="headerlink" title="复合查询"></a>复合查询</h2><p>这个比较复杂，这里也不过多赘述，可以去看这个博客</p><p>此外还有Joining查询，这个涉及到嵌套映射，就不展开讲了，还有地理查询，暂时用不到，可以去看官方文档</p><h1 id="Java操作——初始化"><a href="#Java操作——初始化" class="headerlink" title="Java操作——初始化"></a>Java操作——初始化</h1><p>maven中的pom引用如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;7.5.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;7.5.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;elasticsearch-rest-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;7.5.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;elasticsearch-rest-client-sniffer&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;7.5.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.8.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.8.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">java上的elasticsearch可以连接一个或多个主机初始化客户端，假设我本地主机在9200端口和9021都开了elasticsearch：</span><br><span class="line"></span><br><span class="line">RestHighLevelClient client = new RestHighLevelClient(</span><br><span class="line">        RestClient.builder(</span><br><span class="line">                new HttpHost(&quot;localhost&quot;, 9200, &quot;http&quot;),</span><br><span class="line">                new HttpHost(&quot;localhost&quot;, 9201, &quot;http&quot;)));</span><br><span class="line">关闭客户端：</span><br><span class="line"></span><br><span class="line">client.close();</span><br></pre></td></tr></table></figure></p><h1 id="Java-操作——文档增删改"><a href="#Java-操作——文档增删改" class="headerlink" title="Java 操作——文档增删改"></a>Java 操作——文档增删改</h1><h2 id="添加文档-1"><a href="#添加文档-1" class="headerlink" title="添加文档"></a>添加文档</h2><p>首先我们要构建数据，有四种方法，以上面的test索引库为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">直接提交json字符串，这种比较麻烦：</span><br><span class="line">IndexRequest request = new IndexRequest(&quot;test&quot;); //索引</span><br><span class="line">request.id(&quot;1&quot;); //id，此项可选，原因前面已经讲过了</span><br><span class="line">String jsonString = &quot;&#123;&quot; +</span><br><span class="line">        &quot;\&quot;url\&quot;:\&quot;rasang.site\&quot;,&quot; +</span><br><span class="line">        &quot;\&quot;title\&quot;:\&quot;rasang&apos;s blog\&quot;,&quot; +</span><br><span class="line">        &quot;\&quot;doc\&quot;:\&quot;Welcome to my blog.\&quot;&quot; +</span><br><span class="line">        &quot;&#125;&quot;;</span><br><span class="line">request.source(jsonString, XContentType.JSON); </span><br><span class="line">使用Map作为参数：</span><br><span class="line">Map&lt;String, String&gt; jsonMap = new HashMap&lt;&gt;();</span><br><span class="line">jsonMap.put(&quot;url&quot;, &quot;rasang.site&quot;);</span><br><span class="line">jsonMap.put(&quot;title&quot;, &quot;rasang&apos;s blog&quot;);</span><br><span class="line">jsonMap.put(&quot;doc&quot;, &quot;Welcome to my blog.&quot;);</span><br><span class="line">IndexRequest indexRequest = new IndexRequest(&quot;test&quot;).id(&quot;1&quot;).source(jsonMap); </span><br><span class="line">使用XConttentBuilder构建：</span><br><span class="line">XContentBuilder builder = XContentFactory.jsonBuilder();</span><br><span class="line">builder.startObject();</span><br><span class="line">&#123;</span><br><span class="line">    builder.field(&quot;url&quot;, &quot;rasang.site&quot;);</span><br><span class="line">    builder.field(&quot;title&quot;, &quot;rasang&apos;s blog&quot;);</span><br><span class="line">    builder.field(&quot;doc&quot;, &quot;Welcome to my blog.&quot;);</span><br><span class="line">&#125;</span><br><span class="line">builder.endObject();</span><br><span class="line">IndexRequest indexRequest = new IndexRequest(&quot;test&quot;)</span><br><span class="line">    .id(&quot;1&quot;).source(builder);</span><br><span class="line">使用键值构建</span><br><span class="line">IndexRequest indexRequest = new IndexRequest(&quot;test&quot;)</span><br><span class="line">    .id(&quot;1&quot;)</span><br><span class="line">    .source(&quot;url&quot;, &quot;rasang.site&quot;,</span><br><span class="line">        &quot;title&quot;, &quot;rasang&apos;s blog&quot;,</span><br><span class="line">        &quot;doc&quot;, &quot;Welcome to my blog.&quot;);</span><br><span class="line">其他可选参数：</span><br><span class="line">request.routing(&quot;routing&quot;); //路由值</span><br><span class="line">request.timeout(TimeValue.timeValueSeconds(1)); //设置超时</span><br><span class="line">request.timeout(&quot;1s&quot;); ////以字符串形式设置超时时间</span><br><span class="line">request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL); //以WriteRequest.RefreshPolicy实例形式设置刷新策略</span><br><span class="line">request.setRefreshPolicy(&quot;wait_for&quot;);//以字符串形式刷新策略                     </span><br><span class="line">request.version(2); //文档版本</span><br><span class="line">request.versionType(VersionType.EXTERNAL); //文档类型</span><br><span class="line">request.opType(DocWriteRequest.OpType.CREATE); //操作类型</span><br><span class="line">request.opType(&quot;create&quot;); //操作类型 可选create或update</span><br><span class="line">request.setPipeline(&quot;pipeline&quot;); //索引文档之前要执行的摄取管道的名称</span><br><span class="line">构建完成后发送到elasticsearch执行添加，java的执行方式有两种</span><br><span class="line"></span><br><span class="line">同步执行：</span><br><span class="line">IndexResponse indexResponse = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">同步执行在继续执行后面的代码之前会等待返回索引响应，也就是等待执行结果，可能相应失败或者超时之类的。需要捕获异常。</span><br><span class="line"></span><br><span class="line">异步执行</span><br><span class="line">client.indexAsync(request, RequestOptions.DEFAULT, listener);</span><br><span class="line">异步的方法不会阻塞并立即返回。当执行成功后，使用onResponse的方法回调操作监听器，如果失败，则使用onFailure方法回调监听器。监听器实例如下：</span><br><span class="line"></span><br><span class="line">listener = new ActionListener&lt;IndexResponse&gt;() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onResponse(IndexResponse indexResponse) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onFailure(Exception e) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><p>删除文档需要构建DeleteRequest，下面是删除一个文档的例子，同样的我们也需要文档的id：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">DeleteRequest request = new DeleteRequest(&quot;test&quot;,&quot;u7kkCG8B4ZIWSqMC3kJU&quot;);</span><br><span class="line">其他可选参数：</span><br><span class="line">request.routing(&quot;routing&quot;); //路由值</span><br><span class="line">request.timeout(TimeValue.timeValueMinutes(2)); //以TimeValue形式设置超时</span><br><span class="line">request.timeout(&quot;2m&quot;);  //以字符串形式设置超时</span><br><span class="line">request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL); //以WriteRequest.RefreshPolicy实例的形式设置刷新策略</span><br><span class="line">request.setRefreshPolicy(&quot;wait_for&quot;);  //以字符串的形式设置刷新策略            </span><br><span class="line">request.version(2); //版本</span><br><span class="line">request.versionType(VersionType.EXTERNAL); //版本类型</span><br><span class="line">同样的，删除请求也可以分同步和异步执行，和上面的创建文档相同：</span><br><span class="line"></span><br><span class="line">同步执行：</span><br><span class="line">DeleteResponse deleteResponse = client.delete(</span><br><span class="line">        request, RequestOptions.DEFAULT);</span><br><span class="line">异步执行：</span><br><span class="line">client.deleteAsync(request, RequestOptions.DEFAULT, listener);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 修改文档</span><br><span class="line">修改文档可以用脚本更新，这里我只记录用部分文档更新，因为看起来比较方便，与添加文档类似的，也有四种方式：</span><br><span class="line"></span><br><span class="line">UpdateRequest request = new UpdateRequest(&quot;test&quot;, id);</span><br><span class="line">String jsonString = &quot;&#123;&quot; +</span><br><span class="line">        &quot;\&quot;url\&quot;:\&quot;rasang.site\&quot;,&quot; +</span><br><span class="line">        &quot;\&quot;title\&quot;:\&quot;rasang&apos;s blog\&quot;&quot; +</span><br><span class="line">        &quot;\&quot;doc\&quot;:\&quot;this is rasang&apos;s blog\&quot;&quot; +</span><br><span class="line">        &quot;&#125;&quot;;</span><br><span class="line">request.doc(jsonString, XContentType.JSON);</span><br><span class="line">Map&lt;String, String&gt; jsonMap = new HashMap&lt;&gt;();</span><br><span class="line">jsonMap.put(&quot;url&quot;, &quot;rasang.site&quot;);</span><br><span class="line">jsonMap.put(&quot;title&quot;, &quot;rasang&apos;s blog&quot;);</span><br><span class="line">jsonMap.put(&quot;doc&quot;, &quot;this is rasang&apos;s blog&quot;);</span><br><span class="line">UpdateRequest request = new UpdateRequest(&quot;test&quot;, id)</span><br><span class="line">        .doc(jsonMap);</span><br><span class="line">XContentBuilder builder = XContentFactory.jsonBuilder();</span><br><span class="line">builder.startObject();</span><br><span class="line">&#123;</span><br><span class="line">    builder.field(&quot;url&quot;, &quot;rasang.site&quot;);</span><br><span class="line">    builder.field(&quot;title&quot;, &quot;rasang&apos;s blog&quot;);</span><br><span class="line">    builder.field(&quot;doc&quot;, &quot;this is rasang&apos;s blog&quot;);</span><br><span class="line">&#125;</span><br><span class="line">builder.endObject();</span><br><span class="line">UpdateRequest request = new UpdateRequest(&quot;test&quot;, id)</span><br><span class="line">        .doc(builder);</span><br><span class="line">UpdateRequest request = new UpdateRequest(&quot;test&quot;, &quot;1&quot;)</span><br><span class="line">        .doc(&quot;url&quot;, &quot;rasang.site&quot;,</span><br><span class="line">             &quot;title&quot;, &quot;rasang&apos;s blog&quot;,</span><br><span class="line">             &quot;doc&quot;, &quot;this is rasang&apos;s blog&quot;);</span><br><span class="line">可选参数：</span><br><span class="line">request.routing(&quot;routing&quot;); //路由值</span><br><span class="line">request.timeout(TimeValue.timeValueSeconds(1)); //设置超时</span><br><span class="line">request.timeout(&quot;1s&quot;); ////以字符串形式设置超时时间</span><br><span class="line">request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL); //以WriteRequest.RefreshPolicy实例形式设置刷新策略</span><br><span class="line">request.setRefreshPolicy(&quot;wait_for&quot;);//以字符串形式刷新策略  </span><br><span class="line">request.retryOnConflict(3); //如果要更新的文档在更新操作的获取和索引阶段之间被另一个操作更改，重试更新操作的次数</span><br><span class="line">request.fetchSource(true); //启用源检索，默认情况下禁用</span><br><span class="line">String[] includes = new String[]&#123;&quot;updated&quot;, &quot;r*&quot;&#125;;</span><br><span class="line">String[] excludes = Strings.EMPTY_ARRAY;</span><br><span class="line">request.fetchSource(</span><br><span class="line">        new FetchSourceContext(true, includes, excludes)); //为特定字段配置源包含</span><br><span class="line">String[] includes = Strings.EMPTY_ARRAY;</span><br><span class="line">String[] excludes = new String[]&#123;&quot;updated&quot;&#125;;</span><br><span class="line">request.fetchSource(</span><br><span class="line">        new FetchSourceContext(true, includes, excludes)); //为特定字段配置源排除</span><br><span class="line">request.setIfSeqNo(2L); //ifSeqNo</span><br><span class="line">request.setIfPrimaryTerm(1L); //ifPrimaryTerm</span><br><span class="line">request.detectNoop(false); //禁用noop检测</span><br><span class="line">request.scriptedUpsert(true); //指出无论文档是否存在，脚本都必须运行，即如果文档不存在，脚本负责创建文档。</span><br><span class="line">request.docAsUpsert(true); //指示如果部分文档尚不存在，则必须将其用作upsert文档。</span><br><span class="line">request.waitForActiveShards(2); //设置在继续更新操作之前必须活动的碎片副本数量。</span><br><span class="line">request.waitForActiveShards(ActiveShardCount.ALL); //ActiveShardCount的碎片副本数。可选值：ActiveShardCount.ALL, ActiveShardCount.ONE或者 ActiveShardCount.DEFAULT</span><br><span class="line">同步执行</span><br><span class="line">UpdateResponse updateResponse = client.update(</span><br><span class="line">        request, RequestOptions.DEFAULT);</span><br><span class="line">异步执行</span><br><span class="line">client.updateAsync(request, RequestOptions.DEFAULT, listener);</span><br></pre></td></tr></table></figure></p><h1 id="Java-操作——Bulk批量操作"><a href="#Java-操作——Bulk批量操作" class="headerlink" title="Java 操作——Bulk批量操作"></a>Java 操作——Bulk批量操作</h1><p>批量操作需要用到Bulk API，下面我将展示批量操作新建文档，删除文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">BulkRequest request = new BulkRequest();</span><br><span class="line">request.add(new DeleteRequest(&quot;test&quot;, &quot;3&quot;));</span><br><span class="line">request.add(new UpdateRequest(&quot;test&quot;, &quot;2&quot;) </span><br><span class="line">        .doc(XContentType.JSON,&quot;url&quot;, &quot;plumk.site&quot;));</span><br><span class="line">request.add(new IndexRequest(&quot;posts&quot;).id(&quot;4&quot;)  </span><br><span class="line">        .source(XContentType.JSON,&quot;field&quot;, &quot;baz&quot;));</span><br><span class="line">同步执行</span><br><span class="line">client.bulkAsync(request, RequestOptions.DEFAULT, listener); </span><br><span class="line">异步执行</span><br><span class="line">client.bulkAsync(request, RequestOptions.DEFAULT, listener); </span><br><span class="line">BulkResponse</span><br><span class="line">BulkResponse是执行返回的结果，类似于ArrayList，可以迭代所有操作结果</span><br><span class="line"></span><br><span class="line">for (BulkItemResponse e : bulkResponse) &#123; </span><br><span class="line">    DocWriteResponse itemResponse = e.getResponse();</span><br><span class="line"></span><br><span class="line">    switch (bulkItemResponse.getOpType()) &#123;</span><br><span class="line">    case INDEX:    </span><br><span class="line">    case CREATE:</span><br><span class="line">        IndexResponse indexResponse = (IndexResponse) itemResponse;</span><br><span class="line">        break;</span><br><span class="line">    case UPDATE:   </span><br><span class="line">        UpdateResponse updateResponse = (UpdateResponse) itemResponse;</span><br><span class="line">        break;</span><br><span class="line">    case DELETE: </span><br><span class="line">        DeleteResponse deleteResponse = (DeleteResponse) itemResponse;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="Java-操作——搜索文档"><a href="#Java-操作——搜索文档" class="headerlink" title="Java 操作——搜索文档"></a>Java 操作——搜索文档</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">首先我们要创建SearchRequest对象，指定test索引库</span><br><span class="line"></span><br><span class="line">SearchRequest searchRequest = new SearchRequest(&quot;test&quot;);</span><br><span class="line">可以指定多个查询文档库，如下：</span><br><span class="line"></span><br><span class="line">SearchRequest searchRequest = new SearchRequest(&quot;posts2&quot;,&quot;posts&quot;, &quot;posts2&quot;, &quot;posts1&quot;);</span><br><span class="line">又或者可以这么操作：</span><br><span class="line"></span><br><span class="line">SearchRequest searchRequest = new SearchRequest();</span><br><span class="line">searchRequest.indices(&quot;posts2&quot;,&quot;posts&quot;, &quot;posts2&quot;, &quot;posts1&quot;);</span><br><span class="line">如果你需要设置路由分片的话：</span><br><span class="line"></span><br><span class="line">searchRequest.routing(&quot;routing&quot;);</span><br><span class="line">指定优先分片查询：</span><br><span class="line"></span><br><span class="line">searchRequest.preference(&quot;_local&quot;);</span><br><span class="line">然后要添加请求的特征参数，添加特征参数我们需要用到SearchSourceBuilder对象</span><br><span class="line"></span><br><span class="line">SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br></pre></td></tr></table></figure><h2 id="设置查询的起始索引位置和数量"><a href="#设置查询的起始索引位置和数量" class="headerlink" title="设置查询的起始索引位置和数量"></a>设置查询的起始索引位置和数量</h2><p>如下表示从第1条开始，共返回5条文档数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sourceBuilder.from(0); </span><br><span class="line">sourceBuilder.size(5);</span><br></pre></td></tr></table></figure></p><h2 id="Match-all查询-1"><a href="#Match-all查询-1" class="headerlink" title="Match all查询"></a>Match all查询</h2><p><code>searchSourceBuilder.query(QueryBuilders.matchAllQuery());</code></p><h2 id="Multi-match查询"><a href="#Multi-match查询" class="headerlink" title="Multi match查询"></a>Multi match查询</h2><p>搜索doc或url中含有rasang的文档</p><p><code>QueryBuilder queryBuilder = QueryBuilders.multiMatchQuery(&quot;rasang&quot;,&quot;doc&quot;, &quot;url&quot;);</code></p><h2 id="WildcardQuery模糊查询"><a href="#WildcardQuery模糊查询" class="headerlink" title="WildcardQuery模糊查询"></a>WildcardQuery模糊查询</h2><p>?匹配单个字符，*匹配多个字符，查询doc字段含有rasang的文档</p><p><code>WildcardQueryBuilder queryBuilder = QueryBuilders.wildcardQuery(&quot;doc&quot;,&quot;*rasang*&quot;);</code></p><h2 id="关键字包含查询"><a href="#关键字包含查询" class="headerlink" title="关键字包含查询"></a>关键字包含查询</h2><p>以上查询doc字段包含blog的文档<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">searchSource.query(QueryBuilders.termQuery(&quot;doc&quot;, &quot;blog&quot;));</span><br><span class="line">// QueryBuilders输入的词条会被es解析并进行分词，在此过程中就已经转换成全小写。</span><br></pre></td></tr></table></figure></p><h2 id="matchQuery模糊查询"><a href="#matchQuery模糊查询" class="headerlink" title="matchQuery模糊查询"></a>matchQuery模糊查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(&quot;doc&quot;, &quot;rasong&quot;)</span><br><span class="line">        .fuzziness(Fuzziness.AUTO) //启用模糊查询</span><br><span class="line">        .prefixLength(3)// 在匹配查询上设置前缀长度选项</span><br><span class="line">        .maxExpansions(10);// 设置最大扩展选项以控制查询的模糊过程</span><br><span class="line">    searchSource.query(matchQueryBuilder);</span><br><span class="line">//MatchQueryBuilder输入的词条会被es解析并进行分词，在此过程中就已经转换成全小写。</span><br></pre></td></tr></table></figure><h2 id="复合查询-1"><a href="#复合查询-1" class="headerlink" title="复合查询"></a>复合查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//模糊查询</span><br><span class="line">WildcardQueryBuilder queryBuilder1 = QueryBuilders.wildcardQuery(</span><br><span class="line">            &quot;doc&quot;, &quot;*blog*&quot;);//搜索doc中含有blog的文档</span><br><span class="line">WildcardQueryBuilder queryBuilder2 = QueryBuilders.wildcardQuery(</span><br><span class="line">            &quot;url&quot;, &quot;*rasang*&quot;);//搜索url中含有rasang的文档</span><br><span class="line">BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">//doc中必须含有blog,url中必须含有rasang,相当于and</span><br><span class="line">boolQueryBuilder.must(queryBuilder1);</span><br><span class="line">boolQueryBuilder.must(queryBuilder2);</span><br></pre></td></tr></table></figure><p>还有其他复合如should，mustNot，用法类似。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;API操作——-新建或删除查询索引库&quot;&gt;&lt;a href=&quot;#API操作——-新建或删除查询索引库&quot; class=&quot;headerlink&quot; title=&quot;API操作—— 新建或删除查询索引库&quot;&gt;&lt;/a&gt;API操作—— 新建或删除查询索引库&lt;/h1&gt;&lt;h2 id=&quot;新
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Elasticsearch第二篇！</title>
    <link href="http://blog.uiste.com/2019/20190506-1.html"/>
    <id>http://blog.uiste.com/2019/20190506-1.html</id>
    <published>2019-05-06T02:18:56.000Z</published>
    <updated>2020-04-26T11:06:15.067Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol><li>官网：<code>https://www.elastic.co/cn/downloads/elasticsearch</code></li><li>下载：<code>wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.6.0-darwin-x86_64.tar.gz</code></li><li>解压：<code>tar -zxvf elasticsearch-7.5.0-darwin-x86_64.tar.gz</code></li><li>总写入量：. <code>cd elasticsearch-7.5.0</code></li><li><code>sh ./bin/elasticsearch</code></li><li>访问 <code>127.0.0.1:9200</code></li></ol><blockquote><p>依赖java环境</p></blockquote><h2 id="head插件"><a href="#head插件" class="headerlink" title="head插件"></a>head插件</h2><ol><li>下载： <code>wget https://github.com/mobz/elasticsearch-head/archive/master.zip</code></li><li>解压 <code>unzip master.zip</code></li><li><code>cd www/es/elasticsearch-head-master</code></li><li><code>npm install</code></li><li><code>npm run start</code></li><li>访问 <code>127.0.0.1:9100</code></li></ol><p>elasticsearch 配置修改<br><code>vim config/elasticsearch.yml</code><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 跨域配置</span></span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line">http.cors.allow-origin: <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群配置</span></span><br><span class="line">cluster.name: uiste</span><br><span class="line">node.name: master</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">network.host: 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一下内容是从节点配置信息</span></span><br><span class="line"><span class="comment">#cluster.name: uiste</span></span><br><span class="line"><span class="comment">#node.name: slave1</span></span><br><span class="line"><span class="comment">#network.host: 127.0.0.1</span></span><br><span class="line"><span class="comment">#http.port: 8200</span></span><br><span class="line"><span class="comment">#discovery.zen.ping.unicast.hosts: ["127.0.0.1"]</span></span><br></pre></td></tr></table></figure></p><blockquote><p>依赖node环境</p></blockquote><h2 id="索引创建"><a href="#索引创建" class="headerlink" title="索引创建"></a>索引创建</h2><p>API基本格式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://[ip]:[port]/[索引]/[类型]/[文档ID]</span><br></pre></td></tr></table></figure></p><p>请求示例：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">URL:127.0.0.1:9100/people</span><br><span class="line">METHOD: PUT</span><br><span class="line">PARAMS:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"settings"</span>: &#123;</span><br><span class="line">        <span class="string">"number_of_shards"</span>: 3,</span><br><span class="line">        <span class="string">"number_of_replicas"</span>: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"mappings"</span>: &#123;</span><br><span class="line">        <span class="string">"properties"</span>: &#123;</span><br><span class="line">            <span class="string">"name"</span>: &#123;</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"text"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"country"</span>: &#123;</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"age"</span>: &#123;</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"date"</span>: &#123;</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">                <span class="string">"format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">RESPONSE：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"acknowledged"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"shards_acknowledged"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"index"</span>: <span class="string">"people"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>异常情况执行结果出错：Root mapping definition has unsupported parameters<br>出现这个的原因是，elasticsearch7默认不在支持指定索引类型，默认索引类型是_doc，如果想改变，则配置include_type_name: true 即可(这个没有测试，官方文档说的，无论是否可行，建议不要这么做，因为elasticsearch8后就不在提供该字段)。官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html</a></p></blockquote><h2 id="索引查询"><a href="#索引查询" class="headerlink" title="索引查询"></a>索引查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">URL: 127.0.0.1:9200/people/_mapping</span><br><span class="line">METHOD: GET</span><br><span class="line">PARAMS:</span><br><span class="line">RESPONSE：</span><br><span class="line">&#123;</span><br><span class="line">    &quot;people&quot;: &#123;</span><br><span class="line">        &quot;mappings&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;age&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;country&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;date&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">                    &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;name&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;text&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="添加更新文档"><a href="#添加更新文档" class="headerlink" title="添加更新文档"></a>添加更新文档</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">URL: 127.0.0.1:9200/people/_doc/1</span><br><span class="line">METHOD:POST</span><br><span class="line">PARAMS:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;uiste&quot;,</span><br><span class="line">    &quot;country&quot;: &quot;China&quot;,</span><br><span class="line">    &quot;age&quot;: 18,</span><br><span class="line">    &quot;data&quot;: &quot;1999-01-01&quot;</span><br><span class="line">&#125;</span><br><span class="line">RESPONSE：</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;people&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;_version&quot;: 1,</span><br><span class="line">    &quot;result&quot;: &quot;created&quot;,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 2,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 0,</span><br><span class="line">    &quot;_primary_term&quot;: 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">URL:127.0.0.1:9200/people/_search</span><br><span class="line">METHOD:POST</span><br><span class="line">PARAMS:</span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;:&#123;</span><br><span class="line">      &quot;match_all&quot;:&#123;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">RESPONSE：</span><br><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 453,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 1,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 1,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;people&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;uiste&quot;,</span><br><span class="line">                    &quot;country&quot;: &quot;China&quot;,</span><br><span class="line">                    &quot;age&quot;: 18,</span><br><span class="line">                    &quot;data&quot;: &quot;1999-01-01&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>参考文档<br><a href="https://www.cnblogs.com/Rasang/p/12041729.html" target="_blank" rel="noopener">https://www.cnblogs.com/Rasang/p/12041729.html</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;官网：&lt;code&gt;https://www.elastic.co/cn/downloads/elasticsearch&lt;/code
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Elasticsearch第一篇！</title>
    <link href="http://blog.uiste.com/2019/20190505-1.html"/>
    <id>http://blog.uiste.com/2019/20190505-1.html</id>
    <published>2019-05-05T02:18:56.000Z</published>
    <updated>2020-04-26T01:05:35.689Z</updated>
    
    <content type="html"><![CDATA[<h2 id="带着问题上路——ES是如何产生的？"><a href="#带着问题上路——ES是如何产生的？" class="headerlink" title="带着问题上路——ES是如何产生的？"></a>带着问题上路——ES是如何产生的？</h2><p>（1）思考：大规模数据如何检索？<br>如：当系统数据量上了10亿、100亿条的时候，我们在做系统架构的时候通常会从以下角度去考虑问题：<br>1）用什么数据库好？(mysql、sybase、oracle、达梦、神通、mongodb、hbase…)<br>2）如何解决单点故障；(lvs、F5、A10、Zookeep、MQ)<br>3）如何保证数据安全性；(热备、冷备、异地多活)<br>4）如何解决检索难题；(数据库代理中间件：mysql-proxy、Cobar、MaxScale等;)<br>5）如何解决统计分析问题；(离线、近实时)</p><p>（2）传统数据库的应对解决方案<br>对于关系型数据，我们通常采用以下或类似架构去解决查询瓶颈和写入瓶颈：<br>解决要点：<br>1）通过主从备份解决数据安全性问题；<br>2）通过数据库代理中间件心跳监测，解决单点故障问题；<br>3）通过代理中间件将查询语句分发到各个slave节点进行查询，并汇总结果<br>这里写图片描述</p><p>（3）非关系型数据库的解决方案<br>对于Nosql数据库，以mongodb为例，其它原理类似：<br>解决要点：<br>1）通过副本备份保证数据安全性；<br>2）通过节点竞选机制解决单点问题；<br>3）先从配置库检索分片信息，然后将请求分发到各个节点，最后由路由节点合并汇总结果<br>这里写图片描述</p><h2 id="另辟蹊径——完全把数据放入内存怎么样？"><a href="#另辟蹊径——完全把数据放入内存怎么样？" class="headerlink" title="另辟蹊径——完全把数据放入内存怎么样？"></a>另辟蹊径——完全把数据放入内存怎么样？</h2><p>我们知道，完全把数据放在内存中是不可靠的，实际上也不太现实，当我们的数据达到PB级别时，按照每个节点96G内存计算，在内存完全装满的数据情况下，我们需要的机器是：1PB=1024T=1048576G<br>节点数=1048576/96=10922个<br>实际上，考虑到数据备份，节点数往往在2.5万台左右。成本巨大决定了其不现实！</p><p>从前面讨论我们了解到，把数据放在内存也好，不放在内存也好，都不能完完全全解决问题。<br>全部放在内存速度问题是解决了，但成本问题上来了。<br>为解决以上问题，从源头着手分析，通常会从以下方式来寻找方法：<br>1、存储数据时按有序存储；<br>2、将数据和索引分离；<br>3、压缩数据；<br>这就引出了Elasticsearch。</p><h2 id="ES-基础一网打尽"><a href="#ES-基础一网打尽" class="headerlink" title="ES 基础一网打尽"></a>ES 基础一网打尽</h2><p>1.1 ES定义<br>ES=elaticsearch简写， Elasticsearch是一个开源的高扩展的分布式全文检索引擎，它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理PB级别的数据。<br>Elasticsearch也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。</p><p>1.2 Lucene与ES关系？<br>1）Lucene只是一个库。想要使用它，你必须使用Java来作为开发语言并将其直接集成到你的应用中，更糟糕的是，Lucene非常复杂，你需要深入了解检索的相关知识来理解它是如何工作的。</p><p>2）Elasticsearch也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。</p><p>1.3 ES主要解决问题：<br>1）检索相关数据；<br>2）返回统计结果；<br>3）速度要快。</p><p>1.4 ES工作原理<br>当ElasticSearch的节点启动后，它会利用多播(multicast)(或者单播，如果用户更改了配置)寻找集群中的其它节点，并与之建立连接。这个过程如下图所示：<br>这里写图片描述</p><p>1.5 ES核心概念<br>1）Cluster：集群。<br>ES可以作为一个独立的单个搜索服务器。不过，为了处理大型数据集，实现容错和高可用性，ES可以运行在许多互相合作的服务器上。这些服务器的集合称为集群。</p><p>2）Node：节点。<br>形成集群的每个服务器称为节点。</p><p>3）Shard：分片。<br>当有大量的文档时，由于内存的限制、磁盘处理能力不足、无法足够快的响应客户端的请求等，一个节点可能不够。这种情况下，数据可以分为较小的分片。每个分片放到不同的服务器上。<br>当你查询的索引分布在多个分片上时，ES会把查询发送给每个相关的分片，并将结果组合在一起，而应用程序并不知道分片的存在。即：这个过程对用户来说是透明的。</p><p>4）Replia：副本。<br>为提高查询吞吐量或实现高可用性，可以使用分片副本。<br>副本是一个分片的精确复制，每个分片可以有零个或多个副本。ES中可以有许多相同的分片，其中之一被选择更改索引操作，这种特殊的分片称为主分片。<br>当主分片丢失时，如：该分片所在的数据不可用时，集群将副本提升为新的主分片。</p><p>5）全文检索。<br>全文检索就是对一篇文章进行索引，可以根据关键字搜索，类似于mysql里的like语句。<br>全文索引就是把内容根据词的意义进行分词，然后分别创建索引，例如”你们的激情是因为什么事情来的” 可能会被分词成：“你们“，”激情“，“什么事情“，”来“ 等token，这样当你搜索“你们” 或者 “激情” 都会把这句搜出来。</p><p>1.6 ES数据架构的主要概念（与关系数据库Mysql对比）<br>这里写图片描述<br>（1）关系型数据库中的数据库（DataBase），等价于ES中的索引（Index）<br>（2）一个数据库下面有N张表（Table），等价于1个索引Index下面有N多类型（Type），<br>（3）一个数据库表（Table）下的数据由多行（ROW）多列（column，属性）组成，等价于1个Type由多个文档（Document）和多Field组成。<br>（4）在一个关系型数据库里面，schema定义了表、每个表的字段，还有表和字段之间的关系。 与之对应的，在ES中：Mapping定义索引下的Type的字段处理规则，即索引如何建立、索引类型、是否保存原始索引JSON文档、是否压缩原始JSON文档、是否需要分词处理、如何进行分词处理等。<br>（5）在数据库中的增insert、删delete、改update、查search操作等价于ES中的增PUT/POST、删Delete、改_update、查GET.</p><p>1.7 ELK是什么？<br>ELK=elasticsearch+Logstash+kibana<br>elasticsearch：后台分布式存储以及全文检索<br>logstash: 日志加工、“搬运工”<br>kibana：数据可视化展示。<br>ELK架构为数据分布式存储、可视化查询和日志解析创建了一个功能强大的管理链。 三者相互配合，取长补短，共同完成分布式大数据处理工作。</p><h2 id="ES特点和优势"><a href="#ES特点和优势" class="headerlink" title="ES特点和优势"></a>ES特点和优势</h2><p>1）分布式实时文件存储，可将每一个字段存入索引，使其可以被检索到。<br>2）实时分析的分布式搜索引擎。<br>分布式：索引分拆成多个分片，每个分片可有零个或多个副本。集群中的每个数据节点都可承载一个或多个分片，并且协调和处理各种操作；<br>负载再平衡和路由在大多数情况下自动完成。<br>3）可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据。也可以运行在单台PC上（已测试）<br>4）支持插件机制，分词插件、同步插件、Hadoop插件、可视化插件等。</p><h2 id="ES性能"><a href="#ES性能" class="headerlink" title="ES性能"></a>ES性能</h2><p>3.1 性能结果展示<br>（1）硬件配置：<br>CPU 16核 AuthenticAMD<br>内存 总量：32GB<br>硬盘 总量：500GB 非SSD</p><p>（2）在上述硬件指标的基础上测试性能如下：<br>1）平均索引吞吐量： 12307docs/s（每个文档大小：40B/docs）<br>2）平均CPU使用率： 887.7%（16核，平均每核：55.48%）<br>3）构建索引大小： 3.30111 GB<br>4）总写入量： 20.2123 GB<br>5）测试总耗时： 28m 54s.</p><p>3.2 性能esrally工具（推荐）<br>使用参考：<a href="http://blog.csdn.net/laoyang360/article/details/52155481" target="_blank" rel="noopener">http://blog.csdn.net/laoyang360/article/details/52155481</a></p><h2 id="为什么要用ES？"><a href="#为什么要用ES？" class="headerlink" title="为什么要用ES？"></a>为什么要用ES？</h2><p>4.1 ES国内外使用优秀案例<br>1） 2013年初，GitHub抛弃了Solr，采取ElasticSearch 来做PB级的搜索。 “GitHub使用ElasticSearch搜索20TB的数据，包括13亿文件和1300亿行代码”。</p><p>2）维基百科：启动以elasticsearch为基础的核心搜索架构。<br>3）SoundCloud：“SoundCloud使用ElasticSearch为1.8亿用户提供即时而精准的音乐搜索服务”。<br>4）百度：百度目前广泛使用ElasticSearch作为文本数据分析，采集百度所有服务器上的各类指标数据及用户自定义数据，通过对各种数据进行多维分析展示，辅助定位分析实例异常或业务层面异常。目前覆盖百度内部20多个业务线（包括casio、云分析、网盟、预测、文库、直达号、钱包、风控等），单集群最大100台机器，200个ES节点，每天导入30TB+数据。</p><p>4.2 我们也需要<br>实际项目开发实战中，几乎每个系统都会有一个搜索的功能，当搜索做到一定程度时，维护和扩展起来难度就会慢慢变大，所以很多公司都会把搜索单独独立出一个模块，用ElasticSearch等来实现。</p><p>近年ElasticSearch发展迅猛，已经超越了其最初的纯搜索引擎的角色，现在已经增加了数据聚合分析（aggregation）和可视化的特性，如果你有数百万的文档需要通过关键词进行定位时，ElasticSearch肯定是最佳选择。当然，如果你的文档是JSON的，你也可以把ElasticSearch当作一种“NoSQL数据库”， 应用ElasticSearch数据聚合分析（aggregation）的特性，针对数据进行多维度的分析。</p><p>【知乎：热酷架构师潘飞】ES在某些场景下替代传统DB<br>个人以为Elasticsearch作为内部存储来说还是不错的，效率也基本能够满足，在某些方面替代传统DB也是可以的，前提是你的业务不对操作的事性务有特殊要求；而权限管理也不用那么细，因为ES的权限这块还不完善。<br>由于我们对ES的应用场景仅仅是在于对某段时间内的数据聚合操作，没有大量的单文档请求（比如通过userid来找到一个用户的文档，类似于NoSQL的应用场景），所以能否替代NoSQL还需要各位自己的测试。<br>如果让我选择的话，我会尝试使用ES来替代传统的NoSQL，因为它的横向扩展机制太方便了。</p><h2 id="ES的应用场景是怎样的？"><a href="#ES的应用场景是怎样的？" class="headerlink" title="ES的应用场景是怎样的？"></a>ES的应用场景是怎样的？</h2><p>通常我们面临问题有两个：<br>1）新系统开发尝试使用ES作为存储和检索服务器；<br>2）现有系统升级需要支持全文检索服务，需要使用ES。<br>以上两种架构的使用，以下链接进行详细阐述。<br><a href="http://blog.csdn.net/laoyang360/article/details/52227541" target="_blank" rel="noopener">http://blog.csdn.net/laoyang360/article/details/52227541</a></p><p>一线公司ES使用场景：<br>1）新浪ES 如何分析处理32亿条实时日志 <a href="http://dockone.io/article/505" target="_blank" rel="noopener">http://dockone.io/article/505</a><br>2）阿里ES 构建挖财自己的日志采集和分析体系 <a href="http://afoo.me/columns/tec/logging-platform-spec.html" target="_blank" rel="noopener">http://afoo.me/columns/tec/logging-platform-spec.html</a><br>3）有赞ES 业务日志处理 <a href="http://tech.youzan.com/you-zan-tong-ri-zhi-ping-tai-chu-tan/" target="_blank" rel="noopener">http://tech.youzan.com/you-zan-tong-ri-zhi-ping-tai-chu-tan/</a><br>4）ES实现站内搜索 <a href="http://www.wtoutiao.com/p/13bkqiZ.html" target="_blank" rel="noopener">http://www.wtoutiao.com/p/13bkqiZ.html</a></p><h2 id="如何部署ES？"><a href="#如何部署ES？" class="headerlink" title="如何部署ES？"></a>如何部署ES？</h2><p>6.1 ES部署（无需安装）<br>1）零配置，开箱即用<br>2）没有繁琐的安装配置<br>3）java版本要求：最低1.7<br>我使用的1.8<br>[root@laoyang config_lhy]# echo $JAVA_HOME<br>/opt/jdk1.8.0_91<br>4）下载地址：<br><a href="https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/zip/elasticsearch/2.3.5/elasticsearch-2.3.5.zip" target="_blank" rel="noopener">https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/zip/elasticsearch/2.3.5/elasticsearch-2.3.5.zip</a><br>5）启动<br>cd /usr/local/elasticsearch-2.3.5<br>./bin/elasticsearch<br>bin/elasticsearch -d(后台运行)</p><p>6.2 ES必要的插件<br>必要的Head、kibana、IK（中文分词）、graph等插件的详细安装和使用。<br><a href="http://blog.csdn.net/column/details/deep-elasticsearch.html" target="_blank" rel="noopener">http://blog.csdn.net/column/details/deep-elasticsearch.html</a></p><p>6.3 ES windows下一键安装<br>自写bat脚本实现windows下一键安装。<br>1）一键安装ES及必要插件（head、kibana、IK、logstash等）<br>2）安装后以服务形式运行ES。<br>3）比自己摸索安装节省至少2小时时间，效率非常高。<br>脚本说明：<br><a href="http://blog.csdn.net/laoyang360/article/details/51900235" target="_blank" rel="noopener">http://blog.csdn.net/laoyang360/article/details/51900235</a></p><h2 id="ES对外接口（开发人员关注）"><a href="#ES对外接口（开发人员关注）" class="headerlink" title="ES对外接口（开发人员关注）"></a>ES对外接口（开发人员关注）</h2><p>1）JAVA API接口<br><a href="http://www.ibm.com/developerworks/library/j-use-elasticsearch-java-apps/index.html" target="_blank" rel="noopener">http://www.ibm.com/developerworks/library/j-use-elasticsearch-java-apps/index.html</a></p><p>2）RESTful API接口<br>常见的增、删、改、查操作实现：<br><a href="http://blog.csdn.net/laoyang360/article/details/51931981" target="_blank" rel="noopener">http://blog.csdn.net/laoyang360/article/details/51931981</a></p><h2 id="ES遇到问题怎么办？"><a href="#ES遇到问题怎么办？" class="headerlink" title="ES遇到问题怎么办？"></a>ES遇到问题怎么办？</h2><p>1）国外：<a href="https://discuss.elastic.co/" target="_blank" rel="noopener">https://discuss.elastic.co/</a><br>2）国内：<a href="http://elasticsearch.cn/" target="_blank" rel="noopener">http://elasticsearch.cn/</a></p><p>参考：<br>[1] <a href="http://www.tuicool.com/articles/7fueUbb" target="_blank" rel="noopener">http://www.tuicool.com/articles/7fueUbb</a><br>[2] <a href="http://zhaoyanblog.com/archives/495.html" target="_blank" rel="noopener">http://zhaoyanblog.com/archives/495.html</a><br>[3]《Elasticsearch服务器开发》<br>[4]《实战Elasticsearch、Logstash、Kibana》<br>[5]《Elasticsearch In Action》<br>[6]《某ES大牛PPT》</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;带着问题上路——ES是如何产生的？&quot;&gt;&lt;a href=&quot;#带着问题上路——ES是如何产生的？&quot; class=&quot;headerlink&quot; title=&quot;带着问题上路——ES是如何产生的？&quot;&gt;&lt;/a&gt;带着问题上路——ES是如何产生的？&lt;/h2&gt;&lt;p&gt;（1）思考：大规模数
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Mac 配置ssh 免密登录</title>
    <link href="http://blog.uiste.com/2018/20181102-3.html"/>
    <id>http://blog.uiste.com/2018/20181102-3.html</id>
    <published>2018-11-02T07:49:00.000Z</published>
    <updated>2018-11-02T07:58:06.000Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 配置ssh</span><br><span class="line">~ vim ~/.ssh/config</span><br><span class="line"></span><br><span class="line">Host *</span><br><span class="line">    ServerAliveInterval 10</span><br><span class="line"></span><br><span class="line">Host Mweb1</span><br><span class="line">    HostName        服务器IP地址</span><br><span class="line">    Port            端口</span><br><span class="line">    User            用户名</span><br><span class="line">    IdentityFile    私钥地址</span><br><span class="line"></span><br><span class="line">Host Mweb2</span><br><span class="line">    HostName        服务器IP地址</span><br><span class="line">    Port            22</span><br><span class="line">    User            uiste</span><br><span class="line">    IdentityFile    ~/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"># 登录方式</span><br><span class="line">➜  ~ ssh Mweb1</span><br><span class="line">Last login: Fri Nov  2 08:15:51 2018 from 180.173.83.33</span><br><span class="line">[root@VM_0_6_centos ~]#</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Mac配置远程服务器隧道代理</title>
    <link href="http://blog.uiste.com/2018/20181102-2.html"/>
    <id>http://blog.uiste.com/2018/20181102-2.html</id>
    <published>2018-11-02T07:44:54.000Z</published>
    <updated>2018-11-03T00:13:03.740Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>因为安全原因远程服务器的数据库不允许本地直接访问，又没有开启访问IP白名单时，可以通过隧道代理访问。Windows系统通过xsheel可以设置隧道代理。Mac只需要运行如下命令</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 22  -i ~/.ssh/id_rsa -fNL 代理端口:代理IP:转发原端口 用户名@远程服务器IP</span><br><span class="line"></span><br><span class="line">ssh -p 22  -i ~/.ssh/id_rsa -fNL 3308:127.0.0.1:3306 root@118.xx.xxx.xx</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh -p &#123;ssh_port&#125; -i &#123;rsa_file&#125; -fNL &#123;local_port&#125;:&#123;mysql_ip&#125;:&#123;mysql_port&#125; </span><br><span class="line">&#123;ssh_user&#125;@&#123;ssh_ip&#125;</span><br><span class="line">ssh -p 22  -i ./id_rsa_jump -fNL 33060:mysql_ip:3306 jump@jump_ip   # 实例</span><br></pre></td></tr></table></figure><blockquote><p>-p {ssh_port}: 指定跳板机器的ssh服务的端口<br>-i {rsa_file}:指定连接跳板机的ssh公钥，由跳板机的ssh服务端生成，如果不指定公钥或者公钥验证失败则会弹出密码进行登录。<br>-f:需进行ssh认证<br>-N:只进行端口转发，不执行命令<br>-L:指定连接服务的格式 [bind_address:]port:host:hostport<br>{local_port}：本地监听的端口<br>{mysql_ip}：转发到的mysql的ip或域名<br>{mysql_port}：转发到的mysql的端口<br>{ssh_port}：跳板机的<br>{ssh_user}：跳板机的ssh用户名(如果为rsa登录，则ras对应的用户名和ssh_user一致)<br>{ssh_ip}：跳板机的ip或域名<br>检查是否启动成功<br>netstat  -aon|findstr  “33060”  #存在对应的监听则启动成功 如果要关闭则kill<br>连接mysql<br>ip:127.0.0.1<br>port:33060</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;因为安全原因远程服务器的数据库不允许本地直接访问，又没有开启访问IP白名单时，可以通过隧道代理访问。Windows系统通过xsheel可以设置隧道代理。Mac只需要运行如下命令&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;hi
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>truffle geth 启动Ethereum测试节点</title>
    <link href="http://blog.uiste.com/2018/20181102-1.html"/>
    <id>http://blog.uiste.com/2018/20181102-1.html</id>
    <published>2018-11-02T07:42:14.000Z</published>
    <updated>2018-11-02T07:58:06.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="truffle-框架使用"><a href="#truffle-框架使用" class="headerlink" title="truffle 框架使用"></a>truffle 框架使用</h1><p><strong> uiste@uiste:~$     testrpc </strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uiste@uiste:~/www/blockchain/test_truffle_2$     truffle unbox webpack</span><br><span class="line">uiste@uiste:~/www/blockchain/test_truffle_2$     truffle develop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Last login: Mon Apr  2 20:07:27 on ttys008</span><br><span class="line">uiste@uiste:~$     cd www/blockchain/test_truffle_2/</span><br><span class="line">uiste@uiste:~/www/blockchain/test_truffle_2$     npm run dev</span><br></pre></td></tr></table></figure></p><h1 id="geth-方式"><a href="#geth-方式" class="headerlink" title="geth 方式"></a>geth 方式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">`geth --datadir &quot;./Mychains/dev&quot; --identity &quot;mydev&quot; --rpccorsdomain &quot;*&quot; --networkid 99 console`</span><br><span class="line"></span><br><span class="line">uiste@uiste:~$     cd www/blockchain/test-geth</span><br><span class="line">uiste@uiste:~/www/blockchain/test-geth$     geth --datadir &quot;./Mychains/dev&quot; --identity &quot;mydev&quot; --rpc --rpcapi &quot;db,eth,net,web3,personal,web3&quot; --nodiscover --rpccorsdomain &quot;*&quot; --networkid 100 console</span><br><span class="line"></span><br><span class="line">uiste@uiste:/Applications$      /Applications/Mist.app/Contents/MacOS/Mist --rpc &quot;/Users/uiste/www/blockchain/test-geth/Mychains/dev/geth.ipc&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">geth --datadir &quot;./chain&quot; --identity &quot;mydev&quot; --rpc --rpcapi &quot;db,eth,net,web3,personal,web3&quot; --nodiscover --rpccorsdomain &quot;*&quot; --networkid 100 console 2&gt;&gt;eth_output.log</span><br><span class="line"></span><br><span class="line">geth --dev --rpc --rpccorsdomain &quot;*&quot; --rpcaddr &quot;0.0.0.0&quot; --rpcport &quot;8545&quot; --mine --rpcapi &quot;eth,txpool,web3&quot;</span><br><span class="line"></span><br><span class="line">geth --testnet --rpc --rpccorsdomain &quot;*&quot; --rpcaddr &quot;0.0.0.0&quot; --rpcport &quot;8545&quot;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;truffle-框架使用&quot;&gt;&lt;a href=&quot;#truffle-框架使用&quot; class=&quot;headerlink&quot; title=&quot;truffle 框架使用&quot;&gt;&lt;/a&gt;truffle 框架使用&lt;/h1&gt;&lt;p&gt;&lt;strong&gt; uiste@uiste:~$     te
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>composer 包</title>
    <link href="http://blog.uiste.com/2018/20180604-1.html"/>
    <id>http://blog.uiste.com/2018/20180604-1.html</id>
    <published>2018-06-04T09:10:47.000Z</published>
    <updated>2020-04-26T01:05:35.688Z</updated>
    
    <content type="html"><![CDATA[<ol><li>根据功能解释框架基础结构<br>友情提示 composer 镜像源建议用阿里云的镜像</li></ol><p><code>composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</code></p><ol start="2"><li>引入composer<br>首先打开命令行通过cmd操作；前提操作 -&gt; composer安装成功(|ू･ω･` )自个百度安装吧)</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PS D:laravel&gt; composer init</span><br><span class="line"></span><br><span class="line">  Welcome to the Composer config generator</span><br><span class="line"></span><br><span class="line">This command will guide you through creating your composer.json config.</span><br><span class="line"></span><br><span class="line">Package name (&lt;vendor&gt;/&lt;name&gt;) [administrator/laravel]: uiste/tiny-laravel</span><br><span class="line">Description []: This is a small project modeled after laravel</span><br><span class="line">Author [uiste &lt;2598352200@qq.com&gt;, n to skip]: uiste &lt;uiste@test.com&gt;</span><br><span class="line">Minimum Stability []:</span><br><span class="line">Package Type (e.g. library, project, metapackage, composer-plugin) []: library</span><br><span class="line">License []: MIT</span><br><span class="line"></span><br><span class="line">Define your dependencies.</span><br><span class="line"></span><br><span class="line">Would you like to define your dependencies (require) interactively [yes]? n</span><br><span class="line">Would you like to define your dev dependencies (require-dev) interactively [yes]? n</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;uiste/tiny-laravel&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;This is a small project modeled after laravel&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;library&quot;,</span><br><span class="line">    &quot;license&quot;: &quot;MIT&quot;,</span><br><span class="line">    &quot;authors&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;uiste&quot;,</span><br><span class="line">            &quot;email&quot;: &quot;uiste@test.com&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;minimum-stability&quot;: &quot;dev&quot;,</span><br><span class="line">    &quot;require&quot;: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">Do you confirm generation [yes]? yes</span><br></pre></td></tr></table></figure><p>对于composer init 的结果解释：</p><table><thead><tr><th>命令</th><th style="text-align:right">解释</th><th style="text-align:center">案例</th></tr></thead><tbody><tr><td>Package name</td><td style="text-align:right">项目名称</td><td style="text-align:center">uiste/tiny-laravel</td></tr><tr><td>Description</td><td style="text-align:right">项目描述(不要中文)</td><td style="text-align:center">This is a small project modeled after laravel</td></tr><tr><td>Author</td><td style="text-align:right">作者</td><td style="text-align:center">uiste <a href="mailto:uiste@test.com" target="_blank" rel="noopener">uiste@test.com</a></td></tr><tr><td>Minimum Stability</td><td style="text-align:right">稳定版本</td><td style="text-align:center">dev</td></tr><tr><td>Package Type</td><td style="text-align:right">项目类型</td><td style="text-align:center">library</td></tr><tr><td>License</td><td style="text-align:right">开源</td><td style="text-align:center">MIT</td></tr></tbody></table><p>最后两个设置为 n 就行了</p><p>然后修改一下json文件，添加小laravel的命名空间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;uiste/tiny-laravel&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;This is a small projet modeled after laravel&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;library&quot;,</span><br><span class="line">    &quot;license&quot;: &quot;MIT&quot;,</span><br><span class="line">    &quot;authors&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;uiste&quot;,</span><br><span class="line">            &quot;email&quot;: &quot;uiste@test.com&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;autoload&quot;:&#123;</span><br><span class="line">        &quot;psr-4&quot;:&#123;</span><br><span class="line">            &quot;uiste\\TinyLaravel\\&quot;:&quot;./src/&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;require&quot;: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>对应的项目目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tiny-laravel 组件目录</span><br><span class="line">├─src                   项目目录</span><br><span class="line">│  ├─Container          容器目录</span><br><span class="line">│  └─ ...               更多类库目录</span><br><span class="line">│</span><br><span class="line">├─composer.json         过</span><br><span class="line">└─README.md             README 文件</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;根据功能解释框架基础结构&lt;br&gt;友情提示 composer 镜像源建议用阿里云的镜像&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;code&gt;composer config -g repo.packagist composer https://mirrors.aliyun.co
      
    
    </summary>
    
    
  </entry>
  
</feed>
